#! /usr/bin/perl
# Procedure: nc_ph
# Last update: 25/05/2009
#############################################################################
# IGSuite 4.0.0 - Provides an Office Suite by  simple web interface         #
# Copyright (C) 2002 Dante Ortolani  [LucaS]                                #
#                                                                           #
# This program is free software; you can redistribute it and/or             #
# modify it under the terms of the GNU General Public License               #
# as published by the Free Software Foundation; either version 2            #
# of the License, or (at your option) any later version.                    #
#                                                                           #
# This program is distributed in the hope that it will be useful,           #
# but WITHOUT ANY WARRANTY; without even the implied warranty of            #
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             #
# GNU General Public License for more details.                              #
#                                                                           #
# You should have received a copy of the GNU General Public License         #
# along with this program; if not, write to the Free Software Foundation,   #
# Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.           #
#############################################################################

use strict;
use IG;
IG::MkEnv(__PACKAGE__);

IG::DTable (
		submit_nc	=> sub { CheckPrivilege('nc_ph_new') },
                submit_nc_execute       => sub { CheckPrivilege('nc_ph_new') },
                confirm_nc_list      => sub { CheckPrivilege('nc_ph_confirm') },
		confirm_nc	=> sub { CheckPrivilege('nc_ph_confirm') },
		validate_nc	=> sub { CheckPrivilege('nc_ph_validate') },
		validate_nc_list	=> sub { CheckPrivilege('nc_ph_validate') },
		fix_nc		=> sub { CheckPrivilege('nc_ph_new') },
		fix_nc_list	=> sub { CheckPrivilege('nc_ph_new') },
		delshow		=> sub { CheckPrivilege('documentation_edit') },
		delexec		=> sub { CheckPrivilege('documentation_edit') },
		findshow	=> sub { CheckPrivilege('documentation_view') },
		findexec	=> sub { CheckPrivilege('documentation_view') },
		default_action	=> sub { CheckPrivilege('nc_ph_new') });
		

############################################################################
############################################################################
sub submit_nc
 {
 
  HtmlHead();
  TaskHead(	title=>"Segnala NC",
		width=>500);

  FormHead(	cgiaction=>'submit_nc_execute',
		enctype=>"multipart/form-data");

  Input (	show=>'Id',
		type=>'text',
		name=>'id',
		value=>_mk_new_id(),
		size=>10,
		maxlen=>10);

  Input (	show=>"Autore",
		type=>'text',
		name=>'submitter',
	    	value=>$auth_user,
		size=>30,
		maxlen=>30);

  Input (	show=>"Oggetto NC",
		type=>'text',
		name=>'desc_oggetto',
		size=>50,
		maxlen=>60);
		
  Input (	show=>"Descrizione NC",
		type=>'text',
		name=>'desc_nc',
		size=>50,
		maxlen=>60);
		
  Input (	show=>"Trattamento proposto",
		type=>'text',
		name=>'desc_trattamento',
		size=>50,
		maxlen=>60);

  

  Input (	type=>'submit',
		value=>$lang{save});

  FormFoot();
  TaskFoot();
  HtmlFoot();
  1;
 
 }

sub submit_nc_execute {
  QuoteParams();
  DbQuery(query =>[( "INSERT INTO nc_ph ( id, status, desc_oggetto, desc_nc, desc_trattamento, submitter_name)".
                     "VALUES ('$in{id}', 'S1', '$in{desc_oggetto}',".
                     " '$in{desc_nc}', '$in{desc_trattamento}',".
                     "'$in{submitter}')"
			)]
);
default_action();
}
 
 
############################################################################
############################################################################
sub close_nc
 {
 
 }
 

############################################################################
############################################################################
sub default_action
 {
  my ($prece, $linea, $counter);

  DbQuery("SELECT id, desc_oggetto,submitter_date FROM nc_ph ".
	  "where status='S5' ".
	  "ORDER BY id");

  Header();

  TaskListMenu (
	["ID"],
	["Desc oggetto"],
	[$lang{date}],
		 );

  while (my @row = FetchRow())
   {
    ++$counter;
    my $row = $row[0];
       $row =~ s/\d//g;
    $linea  = $prece ne $row && $counter ne 0 ? '<hr>' : '';
    $prece  = $row;

    TaskListItem (
	["$linea  $row[0]"],
	["$linea $row[1]","","align=center"],
	["$linea $row[2]","","align=center"],
		 );
   }

  TaskListFoot();
  Footer();
 }

############################################################################
# Capo reparto - Visualizza NC segnalate e le approva
############################################################################
sub confirm_nc_list
{
  my ($prece, $linea, $counter);

  DbQuery("SELECT id, desc_oggetto, submitter_name, submitter_date FROM nc_ph ".
	  "where status='S1' ".
	  "ORDER BY id");

  Header();

  TaskListMenu (
	["ID"],
	["Oggetto"],
	["Persona"],
	["Quando"],
	["Azioni"],
		 );

  while (my @row = FetchRow())
   {
    ++$counter;
    my $row = $row[0];
       $row =~ s/\d//g;
    $linea  = $prece ne $row && $counter ne 0 ? '<hr>' : '';
    $prece  = $row;

    TaskListItem (
	["$linea $row[0]"],
	["$linea $row[1]","","align=center"],
	["$linea $row[2]","","align=center"],
	["$linea $row[3]"],
	["Approva","nc_ph?action=confirm_nc&amp;id=$row[0]"],
		 );
   }

  TaskListFoot();
  Footer();
}

sub confirm_nc
{
## TODO check privilege

  QuoteParams();
  DbQuery("update nc_ph set status = 'S2' ".
          "where id='$in{id}' and status = 'S1'");
confirm_nc_list();
}
#############################################################################
# Supervisore - Vede NC confermate dai capireparto e le valida
#############################################################################
sub validate_nc_list
{
  my ($prece, $linea, $counter);

  DbQuery("SELECT id, desc_oggetto, submitter_name, submitter_date, status FROM nc_ph ".
	  "where status='S2' OR status='S4' ".
	  "ORDER BY id");

  Header();

  TaskListMenu (
	["ID"],
	["Oggetto"],
	["Persona"],
	["Quando"],
	["Azioni"],
		 );

  while (my @row = FetchRow())
   {
    ++$counter;
    my $row = $row[0];
       $row =~ s/\d//g;
    $linea  = $prece ne $row && $counter ne 0 ? '<hr>' : '';
    $prece  = $row;

    TaskListItem (
	["$linea $row[0]"],
	["$linea $row[1]","","align=center"],
	["$linea $row[2]","","align=center"],
	["$linea $row[3]"],
	["Approva","nc_ph?action=validate_nc&amp;id=$row[0]&amp;status=$row[4]"],
		 );
   }

  TaskListFoot();
  Footer();
}

sub validate_nc
{
## TODO check privilege

  QuoteParams();
  if ($in{status} eq 'S2'){
  DbQuery("update nc_ph set status = 'S3' ".
          "where id='$in{id}' and status = 'S2'");
}
  else {
  DbQuery("update nc_ph set status = 'S5' ".
          "where id='$in{id}' and status = 'S4'");
}
validate_nc_list();
}

############################################################################
# Tecnico - Ripara e chiude le NC
############################################################################
sub fix_nc_list
{
  my ($prece, $linea, $counter);

  DbQuery("SELECT id, desc_oggetto, submitter_name, submitter_date FROM nc_ph ".
	  "where status='S3' ".
	  "ORDER BY id");

  Header();

  TaskListMenu (
	["ID"],
	["Oggetto"],
	["Persona"],
	["Quando"],
	["Azioni"],
		 );

  while (my @row = FetchRow())
   {
    ++$counter;
    my $row = $row[0];
       $row =~ s/\d//g;
    $linea  = $prece ne $row && $counter ne 0 ? '<hr>' : '';
    $prece  = $row;

    TaskListItem (
	["$linea $row[0]"],
	["$linea $row[1]","","align=center"],
	["$linea $row[2]","","align=center"],
	["$linea $row[3]"],
	["Approva","nc_ph?action=fix_nc&amp;id=$row[0]"],
		 );
   }

  TaskListFoot();
  Footer();
}

sub fix_nc
{
## TODO check privilege

  QuoteParams();
  DbQuery("update nc_ph set status = 'S4' ".
          "where id='$in{id}' and status = 'S3'");
fix_nc_list();
}
###############################################################################
###############################################################################
sub findshow
 {
  HtmlHead();
  if ($auth_user ne 'guest')
   {
    HLayer
     ( bottom_space => 0,
       right_layers
        =>[(
	    FormHead (	name	   => 'findnavi',
			method	   => 'get',
			autofocus  => 'false',
                        labelstyle => 'border:0px; width:auto;',
			target	   => 'mainf',
			cgiaction  => 'findexec',
			float	   => 'left' ),

	    Input (	type       => 'findable' ),

	    Input (	type       => 'select',
			name       => 'method',
			data       => [(
				        			['id',    $lang{with_protocol}],
							        ['description', $lang{with_description}],
							        ['quality_system', $lang{with_quality_system}],
						        )]
						 ),

	    Input (	type       => 'text',
			name       => 'keytofind',
                        focus      => 'true',
			value      => $IG::cookie{lastsearch},
                        style      => 'width:100px; margin-right: -5px;',
	        	onblur     => "document.cookie='lastsearch=' + escape(this.value)"),

	    Input (	type       => 'image',
			name       => $lang{find},
			src        => "$IG::img_url/${IG::tema}search.gif",
			alt        => $lang{find}),
			
	    FormFoot()
	  )]
	 );
   }
  HtmlFoot();
 }

############################################################################
############################################################################
sub findexec
 {
  my $query;
  $IG::set_cookie{lastsearch} = $on{keytofind};

  Header();

  TaskMsg("$lang{documentation_protocol} - ".
          "$lang{find}: <strong>$on{keytofind}</strong>",4);

  ## Build Query
  QuoteParams();
  if ( length($on{keytofind}) < 2 )
   {
    push @IG::errmsg, $lang{Err_find};
    $query = '1=0';
   }
  elsif ($on{method} eq 'id' || $on{keytofind} =~ /4\d\d\d\d\d\.\d\d/)
   { $query = "documentation.id ~* '$in{keytofind}'"; }
  elsif ($on{method} eq 'description')
   { $query = "documentation.description ~* '$in{keytofind}'"; }
  elsif ($on{method} eq 'quality_system')
   { $query = "documentation.quality_system ~* '$in{keytofind}'"; }
 

  my $counter = 0;
  TaskListMenu
   (
    [$lang{code}],
    [$lang{issue}],
    [$lang{revision}],
    [$lang{description}],
    [$lang{function}],
    [$lang{pages}],
    [$lang{date}],
    [$lang{quality_system}],
   );

  DbQuery( "SELECT id, issueid, revisionid, description, function, pages, issue, quality_system ".
           "FROM documentation ".
           "WHERE publishstatus='S' and approvalstatus ='A' and $query ".
           "ORDER BY issueid desc, id desc" );

  while ( my @row = FetchRow() )
   {
    ++$counter;
    TaskListItem( [ _idToLink("$row[0]_$row[1]_$row[2]") ],
                  [ $row[1] ],
                  [ $row[2] ],
                  [$row[3],"documentation?action=protomodi&amp;id=$row[0]&amp;issueid=$row[1]&amp;revisionid=$row[2]"],
                  [ $row[4] ], 
                  [ $row[5] ],
                  [ $row[6] ],
                  [ $row[7] ],
                  );
   }
  push @IG::errmsg, $lang{no_items} if !$counter && length($on{keytofind}) > 1;

  TaskListFoot();
  Footer();
 }
 
###########################################################################
###########################################################################
sub _idToLink
 {
  my $protocol = shift;
  my $file_name;

  chdir ("$IG::htdocs_dir/$IG::default_lang{documentation}/");
  my ($id) = (<$protocol.*>);

  $protocol =~ s/^([^_]+).+/$1/;

  if ( $id && CheckPrivilege('documentation_view') )
   {
    my $href = IG::GetHref('documentation', $id);

    return "<a href=\"$href\" target=\"".
	   ( $href =~ /\.html*$/i
		   ? "_blank"
		   : "mainf" ).
	   "\">$protocol<\/a>";
   }
  else
   { return $protocol }
 }

#############################################################################
#############################################################################
sub Footer
 {
  TaskFoot();
  HtmlFoot();
 }


sub Header 
 {
  HtmlHead();
  TaskHead( title => "Gestione Non Conformit&agrave;" );
  HLayer(
	  MkButton( text => "Segnala NC",
	            link => "nc_ph?action=submit_nc",
	            privilege => CheckPrivilege("nc_ph_new") ),
	            
	  MkButton( text => "Conferma NC",
	            link => "nc_ph?action=confirm_nc_list",
	            privilege => CheckPrivilege("nc_ph_confirm") ),
	            
	  MkButton( text => "Valida NC",
	            link => "nc_ph?action=validate_nc_list",
                privilege => CheckPrivilege("nc_ph_validate") ),
                    
	  MkButton( text => "Risolvi NC",
	            link => "nc_ph?action=fix_nc_list",
                    privilege => CheckPrivilege("nc_ph_new") ),
	);
 }

################################################################################
################################################################################
sub _mk_new_id
 {
  my $conn = DbQuery( query => $IG::db_driver eq 'sqlite'
                            ?  "SELECT MAX(id) FROM nc_ph"
                            :  "SELECT MAX(lpad(id,10,'0')) ".
                               "FROM nc_ph",
                      type  => 'UNNESTED' );

  my $new_id = FetchRow( $conn );
  $new_id = 0 if $new_id < 1;
  $new_id +=1; ## increase id && delete 00000
  return $new_id;
 }
