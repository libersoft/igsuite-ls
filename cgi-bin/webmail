#! /usr/bin/perl
# Procedure: webmail
# Last update: 25/05/2009
#############################################################################
# IGSuite 4.0.0 - Provides an Office Suite by  simple web interface         #
# Copyright (C) 2002 Dante Ortolani  [LucaS]                                #
#                                                                           #
# This program is free software; you can redistribute it and/or             #
# modify it under the terms of the GNU General Public License               #
# as published by the Free Software Foundation; either version 2            #
# of the License, or (at your option) any later version.                    #
#                                                                           #
# This program is distributed in the hope that it will be useful,           #
# but WITHOUT ANY WARRANTY; without even the implied warranty of            #
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             #
# GNU General Public License for more details.                              #
#                                                                           #
# You should have received a copy of the GNU General Public License         #
# along with this program; if not, write to the Free Software Foundation,   #
# Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.           #
#############################################################################

## defines acceptable command line options
BEGIN
 {
  sub setargv
   {
    return (	'to:s'		=> \$IG::on{to},
		'action:s'	=> \$IG::on{action},
		'auth_user:s'	=> \$IG::auth_user,
		'subject:s'	=> \$IG::on{subject},
		'body:s'	=> \$IG::on{body},
		'pop3login:s'	=> \$IG::pop3_conf{login},
		'pop3pwd:s'	=> \$IG::pop3_conf{pwd},
		'pop3host:s'	=> \$IG::pop3_conf{host},
		'pop3port:s'	=> \$IG::pop3_conf{port},
		'pop3auth:s'	=> \$IG::pop3_conf{auth},
		'pop3debug:s'	=> \$IG::pop3_conf{debug},
		'smtphost:s'	=> \$IG::smtp_conf{host},
		'smtpport:s'	=> \$IG::smtp_conf{port},
		'smtpdebug:s'	=> \$IG::smtp_conf{debug},
	 ); 
   }
 }

use strict;

use IG;
use IG::WebMail;
use IG::MailPOP3Client;
use IG::MimeBase64;
use IG::MimeWords;
use IG::QuotedPrint;

IG::MkEnv(__PACKAGE__);


## Set some default options
$IG::mailspooldir  ||= '/var/spool/mail';
$on{order}	   ||= 'issue';
$on{sortdirection} ||= 'desc';

## Set valid email folders
my %folderinfo;
my $folder;
my $escapedfolder;

## Only an IG user can access to IGWebmail
checkfolders() if CheckPrivilege();

## Dispatch Table
IG::DTable(	ckmessages        => sub { CheckPrivilege() },
		readmessage	  => sub { CheckPrivilege('webmail_view')  },
		docview	          => sub { CheckPrivilege('webmail_view')  },
                setsharemode      => sub { CheckPrivilege('webmail_edit')  },
		emptytrash	  => sub { CheckPrivilege('webmail_edit')  },
		displayheaders	  => sub { CheckPrivilege('webmail_view')  },
		ajax_headers	  => sub { CheckPrivilege('webmail_view')  },
		getnewmessages	  => sub { CheckPrivilege('webmail_view')  },
		viewattachment	  => sub { CheckPrivilege('webmail_view')  },
		archiveattach	  => sub { CheckPrivilege('webmail_view')  },
		composemessage	  => sub { CheckPrivilege('webmail_new')   },
		sendmessage	  => sub { CheckPrivilege('webmail_new')   },
		messageaction	  => sub { CheckPrivilege('webmail_edit')  },
		addtag		  => sub { CheckPrivilege('webmail_edit')  },
		deltag		  => sub { CheckPrivilege('webmail_edit')  },
		sendigbox	  => sub { CheckPrivilege('webmail_new')   },
		sendigdoc	  => sub { CheckPrivilege('webmail_new')   },
		sendprintview	  => sub { CheckPrivilege('webmail_new')   },
		addressbook	  => sub { CheckPrivilege('webmail_view')  },
		editfolders	  => sub { CheckPrivilege('webmail_extra') },
		addfolder	  => sub { CheckPrivilege('webmail_extra') },
		deletefolder	  => sub { CheckPrivilege('webmail_extra') },
		exportmessages	  => sub { CheckPrivilege('webmail_view')  },
		importaction	  => sub { CheckPrivilege('webmail_extra') },
		importmessages	  => sub { CheckPrivilege('webmail_extra') },
		importmessagesagg => sub { CheckPrivilege('webmail_extra') },
		setcontact	  => sub { CheckPrivilege('webmail_edit')  },
		addtocontact	  => sub { CheckPrivilege('webmail_edit')  },
		setcontactagg	  => sub { CheckPrivilege('webmail_edit')  },
		editfilter	  => sub { CheckPrivilege('webmail_extra') },
		deletefilter	  => sub { CheckPrivilege('webmail_extra') },
		openfilter	  => sub { CheckPrivilege('webmail_extra') },
		mkfilter	  => sub { CheckPrivilege('webmail_extra') },
		progresstask	  => sub { CheckPrivilege('webmail_view')  },
		findshow	  => sub { CheckPrivilege('webmail_view')  },
		findexec	  => sub { CheckPrivilege('webmail_view')  },
		moveinfolder	  => sub { CheckPrivilege('webmail_view')  },
		autocompletion	  => sub { CheckPrivilege('webmail_view')  },
		autocompletetags  => sub { CheckPrivilege('webmail_view')  },
		default_action	  => sub { CheckPrivilege('webmail_view')  },
		help              => 1 );

############################################################################
############################################################################
sub getnewmessages { progresstask() }
sub progresstask
 {
  require IG::Utils;
  my ( $status, $progress );
  $IG::clr{bg} = $IG::clr{bg_task};

  if ($on{action} eq 'getnewmessages')
   {
    if (   $IG::OS eq 'WINDOWS'
	|| $IG::screen_size =~ /^noframe/
	|| $HTTP::Server::Simple::VERSION
	|| IG::ConfigParam('webmail.keep_messages')
       )
     {
      ckmessages();
      IG::Redirect("webmail?action=progresstask");
      return;
     }
    else
     { 
      IG::Redirect("webmail?action=progresstask");
      $| = 1; # flush output
      $SIG{CHLD} = $IG::_IS_MOD_PERL ? 'IGNORE' : sub { wait };

      IG::FileUnlink("$IG::user_dir${S}mail_progress")
       or die("Can't delete file '$IG::user_dir${S}mail_progress'.\n");

      defined (my $pid = fork) or die "Cannot fork: $!\n";
      if ( $pid )  
       {
        ## We are the parent
       if ( ! $IG::_IS_MOD_PERL )
        {
         close (STDOUT);
         close (STDIN);
         close (STDERR);
         waitpid $pid, 0;
        }
       }
      else
       {
        ## We're the child
        if ( $IG::_IS_MOD_PERL )
         {
          ## untie the socket
          APR::Pool::cleanup_for_exec();
          chdir '/' or die "Can't chdir to /: $!";

          close (STDOUT);
          close (STDIN);
          close (STDERR);
 
          IG::SysExec( command   => IG::GetShebang(),
                       stdout    => 'active',
                       arguments => [( "-I$IG::cgi_dir",
                                       "$IG::cgi_dir${S}webmail",
                                       "-action=ckmessages",
                                       "-auth_user=$auth_user" )] );
          CORE::exit();
         }
        else
         {
          close (STDOUT);
          close (STDIN);
          close (STDERR);
 
          ckmessages(); 
         }
       }
     }
   }
  else
   {
    ## progress task bar (we want to be sure that webmail has created
    ## mail_progress file otherwise )
    my $progress_fh;
    for ( 1 .. 62 )
     {
      $progress_fh = open (FH, '<', "$IG::user_dir${S}mail_progress") ? 1 : 0;
      $progress_fh ? last : sleep(1);
     }
    
    if ( $progress_fh ) 
     {
      ($progress, $status) = (<FH>);
      close(FH);
      $progress &&= $progress . Br(2);

      if ($status==1 || $status==2 || !$progress)
       {
        $progress ||= $on{progress};
        $progress =~ /(\d+)\/(\d+)/;
        my $_sub = $1 || 1;
        my $_tot = $2 || 1;
        my $perc = int($_sub * 100/ $_tot);

        HtmlHead(	expire=>"1; URL=webmail?action=progresstask".
                                "&amp;progress=".MkUrl($progress),
			title=>"IGWebMail - $perc %");

        $progress .= HLayer( "<div style=\"width:40px\">$perc %</div>",
			     IG::StatusBar(	width	=> 150,
						height	=> 20,
						color	=> '#ff3300',
						perc	=> $perc),
			     Img( src   => "$IG::img_url/progress.gif",
			          width => 16 )
                           ) if $status==2;
       }
      else
       {
	HtmlHead( onevent => !$status
	                  ?  "onload=\"setTimeout('document.ckemail.submit();".
			     "self.close();',4000);\""
                          :  '' );

	IG::FileUnlink("$IG::user_dir${S}mail_progress")
          or die("Can't delete file '$IG::user_dir${S}mail_progress'.\n");

	$progress .= FormHead(	target   => 'mainf',
				name     => 'ckemail',
				cgiaction=> 'displayheaders',).
				
		     Input (	type     => 'hidden',
		                name     => 'recheck',
		                value    => 1).
		                
		     Input (	show     => $lang{continue},
				type     => 'submit',
                                style    => 'margin-top:15px',
				onclick  => "setTimeout('self.close()',500);",
				value    => 'Ok').
				
                     Input (    show     => $lang{close},
                                type     => 'button',
                                float    => 'right',
                                style    => 'margin-top:15px',
                                onclick  => 'self.close()' ).
				
		     FormFoot();
       }
     }
    else
     {
      HtmlHead(	onevent => "onload=\"setTimeout('self.close()',5000);\"" );
      $progress = "<br>Connection timeout. ".
                  "Can't retrieve messages!<br><br><hr>";
     }

    TaskMsg("<h3>IGWebMail</h3>$progress<br>",4,'100%','100%');
    HtmlFoot();
   }
 }

################################################################################
################################################################################
sub addtocontact
 {
  QuoteParams();

  ## Find Email sender and protocol id
  DbQuery("select sender, pid from email_msgs ".
	  "where id='$in{message_id}' and owner='$auth_user'");
  my ($sender, $pid) = FetchRow();

  ## Strip address and name of sender
  my ($name, $address) = IG::WebMail::ParseAddress($sender);

  ## Look if the address already exists
  if ( $on{contactid} )
   {
    DbQuery("select contactid, contactname from contacts ".
            "where (contactid = '$in{contactid}' or master='$in{contactid}') ".
		"and contacttype <> 8 ".
		"and email ~* '$address'");
   }
  else
   {
    DbQuery("select contactid, contactname from contacts ".
            "where contacttype <> 8 and email ~* '$address'");
   }  

  my ($contactid, $contactname) = FetchRow();

  if ( $contactid )
   {
    ## This address Already exists in contacts
    HtmlHead();
    TaskHead(title=>'IGWebMail', icon=>2);
    TaskMsg("<strong>$address</strong>".
	    "<br>$lang{address_already_exist}<br>".
	    "<a href=\"contacts?action=showrecord&amp;contactid=$contactid\">".
	    "$contactid</a> $contactname");
    TaskFoot();
    HtmlFoot();
   }
  else
   {
    ## Let's go to insert it
    $address = MkUrl($address);
    $name    = MkUrl($name);

    if ( $on{contactid} )
     {
      IG::Redirect("contacts?".
			"action=protosub&amp;".
			"backtoreferer=".IG::MkUrl($on{backtoreferer}).'&amp;'.
			"master=$on{contactid}&amp;".
			"contactname=$name&amp;".
			"email=$address" );
     }
    else
     {
      IG::Redirect("contacts?".
			"action=proto&amp;".
			"backtoreferer=".IG::MkUrl($on{backtoreferer}).'&amp;'.
			"contactname=$name&amp;".
			"email=$address" );
     }
   }
 }

################################################################################
################################################################################
sub autocompletion
 {
  HttpHead( expires => 'now' );

  # testing param length to avoid too many queries while user is typing
  my $min_length = 4;

  # CAUTION: min length must be <= to 'minChars' param passed to
  #          Ajax.autocompleter otherwise no matching will be displayed
  return if length($on{searchfor}) < $min_length;

  # prepare SQL to retrieve email contacts
  my $sql = "select contacts.contactname, contacts.master, contacts.email "
          . "from contacts "
          . "left join contacts as masterCnt"
          . " on masterCnt.contactid = contacts.master "
          . "where ( contacts.contactname ~* '".DbQuote($on{searchfor})."' "
          . "        or contacts.email ~* '".DbQuote($on{searchfor})."')"
          . " and contacts.email is not null"
          . " and contacts.email <> '' "
          ## private contact filter
          . " and (contacts.contacttype<>8 or contacts.owner='$auth_user')"
          . " and (masterCnt.contactid is null or masterCnt.contacttype<>8"
          . "      or masterCnt.owner='$auth_user') "
          . "order by contacts.contactname asc "
          . "limit 15";

  my $start = 0;

  DbQuery($sql);
  while (my ($contactname, $contactmaster, $contactemail) = FetchRow() )
   {
    if (!$start)
     {
      # initializing unordered list
      PrOut(qq(<ul>));
      $start = 1;
     }

    # adding list item
    PrOut("<li>\"$contactname\" &lt;$contactemail&gt;, </li>");
   }

  # close list
  PrOut(qq(</ul>)) if ($start);
  1;
 }

################################################################################
################################################################################
sub autocompletetags
 {
  HttpHead( expires => 'now' );

  # testing param length to avoid too many queries while user is typing
  my $min_length = 3;

  # CAUTION: min length must be <= to 'minChars' param passed to
  #          Ajax.autocompleter otherwise no matching will be displayed
  return if length($on{searchfor}) < $min_length;

  my $start = 0;
  for ( @{IG::WebMail::GetTags()} )
   {
    next unless /$on{searchfor}/i;
    if (!$start)
     {
      # initializing unordered list
      PrOut(qq(<ul>));
      $start = 1;
     }
    # adding list item
    PrOut("<li>$_ </li>");
   }    
     
  $start = 0;

  # close list
  PrOut(qq(</ul>)) if ($start);
  1;
 }

################################################################################
################################################################################
sub mkfilter
 {
  my $Q = DbQuote("'");
  $on{hm} ||= 1;
  $on{id} ||= MkId();

  my ($empty_values, %validfolders, $query, $action,
      @list_menu,    @list_item,    $html );
  my @when_apply = ('','INBOX','SENT');

  my %fields = (
	sender=>	$lang{sender},
	receiver=>	$lang{receiver},
	subject=>	$lang{subject},
	issue=>  	$lang{date},
	body=>  	$lang{message},
	size=>		$lang{size}
		 );

  my %methods = (
	"="=>		$lang{equal_to},
	"<>"=>		$lang{different_from},
	"~*"=>		"Match regex",
	"!~*"=>		"Dont match regex",
	">"=>		$lang{greater},
	"<"=>		$lang{inferior},
	"like"=>        $lang{contain},
	"not like"=>    $lang{does_not_contain}
		);

  ## delete last inserted or remake
  if    ( $on{undo} )          { $on{hm} -= 2;   }
  elsif ( $on{delall} )        { $on{hm}  = '0'; }
  elsif (   !$on{addfield}
         || !$on{"f$on{hm}"} ) { $on{hm} -= 1;   }

  ## build the query
  if ( $on{hm} > 0 )
   {
    my $field_name;
    my $field_value;
    $on{logica} ||= 'and';

    for ( 1 .. $on{hm} )
     {
      $field_name = $on{"f$_"};
      die 'Invalid field_name' unless $fields{$field_name}; ## for db security
      $field_value = DbQuote($on{"$field_name$_"});

      $empty_values++ if !$field_value;

      $on{"m$_"} ||= 'like';
      my $op = $on{"m$_"}; ## $on{"m$_"} will be kept for form field, $op could be changed
      my $not = 0; ## to negate the expression in query
      if ( $on{"m$_"} =~ /^(\!)?(\~\*)$/ )
       {
        if ( $1 ) 
	 {
          $not = 1; ## negate the regexp match 
	  $op = $2;
	 }
	
	## test the regexp
        my $reToTest = $field_value;
           $reToTest =~ s/[\/\@\$\%]/\\\//g;
	eval ("qr/$reToTest/");
	push @IG::errmsg, "Invalid regex: $@" if $@;
       }

      $field_value = DbQuote( $field_value );

      if ( $field_name eq 'issue' )
       {
        if ( $op eq '~*' )
	 {
          $on{"m$_"} = $op = ($not ? '<>' : '=');
	  $not = 0;
	 }
        $on{"$field_name$_"} = $field_value = CkDate($field_value);
       }

      $field_value = $op =~ /^(not )?like$/
                   ? "${Q}%$field_value%${Q}"
		   : "${Q}$field_value${Q}";
      
      $query .= $not
                ? "not ($field_name $op $field_value) $on{logica} "
		: "$field_name $op $field_value $on{logica} ";
     }

    $query =~ s/(.+)(and|or) $/owner=${Q}$auth_user${Q} and \($1\)/;
    $query = "folder=${Q}$when_apply[$on{when_apply}]${Q} and " . $query;

    $action = $on{filter_action} == 1 && $on{destination_folder}
            ? "update email_msgs ".
              "set folder=${Q}$on{destination_folder}${Q}"

	    : $on{filter_action} == 2 && $on{destination_folder}
	    ? "update email_msgs ".
	      "set status=${Q}r${Q}, folder=${Q}$on{destination_folder}${Q}"

	    : '';
   }

  ## Check errors
  if ( $on{hm} < 1 )
   {
    push @IG::errmsg, $lang{add_fields_to_filter};
   }
  elsif ( $empty_values )
   {
    push @IG::errmsg, $lang{Err_empty_fields};
   }
  elsif ( !$on{filter_action} && !$on{replymsg} )
   {
    push @IG::errmsg, $lang{Err_noaction};
    $lang{actions} = Blush( $lang{actions} );
   }
  elsif ( $on{filter_action} && !$on{destination_folder} )
   {
    push @IG::errmsg, $lang{Err_nodestination};
   }

  ## edit query
  if (!$on{elabora} || @IG::errmsg)
   {
    HtmlHead();
    TaskHead(   minwidth=>600,
                title=>$lang{filter} );

    FormHead(	method=>'get',
		cgiaction=>'mkfilter',
		float=>'left',
		labelstyle=>'width: 200px',
		name=>'mkfilter');

    Input (	type=>'hidden',
		name=>'id');

    Input (	type=>'hidden',
		name=>'hm',
		override=>1,
		value=>++$on{hm} );

    $html  = Input (	name=>"f$on{hm}",
			show=>$lang{field_to_filter},
			zerovalue => 'true',
			data=>\%fields,
			style=>'width:200px',
			type=>'select');

    $html .= Input (	show=>$lang{delete_last},
			type=>'submit',
			float=>'right',
			name=>'undo') if $on{hm}>1;

    $html .= Input (	show=>$lang{add},
			type=>'submit',
			float=>'right',
			name=>'addfield'); 

    TaskMsg($html,4);

    Input (	type=>'label',
		labelstyle=>	'margin-top: 10px; '.
				'width: auto; '.
				'border:0px; '.
				'background-color:transparent; '.
				'font-weight: bold',
		float=>'none',
		show=>$lang{search_logic} );

    Input (	name=>'logica',
		show=>$lang{search_logic_action},
		float=>'none',
		type=>'select',
		data=>{ 'and' => $lang{criteria_and},
		        'or'  => $lang{criteria_or} } );

    Input (	type=>'label',
		labelstyle=>	'margin-top: 10px;'.
				'width: auto;'.
				'border:0px; '.
				'background-color:transparent;'.
				'font-weight: bold',
		float=>'none',
		show=>$lang{search_criteria} );

    Input (	type=>'label',
		show=>$lang{criteria},
		data=>Blush($lang{add_fields_to_filter}),
		float=>'none') if $on{hm}<2;

    Input (	name=>"f$_",
		type=>'hidden') for 1..($on{hm}-1);

    for ( 1 .. ($on{hm}-1) )
     {
      Input (	name  => "m$_",
		value => '~*',
		style => 'width:150px',
		labelstyle=> $on{$on{"f$_"}.$_}
		           ? 'width:200px;'
		           : 'width:200px; color:red;',
		show  => $fields{$on{"f$_"}},
		type  => 'select',
		float => 'none',
		data  => \%methods );

      Input (	name  => $on{"f$_"} . $_,
		type  => 'text',
		style => 'width:250px' );
     }

    Input (	type=>'label',
		labelstyle=>	'margin-top: 10px;'.
				'width: auto;'.
				'border:0px; '.
				'background-color:transparent;'.
				'font-weight: bold',
		float=>'none',
		show=>$lang{actions});

    Input (	type=>'select',
		show=>$lang{filter_apply_opt},
		name=>'when_apply',
		value=>1,
		float=>'none',
		data=>[([1,$lang{filter_in}],
                        [2,$lang{filter_out}])] );

    Input (	name=>'filter_action',
		show=>$lang{move},
		float=>'none',
		zerovalue=>'true',
		type=>'select',
		style=>'width:300px',
		data=>[([1, $lang{filter_move}],
			[2, $lang{filter_move_n_sign}])] );

    ## Translate folders name
    for (grep !/INBOX|SENT|DRAFT/, keys %folderinfo)
     { $validfolders{$_} = $folderinfo{$_}{name}; }

    Input (	name=>'destination_folder',
		data=>\%validfolders,
		zerovalue=>'true',
		style=>'width:130px',
		type=>'select');

    Input (	type=>'textarea',
		name=>'replymsg',
		float=>'none',
		style=>'width:430px; height:100px',
		show=>$lang{reply_this_message});

    Input (	show=>$lang{filter_save},
		name=>'elabora',
		float=>'none',
		style=>'margin-top: 20px',
		type=>'submit') if $on{hm}>1;

    Input (	type=>'submit',
		name=>'delall',
		style=>'margin-top: 20px',
		show=>$lang{filter_cancel}) if $on{hm}>1;

    Input (	show=>$lang{abort},
		name=>'abort',
		onclick=>"window.location = 'webmail?".
						"action=editfilter&amp;".
						"order=$on{order}&amp;".
						"pos=$on{pos}&amp;".
						"views=$on{views}&amp;".
						"tags=$on{tags}&amp;".
						"folder=$on{folder}';",
		style=>'margin-top: 20px',
		type=>'reset');

    FormFoot();
    TaskFoot();
    HtmlFoot();
   }
  else
   {
    my $field_name  = $on{f1};
    my $field_value = DbQuote($on{"${field_name}1"});
       $field_value ||= 'null';
    my $filter_name = "<$field_name>:$field_value";
    my $in = $IG::query_string;
       $in =~ s/(\&amp\;|\&)elabora\=/$1elab\=/;

    QuoteParams();
    DbQuery(query =>[(  "delete from email_filter ".
			"where id='$in{id}' and owner='$auth_user'",

			"insert into email_filter values ('$in{id}',".
			" '$auth_user', '$filter_name', '$query', '$in',".
			" $in{when_apply}, '$action', '$in{replymsg}')"
		     )] );

    IG::Redirect("webmail?action=editfilter");
   }
 }

###############################################################################
###############################################################################
 sub openfilter
 {
  DbQuery("select form from email_filter ".
	  "where id='".DbQuote($on{id})."' and owner='$auth_user'");
  my $form = FetchRow();

  IG::Redirect("webmail?$form");
 }

###############################################################################
###############################################################################
sub deletefilter
 {
  DbQuery("delete from email_filter ".
	  "where id='".DbQuote($on{id})."' and owner='$auth_user'");

  IG::Redirect("webmail?action=editfilter");
 }

###############################################################################
###############################################################################
sub editfilter
 {
  my $counter;
  HtmlHead( shortcuts => _short_cuts(),
            title     => 'Email Filter' );
            
  TaskHead( width     => '100%',
            title     => 'Email Filter');

  HLayer(left_layers=>
	  [(
	    MkButton( text => $lang{filter_new},
                      link => "webmail?action=mkfilter"),

	    MkButton( text => $lang{backto_msg},
                      link => "webmail?".
                                      "folder=$on{folder}&amp;".
                                      "views=$on{views}&amp;".
                                      "tags=$on{tags}&amp;".
                                      "pos=$on{pos}&amp;".
                                      "order=$on{order}" ),
	    )]
	);

  TaskListMenu (	[''],
			[$lang{name}],
			['']);

  DbQuery("select * from email_filter ".
	  "where owner='$auth_user' order by name");

  while (my @row = FetchRow())
   {
    TaskListItem (
	[++$counter,
	 "webmail?action=openfilter&amp;id=$row[0]"],
	[MkEntities($row[2]),
	 '',
	 "width=100%"],
	[Img( src   => "$IG::img_url/delete.gif",
	      width => 16,
              href  => "webmail?action=deletefilter&amp;id=$row[0]" ).
	 Img( src   => "$IG::img_url/edit.gif",
	      width => 16,
              href  => "webmail?action=openfilter&amp;id=$row[0]" ),
	 '','nowrap' ]
		);
   }
  TaskListFoot();
  TaskFoot();
  HtmlFoot();
 }

###############################################################################
###############################################################################
sub composemessage
 {
  my %msg;
  my $to = $on{to};
  my $cc;
  my $bcc;
  my $subject;
  my $body;

  ## demo alert
  push @IG::errmsg, 'This is a Demo Version. '.
		    'No messages will be sent' if $IG::demo_version;

  ## Find last e-mail addresses
  my %last_emails;
  DbQuery("select receiver from email_msgs ".
	  "where issue>'".IG::SumDate($tv{day},$tv{month},$tv{year},-30)."'".
	  " and owner='$auth_user' and folder='SENT'".
	  " order by issue desc limit 50");
  $last_emails{$_} = $_ while $_ = FetchRow();

  ## Upload or delete attachments
  if ($on{'addattach.x'} && $on{attachment})
   {
    my $filepath = IG::ProtocolToFile($on{attachment});
    if ($filepath)
     { IG::WebMail::AddAttachment( attachment_path => $filepath ); }
    else
     { IG::WebMail::UploadAttachment('attachment'); }
   }
  elsif ( $on{'deleteattachments.x'} )
   {
    IG::WebMail::DeleteAttachments( $on{attachmentstodelete} );
   }
  elsif ( $on{file2import} )
   {
    my $home_directory = $IG::htdocs_dir . ${S} .
                         $IG::default_lang{home} . ${S} .
                         $auth_user;

    if ( $on{file2import} =~ /^$home_directory/ )
     {
      IG::WebMail::AddAttachment( attachment_path => $on{file2import} );
     }
    else
     {
      push @IG::errmsg, "Can't attach '$on{file2import}'";
     }
   }
  elsif (    (  !$on{'addattach.x'}
              && $on{action} !~ /^(sendigdoc|sendigbox|sendmessage)$/ )
	  || $on{'deleteallattachments.x'} )
   {
    IG::WebMail::DeleteAllAttachments();
   }

  ## reload an updated attachments list
  my ($savedattsize, @attlist) = IG::WebMail::GetAttList();

  ## Set available user identities
  my $email_addr = IG::UsrInf('email') || "$auth_user\@localhost";
  my $from = IG::UsrInf('name') . " <$email_addr>";
  DbQuery("select emailfrom from users where login='$auth_user'");
  my @identities = split /\n/, FetchRow();
  @identities = ( $from ) if !@identities;

  ## Check if we have to add a replied/forwarded e-mail message
  if ( $on{composetype} )
   {
    $cc		= $on{cc};
    $bcc	= $on{bcc};
    $subject	= $on{subject};
    $body	= $on{body};

    ## first select a text message to reply
    if ( $on{composetype} eq 'reply'       ||
	 $on{composetype} eq 'replyall'    ||
	 $on{composetype} eq 'draftresume' ||
	 $on{composetype} eq 'forward'     ||
	 $on{composetype} eq 'reuse'       ||
	 $on{composetype} eq 'forwardasattach'
       )
     {
      %msg = parse_message( owner   => $auth_user,
                            html_ok => 1,
			    id      => $on{message_id} );
      if ( ! %msg )
       {
        IG::Warn( "$lang{Err_no_email_msg}. Message-Id: ".
                  ( $on{message_id} || 'none') );
        return;
       }

      ## Update replied message status
      if (    $msg{status} !~ /e/
           && ( $on{composetype} eq 'reply' || $on{composetype} eq 'replyall' )
         )
       {
        $msg{status} = IG::WebMail::UpdateEmailMsgStatus
                        ( original_status => $msg{status},
                          status          => 'e',
                          message_id      => $on{message_id} );
       }

      ## resume (or inherit) share mode
      $on{sharemode} ||= $msg{sharemode};

      ## resume body part
      if ( $on{composetype} ne 'draftresume' )
       {
        ## reply / reuse / forward 
        $body =    $on{composetype} eq 'reuse'
                && IG::ConfigParam('webmail.compose_method') eq 'html'
                && $IG::plugin_conf{fckeditor}{webpath}
                && $IG::client_browser ne 'konqueror'
                && $msg{contenttype} =~ /^(text\/html|multipart\/alternative)/i
              ? $msg{html}
              : $msg{rawtext};
       }
      else
       {
        ## draftresume
        $body =    (   IG::ConfigParam('webmail.compose_method') eq 'html'
	            || $msg{contenttype} =~ /^(text\/html|multipart\/alternative)/i )
                && $IG::plugin_conf{fckeditor}{webpath}
                && $IG::client_browser ne 'konqueror'
              ? $msg{html}
              : $msg{rawtext};
       }

      ## Resume (or inherit) tag
      unless( $on{tagname} ) 
       {
        DbQuery("select email_msgtags.name ".
                "from email_msgtags ".
		"where email_msgtags.msgid='".DbQuote($on{message_id})."' ".
		"order by email_msgtags.name");
        my $taglist;
	while( my $tag = FetchRow() ) 
	 {
	  $taglist .= ' ' if $taglist;
	  $taglist .= $tag;
         }
        $on{tagname} = $taglist;
       }
     }

    ## second, looking for a message receiver and a subject
    if ( $on{composetype} eq 'reply' || $on{composetype} eq 'replyall' )
     {
      $subject = $msg{subject} || '';
      $subject = 'Re: ' . $subject if $subject !~ /^re(\[\d+\])*\:/i;

      $to = $msg{replyto} ? $msg{replyto} : $msg{from};

      if ($on{composetype} eq 'replyall')
       {
        $to .= ',' . $msg{to} if $msg{to};
        $cc = $msg{cc} if $msg{cc};

        my $myaddr = quotemeta( IG::UsrInf('email') );

	## remove self addr from to
        $to =~ s/\,*[^,]*$myaddr[^,]*//gi;
        $to =~ s/^\,\s*|\s*\,$//g;
        $to =~ s/\s+/ /g;

	## remove self addr from cc
        $cc =~ s/\,*[^,]*$myaddr[^,]*//gi;
        $cc =~ s/^\,\s*|\s*\,$//g;
        $cc =~ s/\s+/ /g;
       }

      ## quote replied text
      $body = _quote_and_reformat( $body );
     }
    elsif ($on{composetype} eq 'draftresume')
     {
      $to = $msg{to} if defined($msg{to});
      $cc = $msg{cc} if defined($msg{cc});
      $on{priority} ||= $msg{priority};
     }

    ## and now looking for attachments to resume
    if ( (   $on{composetype} eq 'forward'
          || $on{composetype} eq 'draftresume'
          || $on{composetype} eq 'reuse'
         ) 
	## on add/del attachments files already exist
	&& !$on{'deleteattachments.x'} && !$on{'addattach.x'} ) 
     {
      if (defined(${$msg{attachment}[0]}{header}))
       {
        foreach my $attnumber (0 .. $#{$msg{attachment}})
         {
          next
           if    ${$msg{attachment}[$attnumber]}{contenttype} =~ /^multipart/i
	      || ${$msg{attachment}[$attnumber]}{disposition} !~ 'attachment';

          
          my $target_file = $IG::user_dir . $S . 'webmail-att-'. MkId(15);
          open (ATTFILE, '>', $target_file)
            or die("Can't write on '$target_file'.\n");
          binmode(ATTFILE);
          print ATTFILE ${$msg{attachment}[$attnumber]}{header},
			"\n\n",
			${$msg{attachment}[$attnumber]}{contents};
          close ATTFILE;
         }
         
        ## refresh attachment list info
        ($savedattsize, @attlist) = IG::WebMail::GetAttList();
       }

      $subject = $msg{subject} || '';
      if ($on{composetype} ne 'draftresume' && $on{composetype} ne 'reuse')
       {
        $subject = "Fw: " . $subject unless ($subject =~ /^fw:/i);
        $body = "\n------ Forwarded message follows ------\n\n".
		"Subject: $msg{subject}\n".
		"Date: $msg{date}\n".
		"From: $msg{from}\n".
		"To: $msg{to}\n\n".
		$body;
       }
     }
    elsif ($on{composetype} eq 'forwardasattach')
     {
      IG::WebMail::AddAttachment( attachment_path => $IG::user_dir . $IG::S.
                                                     'MailBox'     . $IG::S.
                                                     $msg{folder}  . $IG::S.
                                                     $msg{messageid},
                                  content_type    => 'message/rfc822',
                                  encoding        => '7bit' );

      ( $savedattsize, @attlist) = IG::WebMail::GetAttList();
      $body = '';
     }
   }

  if ( $on{composetype} !~ /^(continue|draftresume|reuse)$/ )
   {
    ## add user signature to body message
    DbQuery("select signature from users where login='$auth_user'");
    my $signature = FetchRow();
    $signature ||= join "\n", ( '-- ',
                                $IG::soc_name,
                                IG::UsrInf('name'),
                                IG::UsrInf('function') );
    $body .= "\n\n" . $signature;
   }

  $on{sharemode} ||= IG::ConfigParam('webmail.share_mode') || 0;

  ## Start to show the form page
  HtmlHead(     title      => $lang{composenew} );

  TaskHead(	title      => $lang{composenew},
		minwidth   => 500 );

  FormHead(	enctype    => 'multipart/form-data',
		name       => 'composeform',
                ckchanges  => 'true',
                ischanged  => $IG::request_method eq 'POST' ? 'true' : 'false',
		labelstyle => 'width:140px;',
		cgiaction  => 'sendmessage');

  _set_hiddens();

  Input (       type       => 'hidden',
                name       => 'file2import',
                value      => '',
                override   => 1,
                method     => 'html');

  Input (	name       => 'composetype',
                override   => 1,
		value      => 'continue',
		type       => 'hidden');

  ## store message id in case of draftresume
  Input(        name       => 'message_id',
                type       => 'hidden') if $on{composetype} eq 'draftresume';

  Input(        name       => 'contactid',
                value      => $on{composetype} !~ /^(forward
                                                    |forwardasattach
                                                    |reuse)$/x
                           ?  $msg{contactid}
                           :  '',
                type      => 'hidden');

  Input(        name      => 'inreplyto',
                value     => $on{composetype} =~ /^reply/
                          ?  $msg{originalid}
                          :  $msg{inreplyto},
                type      => 'hidden');

  Input(        name      => 'idsreferences',
                value     => $on{composetype} =~ /^reply/
                          ?  "$msg{references} $msg{originalid}"
                          :  $msg{references},
                type      => 'hidden');

  Input(        name      => 'threadid',
                type      => 'hidden',
                value     => $msg{threadid} ) if $msg{threadid};

  Input(	name      => 'onsend',
                type      => 'hidden');

  Input(	name      => 'to',
		show      => "<a href=\"Javascript:GoAddressWindow('to0')\">".
		             $lang{to}.
		             ":</a>",
		type      => 'combo',
		value     => $to,
		style     => 'width:350px',
		autocompletion => { script_url   => 'webmail',
		                    script_action=> 'autocompletion',
		                    search_param => 'searchfor',
		                    id           => 'to0',
		                    min_chars    => 4 },
		data      => \%last_emails );

  _email_recipient_infobox_script();
  _email_recipient_infobox('to0');

  PrOut '<div id="extended_1" style="display:none; clear:left;">';

  Input (	name      => 'cc',
		type      => 'combo',
		show      => "<a href=\"Javascript:GoAddressWindow('cc0')\">".
		             $lang{cc}.
		             ":</a>",
		value     => $cc,
		style     => 'width:350px',
		autocompletion => { script_url   => 'webmail',
		                    script_action=> 'autocompletion',
		                    search_param => 'searchfor',
		                    id           => 'cc0',
		                    min_chars    => 4 },
		data      => \%last_emails );

  _email_recipient_infobox('cc0');

  Input (	name      => 'bcc',
                type      => 'combo',
                data      => \%last_emails,
                show      => "<a href=\"Javascript:GoAddressWindow('bcc0')\">".
                             $lang{bcc}.
                             ":</a>",
                value     => $bcc,
		autocompletion => { script_url   => 'webmail',
		                    script_action=> 'autocompletion',
		                    search_param => 'searchfor',
		                    id           => 'bcc0',
		                    min_chars    => 4 },
		style     => 'width:350px;' );

  _email_recipient_infobox('bcc0');

  Input (	name      => 'fromwho',
		show      => "$lang{from}:",
		type      => 'select',
		style     => 'width:370px;',
		data      => \@identities );

  Input (	name      => 'replyto',
		type      => 'text',
		show      => "$lang{replyto}:",
		value     => IG::UsrInf('email'),
		style     => 'width: 370px;');

  Input (	show      => $lang{priority},
		name      => 'priority',
		value     => 3,
		type      => 'select',
		style     => 'width:140',
		data      => [([1, "1 - $lang{highest}"],
		               [2, "2 - $lang{high}"],
		               [3, "3 - $lang{normal}"])]);

  Input (       show      => 'Tags:',
                quickhelp => $lang{compose_tag_help},
                name      => 'tagname',
		data      => IG::WebMail::GetTags(),
		zerovalue => 'true',
		value     => $on{tagname},
		float     => 'left',
		override  => 1,
		labelstyle=> 'width:50px;',
		style     => 'width:145px',
                autocompletion => { script_url   => 'webmail',
	                            script_action=> 'autocompletetags',
	                            search_param => 'searchfor',
	                            tokens       => ' ',
	                            id           => 'tagname0',
	                            min_chars    => 3 },
		type      => 'combo');

  Input (       show      => $lang{share_mode},
                type      => 'select',
                name      => 'sharemode',
                style     => 'width:370px',
                value     => $on{sharemode},
                data      => [([0, $lang{share_mode0}],
                               [1, $lang{share_mode1}],
                               [2, $lang{share_mode2}])]);

  PrOut '</div>';


  PrOut '<div id="extended_button">'.
        Input( type    => 'button',
               float   => 'right',
               value   => '>>',
               style   => 'font-size:10px; width:20px; height:16px; color:#FFFFFF; background:#009c00;',
               onclick => "new Effect.BlindDown('extended_1');".
                          "\$(noextended_button).style.display='block';".
                          "\$(extended_button).style.display='none';").
        '</div>'.
        '<div id="noextended_button" style="display:none">'.
        Input( type    => 'button',
               float   => 'right',
               value   => '<<',
               style   => 'font-size:10px; width:20px; height:16px; color:#FFFFFF; background:#009c00;',
               onclick => "new Effect.BlindUp('extended_1');".
                          "\$(extended_button).style.display='block';".
                          "\$(noextended_button).style.display='none';").
        '</div>';


  ## Show attached file
  my $attach_data;
  $attach_data .= "<em>".
                  Input( type  => 'checkbox',
                         name  => 'attachmentstodelete',
                         value => @$_[2] ).
		  " @$_[0] - @$_[1]</em><br>" foreach @attlist;

  if ( $savedattsize )
   { 
    $attach_data .= "$lang{total_attachments}: " . IG::MkByte($savedattsize);
    $attach_data .= " $lang{of} $IG::attlimit MB" if $IG::attlimit;
    $attach_data .= "<br><br>";
   }
   
  $attach_data .=
   HLayer(
       Input( name      => 'attachment',
              type      => 'file',
              style     => 'font-size:10px',
              size      => 30 ),

       Input( name      => 'addattach',
              onlyfield => 1,
              onclick   => IG::CallMeter('composeform.attachment.value'),
              alt       => $lang{attach_from_selected},
              src       => "$IG::img_url/folder_add.gif",
              style     => 'width:16px;',
              type      => 'image' ),

       Img(   name      => 'addfromfile',
              onclick   => "winPopUp('filemanager?defact=1',".
                                     "550,500,'AttachFromIGFile');",
              title     => $lang{attach_from_igfile},
              src       => "$IG::img_url/drive_add.gif",
              style     => 'cursor:pointer; width:16px;'),

       Input( name      => 'deleteattachments',
              onlyfield => 1,
              alt       => $lang{attach_delete_selected},
              style     => 'width:16px;',
              src       => "$IG::img_url/attach_del.png",
              type      => 'image' ),

       Input( name      => 'deleteallattachments',
              onlyfield => 1,
              alt       => $lang{attach_delete_all},
              onclick   => IG::JsConfirm($lang{are_you_sure}),
              style     => 'width:16px;',
              src       => "$IG::img_url/basket_put.png",
              type      => 'image' )
         );

  Input (       type    => 'label',
	        show    => $lang{attachment},
	        data    => $savedattsize
	                ?  IG::TaskMsg( $attach_data, 7, 320 )
	                :  $attach_data
	);

  Input (	name    => 'subject',
		type    => 'text',
		show    => "$lang{subject}:",
		value   => $subject,
		style   => 'width:370px');

  if ( (   !$IG::plugin_conf{fckeditor}{webpath}
        || $IG::client_browser eq 'konqueror' )
      && 
       (   IG::CkHtml( $on{body} || $body ) )
     )
   {
    ## this is an html body message but we can't edit it
    my $fake_body = $on{body};
       $fake_body =~ s/<BASE HREF\=\"$IG::cgi_url\/[^>]+>//;
       $fake_body = IG::WebMail::SanitizeHtml( $fake_body );
         
    PrOut "<br><!-- START MESSAGE PREVIEW -->\n".
          "<div style=\"width:700px; height:300px; overflow:auto;".
          " border:1px solid #999999; clear:both; margin:20px 5px 5px 5px;".
          " padding:3px;\">".
          $fake_body.
          "</div>\n<!-- END MESSAGE PREVIEW -->\n";
          
    Input (     type    => 'hidden',
                value   => $body,
                name    => 'body');
   }
  else
   {
    Input (	name    => 'body',
		type    => 'textarea',
                toolbar => 'IGExtended',
		fckeditor=>IG::ConfigParam('webmail.compose_method') eq 'html'
		           || (   $msg{contenttype} =~ /^(text\/html|multipart\/alternative)/i
			       && $on{composetype}  eq 'draftresume')
		           ? 'active'
		           : 'optional',
		fieldstyle=>'margin:10px;',
		value   => IG::ConfigParam('webmail.compose_method') eq 'html'
                           && $IG::plugin_conf{fckeditor}{webpath}
                           && $IG::client_browser ne 'konqueror'
                           && (    (    $on{composetype}  eq 'reuse'
                                     && $msg{contenttype} !~ /^text\/html/i
                                     && $msg{contenttype} !~ /^multipart\/alternative/i )
                                || (    $on{composetype}  ne 'draftresume'
                                     && $on{composetype}  ne 'reuse' )
                              )
                        ?  IG::WebMail::MkLink( $body )
                        :  $body,
		rows    => 18,
		cols    => 72,
                fckeditor_width  => 650,
                fckeditor_height => 360,
		wrap    => 'hard');
   }

  Input (	name    => 'sendmsg',
		type    => 'submit',
		value   => $lang{send});

  Input (	name    => 'savedraft',
		type    => 'submit',
		float   => 'left',
		value   => $lang{save_draft});

  Input (	show    => 'VCard',
		name    => 'addvcard',
		labelstyle=>'font-size:10px;width:auto;margin-left:8px;',
		float   => 'right',
		type    => 'checkbox');

  Input (	show    => $lang{notify},
		name    => 'notify',
		labelstyle=>'font-size:10px;width:auto;margin-left:8px;',
		float   => 'right',
		checked =>    $on{action} eq 'composemessage'
                           && IG::ConfigParam('webmail.notify_request')
                        ?  1
                        :  0,
		type    => 'checkbox');

  FormFoot();


  ## Mk the cancel button to return to the headers list
  ##
  FormHead(	cgiaction=> $on{message_id}
			    ? 'readmessage'
			    : 'displayheaders',
		float    => 'left');

  _set_hiddens();

  Input (	name     => 'message_id',
		type     => 'hidden');

  Input (	name     => $lang{cancel},
		type     => 'submit',
		onclick  => $on{onsend} eq 'close' ? 'self.close()' : '',
		value    => $lang{cancel});

  FormFoot();


  ## This is the JavaScript to generate addressbook
  PrOut <<END;
<script language="JavaScript">
  <!--
   if (self.focus != null)
      self.focus();

   function GoAddressWindow(toccbcc)
   {
      var url = "webmail?action=addressbook&amp;field=" + toccbcc;

      if (toccbcc == "to0")
         url += "&amp;preexisting=" + escape (document.composeform.to0.value);
      else if (toccbcc == "cc0")
         url += "&amp;preexisting=" + escape (document.composeform.cc0.value);
      else if (toccbcc == "bcc0")
         url += "&amp;preexisting=" + escape (document.composeform.bcc0.value);

      var hWnd = window.open(url,"HelpWindow","width=450,height=450,resizable=yes,scrollbars=yes");
      if ((document.window != null) && (!hWnd.opener))
         hWnd.opener = document.window;
   }

   //-->
</script>
END

  Footer();
  1;
 }

###############################################################################
###############################################################################
sub _email_recipient_infobox
 {
  my $fieldName = shift;
  my $popupId = $fieldName.'_info';
     
  PrOut "<div".
        " class=\"infobox\"".
        " id=\"$popupId\"".
        " onClick=\"event.cancelBubble = true;\">".
        "<div style=\"width:100px; line-height:0px;\"></div>". # min-width
        "will be replaced</div>\n";
     
  Img( src         => "$IG::img_url/application_view_list.png",
       onmouseout  => "hideThisPopup('$popupId');",
       onclick     => "Javascript:GoAddressWindow('$fieldName')",
       width       => 16,
       onmouseover => "\$($popupId).innerHTML = formatEmails(document.composeform.$fieldName.value); showPopup('$popupId', event, 1 );",
       style       => 'cursor:pointer; margin-top:3px;' );
 }

###############################################################################
###############################################################################
sub _email_recipient_infobox_script
 {
     PrOut <<'END';
<script language="JavaScript">
  <!--

function formatEmails(emails) {
    emails = emails.replace( /(".*?")/g, function($1) {
       return $1.replace(/,/g, "###COMMA###" );
    } );
    emails = emails.replace( /([^\",]*(?:\".*?\")? *<.+?> *|[^\"]*?),/g,"$1\n" );
    emails = emails.replace( /\#\#\#COMMA\#\#\#/g, "," );
    
    emails = replaceExtChars( emails );
    emails = emails.replace( /\n/g, "<br>" );
    emails = emails.replace( / /g, "&nbsp;" );
    emails = emails.replace( /-/g, "&minus;" );
    emails = emails.replace( /^ *$/, "Empty&nbsp;list".italics() );
    
    return emails;
}
       
     
/*
function replaces extended characters of 'text' with its character
entities.
call the function by default with output = false. if you switch it
to true
it will format the source code for output in a textarea.
*/
function replaceExtChars(text,output) {
  text = text.replace(eval('/&/g'), '&amp;');
  fromTo = new
  Array('&AElig;','Æ','&Aacute;','Á','&Acirc;','Â','&Agrave;','À',
      '&Aring;','Å','&Atilde;', 'Ã','&Auml;','Ä','&Ccedil;','Ç',
      '&ETH;','Ð','&Eacute;','É','&Ecirc;','Ê','&Egrave;','È',
      '&Euml;','Ë','&Iacute;','Í','&Icirc;','Î','&Igrave;','Ì',
      '&Iuml;','Ï','&Ntilde;','Ñ', '&Oacute;','Ó','&Ocirc;','Ô',
      '&Ograve;','Ò','&Oslash;','Ø','&Otilde;','Õ','&Ouml;','Ö',
      '&THORN; ','Þ','&Uacute;','Ú','&Ucirc;','Û','&Ugrave;','Ù',
      '&Uuml;','Ü','&Yacute;','Ý','&aacute;', 'á','&acirc;','â',
      '&aelig;','æ','&agrave;','à','&aring;','å','&atilde;','ã',
      '&auml;','ä ','&brvbar;','¦','&ccedil;','ç','&cent;','¢',
      '&copy;','©','&deg;','°','&eacute;','é', '&ecirc;','ê',
      '&egrave;','è','&eth;','ð','&euml;','ë','&frac12;','½',
      '&frac14;','¼','&frac34; ','¾','&gt;','>','&gt','>','&iacute;','í',
      '&icirc;','î','&iexcl;','¡','&igrave;','ì','&iquest;','¿',
      '&iuml;','ï', '&laquo;','«','&lt;','<','&lt','<',
      '&micro;','µ','&middot;','·',
      '&not;','¬',
      '&ntilde;','ñ', '&oacute;','ó','&ocirc;','ô','&ograve;','ò',
      '&oslash;','ø','&otilde;','õ','&ouml;','ö','&para;','¶',
      '&plusmn;','±','&pound;',' £','&quot;','\\"','&raquo;','»',
      '&reg;','®','&sect;','§',
      '&sup1;','¹',
      '&sup2;','²',
      '&sup3;','³','&szlig;','ß','&thorn;','þ','&#126;','~',
      '&uacute;','ú','&ucirc; ','û','&ugrave;','ù','&uuml;','ü',
      '&yacute;','ý','&yen;','¥','&yuml;','ÿ');

  if (output) {
    fromTo[fromTo.length] = '&amp;';
    fromTo[fromTo.length] = '&';
  }
  for (i=0; i < fromTo.length; i=i+2)
    text = text.replace(eval('/'+fromTo[i+1]+'/g'), fromTo[i])
  return (text);
}       
   //-->
</script>
END
 }

###############################################################################
###############################################################################
sub _quote_and_reformat
 {
  my $body = shift;

  ## Trim leading and triling spaces and cr
  1 while $body =~ s/^\s|\s$//g;

  ## Quote
  $body =~ s/\n/\n\> /g;

  ## Reformat
  $body = _text_msg_autoformat( $body ? "> $body" : '' );

  ## Trim blank line
  1 while $body =~ s/(\>\n){3}/\>\n\>\n/mg;

  return $body;
 }

###############################################################################
###############################################################################
sub _text_msg_autoformat
 {
  require IG::TextAutoformat;
  Text::Autoformat->import(qw(break_at autoformat));

  my $body = shift;

  ## Trim leading and triling spaces and cr
  1 while $body =~ s/^\s|\s$//g;

  ## Reformat
  $body = Text::Autoformat::autoformat( $body,
                                        { left     => 1,
                                          right    => 70,
                                          renumber => 0,
                                          lists    => 'roman, bullet, alpha',
                                          all      => 1 } );

  ## Trim excessive blank line
  1 while $body =~ s/[\n]{4,}/\n\n\n/mg;

  return $body;
 }
 
###############################################################################
###############################################################################
sub sendigbox
 {
  ## remove eventually previous attachments
  IG::WebMail::DeleteAllAttachments();

  my $binder_spool = IG::UserDir() . ${S} . 'binder';

  IG::Warn($lang{Err_any_documents}) && return if ! -e $binder_spool;

  open( DAT, '<', $binder_spool )
    or die("Can't open '$binder_spool' to read binder spool.\n");

  _attach_ig_doc( $_ ) for <DAT>;

  close(DAT);
  IG::FileUnlink( $binder_spool )
    or die("Can't delete binder spool '$binder_spool'.\n");

  composemessage();
 }

###############################################################################
###############################################################################
sub sendigdoc
 {
  ## remove eventually previous attachments
  IG::WebMail::DeleteAllAttachments();

  if ( $on{protocol} =~ /F\d{5}\.\d\d/ )
   {
    ## it's a binder (a group of documents)
    DbQuery( "select docid from bindeddocs ".
             "where binderid='".DbQuote($on{protocol})."' ".
             "order by docissue desc");
    while ( my $id = FetchRow() )
     { _attach_ig_doc( $id ); }
   }
  else
   {
    ## it's a single document
    _attach_ig_doc( $on{protocol} );
   }

  composemessage();
 }

###############################################################################
###############################################################################
sub _attach_ig_doc
 { 
  chomp( my $pid = shift );
  my ($filename, $filedir, $fileproc) = IG::ProtocolToFile( $pid );

  die("Error can't attach '$pid' to your email ".
      "because it doesn't exist!\n")
    if !$filename;

  die("Sorry, you can't access to this document '$pid' ".
      "you don't have privileges.\n")
    if    ! IG::CheckPrivilege($fileproc . '_view')
       || ! IG::CheckResourcePrivileges( id => $pid, mode => 'r' );

  ## check file path (paranoic)
  my $filepath = IG::CkPath( "$filedir$S$filename" );

  ## set a right attach protocol file name
  my ($ext) = $filename =~ /(\.[^\.]+)$/;
  my $attach_name = $pid . $ext;

  if ( $ext =~ /^\.tiff*$/i && -e $IG::ext_app{tiff2pdf} )
   {
    ## try to convert tiff file to pdf (it's a better format to send as
    ## email attachment )
    my $pdf_filepath = $IG::temp_dir . $S . ".pdfjob_$auth_user.pdf";
                                                               
    if ( IG::SysExec( command   => $IG::ext_app{tiff2pdf},
                      arguments => [( '-p', 'A4',
                                      '-o', $pdf_filepath,
                                      $filepath )] )
       )
     {
      $filepath    = $pdf_filepath;
      $attach_name = $pid . '.pdf';
     }

    IG::WebMail::AddAttachment( attachment_path => $filepath,
                                attachment_name => $attach_name );
   }
  elsif ( $ext =~ /^\.html*$/i && $on{action} eq 'sendigdoc' )
   {
    ## XXX2DEVELOPE - manage html attachment
    ## convert images inside an html attach to other attachments with cid:
    ## - Get the file (LWP) if needed
    ## - Parse page to find include images (gif, jpg, flash)
    ## - Attach them to mail with adequat header if asked (default)
    ## - Include external CSS,Javascript file
    ## - Replace relative url with absolute one

    ## send the html document as a body part
    $on{body} = '';
    open( FH, '<', $filepath )
      or die("Can't read from '$filepath'.\n");
    $on{body} .= $_ while <FH>;
    close(FH);
   }
  else
   {
    IG::WebMail::AddAttachment( attachment_path => $filepath,
                                attachment_name => $attach_name );
   }
 }

###############################################################################
###############################################################################
sub sendprintview
 {
  my $print_view_file = $IG::temp_dir . $S . $auth_user . '_printview.htm';

  die("Error can't attach a print view to your email ".
      "because it doesn't exist!\n") if ! -e $print_view_file;

  $on{body} = '';
  open (FH, '<', $print_view_file)
    or die("Can't open '$print_view_file'.\n");
  $on{body} .= $_ while <FH>;
  close(FH);
  composemessage();
 }

###############################################################################
###############################################################################
sub _set_hiddens
 {
  Input (	name=>'order',
		type=>'hidden');
		
  Input (	name=>'sortdirection',
		type=>'hidden');

  Input (	name=>'views',
		type=>'hidden');

  Input (	name=>'tags',
		type=>'hidden');

  Input (	name=>'pos',
		type=>'hidden');

  Input (	name=>'folder',
		value=>$folder,
		type=>'hidden');
 }

###############################################################################
###############################################################################
sub sendmessage
 {
  no strict 'refs';

  ## In some case we have to return to compose form
  if (    $on{'addattach.x'}
       || $on{'deleteallattachments.x'}
       || $on{file2import}
       || $on{'deleteattachments.x'} )
   {
    composemessage();
    return;
   }

  ## Check errors
  if (!$on{to} && !$on{cc} && !$on{bcc} && !$on{savedraft})
   {
    push @IG::errmsg, $lang{Err_missing_receiver};
    $lang{to} = Blush($lang{to});
   }

  if (!$on{subject} && !$on{savedraft})
   {
    push @IG::errmsg, $lang{Err_no_subject};
    $lang{subject} = Blush($lang{subject});
   }

  composemessage() && return if @IG::errmsg;


  ## Send the message

  ## Add a VCard as attachment if requested
  IG::WebMail::AddVCard() if $on{addvcard};

  ## Add a header that will allow SENT folder to function correctly

  my $body_msg_type = IG::CkHtml( $on{body} ) ? 'text/html' : 'text/plain';
  my %mail;
  my $contenttype;
  my $localtime = scalar(localtime);
  my $date = IG::GetDateExtended();

  ## Make a from and realname fields
  my $realname = IG::UsrInf('name');
     $realname =~ s/[\&|;|\`|\'|\\|\""|\*|\?|~|<|>|^|\(|\)|\[|\]|\{|\}|\$|\n|\r]/ /g;
     $realname = '"'. $realname .'"';
  my $from     = IG::UsrInf('email') || "$auth_user\@localhost";
     $from     =~ s/[\&|;|\`|\'|\\|\""|\*|\?|~|<|>|^|\(|\)|\[|\]|\{|\}|\$|\n|\r]/ /g;
  my $fromwho  = $on{fromwho} || "$realname <$from>";
     $fromwho  =~ s/[\&|;|\`|\'|\\|\*|\?|~|^|\(|\)|\[|\]|\{|\}|\$|\n|\r]/ /g;

  ## find sender hostaname
  my $hostname = (IG::WebMail::ParseAddress($from))[2] || 'unkhost';

  ## Check the 'to' field
  if ($on{to} && $on{to} !~ /\@/)
   {
    if ( IG::UsrInf('email', $on{to}) )
     {
      ## use stored and complete IGSuite user email
      $on{to} = IG::UsrInf('email', $on{to});
     }
    else
     {
      ## use the same sender host name
      $on{to} .= '@' . $hostname;
     }
   }

  my $savedatts; # Will buffer saved attachments
  my $boundary = "----=IGSUITE_ATT_" . MkId();
  $on{body} =~ s/\r//g;

  ## Upload last attachment not added
  IG::WebMail::UploadAttachment('attachment') if $on{attachment};

  ## Start message content with 'From '
  my $messagecontents = "From $auth_user $localtime\n";

  ## A new ID if we want send message otherwise use old one
  my $db_message_id   = $on{savedraft} && $on{message_id}
                      ? $on{message_id}
                      : IG::MkId(30);

  $mail{From} = $fromwho;
  $messagecontents .= "From: $fromwho\n";

  $mail{To} = $on{to};
  $messagecontents .= "To: $on{to}\n";

  if ($on{cc})
   {
    $mail{CC} = $on{cc};
    $messagecontents .= "CC: $on{cc}\n";
   }

  if ($on{bcc})
   {
    $mail{Bcc} = $on{bcc};
    $messagecontents .= "Bcc: $on{bcc}\n";
   }

  if ($on{replyto} || IG::UsrInf('email'))
   {
    $mail{'Reply-To'} = $on{replyto} || IG::UsrInf('email');
    $messagecontents .= 'Reply-To: ' . $mail{'Reply-To'} . "\n";
   }

  if ($on{inreplyto})
   {
    $mail{'In-Reply-To'} = $on{inreplyto};
    $messagecontents .= "In-Reply-To: $on{inreplyto}\n";
   }

  if ($on{idsreferences})
   {
    ## rearrange references
    my $fake_references = $on{idsreferences};
    $on{idsreferences} = '';
    for (split /\n|\r|\s/, $fake_references)
     {
      next if !$_;
      $on{idsreferences} .= "$_\n\t";
     }
    $on{idsreferences} =~ s/\n\t$//;
    $mail{'References'} = $on{idsreferences};
    $messagecontents .= "References: $on{idsreferences}\n";
   }

  $mail{Subject} = $on{subject};
  $messagecontents .= "Subject: $on{subject}\n";
  $mail{'X-Mailer'} = "IGWebMail $IG::VERSION";
  $messagecontents .= "X-Mailer: IGWebMail $IG::VERSION\n";
  $mail{'X-IPAddress'} = $ENV{REMOTE_ADDR};
  $messagecontents .= "X-IPAddress: $ENV{REMOTE_ADDR}\n";
  $mail{'X-Priority'} = $on{priority};
  $messagecontents .= "X-Priority: $on{priority}\n";
  $mail{'Message-Id'} = $on{originalid} = "<$db_message_id\@$hostname>";
  $messagecontents .= "Message-Id: ". $mail{'Message-Id'} ."\n";
  $mail{'Date'} = $date;
  $messagecontents .= "Date: $date\nStatus: R\n";
  $mail{'MIME-Version'} = "1.0";
  $messagecontents .= "MIME-Version: 1.0\n";

  ## Set a return receipt request
  if ($on{notify})
   {
    for my $hd ( qw( Disposition-Notification-To
                     Return-receipt-to
                     X-Confirm-Reading-To ) )
     {
      $mail{$hd} = $from;
      $messagecontents .= "$hd: $from\n";
     }
   }

  if ( !$on{savedraft} && $body_msg_type eq 'text/html' )
   {
    $on{body} = IG::WebMail::ParseHtmlBodyPart( $on{body} );
   }

  ## Parse all files to attach
  opendir (MAILDIR, "$IG::user_dir")
    or die("$lang{couldnt_open} '$IG::user_dir'!\n");

  while (defined(my $currentfile = readdir(MAILDIR)))
   {
    if ($currentfile =~ /^(webmail-att-.+)$/)
     {
      local $/ = undef; # Force a single input to grab the whole spool
      $currentfile = $1;
      open (ATTFILE, '<', "$IG::user_dir${S}$currentfile")
        or die("Can't read '$IG::user_dir${S}$currentfile'.\n");
      $savedatts .= "\n--$boundary\n" . <ATTFILE>;
      close (ATTFILE);
     }
   }
  closedir (MAILDIR);


  if ($savedatts)
   {
    ## this is a multipart message
    $contenttype = $body_msg_type eq 'text/html'
                 ? "multipart/related; boundary=\"$boundary\""
                 : "multipart/mixed; boundary=\"$boundary\"";

    $mail{'Content-Type'} = $contenttype;
    $mail{Message}  = "This is a multi-part message in MIME format.\n\n";
    $mail{Message} .= "--$boundary\n";
    $mail{Message} .= "Content-Type: $body_msg_type; charset=$IG::lang_charset\n";
    $mail{Message} .= "Content-Transfer-Encoding: quoted-printable\n";

    ## Encode body to Quoted Printable
    $mail{Message}   .= "\n" . QuotedPrint::encode_qp( $on{body} );
    $mail{Message}    =~ s/^From/=46rom/gm;
    $mail{Message}   .= "\n$savedatts\n" . "--$boundary--";
    $messagecontents .= "Content-Type: $contenttype\n".
                         $mail{Message}.
                         "\n\n";
   }
  else
   {
    ## this is a simple text or html body message
    $mail{'Content-Transfer-Encoding'} = 'quoted-printable';
    $messagecontents .= "Content-Transfer-Encoding: quoted-printable\n";

    ## Encode body to Quoted Printable
    $mail{Message} = QuotedPrint::encode_qp( $on{body} );
    $mail{Message} =~ s/^From/=46rom/gm;

    $contenttype = "$body_msg_type; charset=$IG::lang_charset";
    $mail{'Content-Type'} = $contenttype;
    $messagecontents .= "Content-Type: $contenttype\n\n".
                        "$mail{Message}\n\n";
   }

  ## send message if we have not to save it in draft folder
  if ( !$on{savedraft} && !$IG::demo_version )
   {
    IG::WebMail::SendMsg( %mail )
      or die("IGWebMail error: $IG::WebMail::error.\n");
   }

  ## delete all attachments
  IG::WebMail::DeleteAllAttachments();

  ## if user quota exceded we don't store message
  unless ($IG::WebMail::hitquota)
   {
    my $dest_folder = $on{savedraft}
                    ? 'DRAFTS'
                    : 'SENT';

    ## Try to link email msg to a contact
    if ( !$on{contactid} )
     {
      my $private;
      ( $on{contactid}, $private ) = _contactFromEmail( $on{to} );

      $on{sharemode} = $private ? 2 : IG::ConfigParam('webmail.share_mode');
     }

    ## Try to connect the message to a threadid
    $on{threadid}  ||= _get_threadid( $on{subject}, $on{idsreferences});

    ## If we have a contactid make a new email protocolid
    my $pidLock;
    if ( $on{contactid} && !IG::ConfigParam('webmail.automatic_protocol') )
     { 
       ($on{protocolid}, $pidLock) = _emailProtocolId();
     }
    else
     { $on{protocolid} = ''; }

    DbWrite( overwrite_clause => "id='$db_message_id' and owner='$auth_user'",
             action           => 'insert',
             table            => 'email_msgs',
             values           => [ $db_message_id,
                                   $tv{today},
                                   "$tv{time} $tv{time_offset}",
                                   $fromwho,
                                   $on{contactid},
                                   $on{to} || $fromwho,
                                   $auth_user,
                                   $on{subject},
                                   $dest_folder,
                                   $contenttype,
                                   'R',
                                   length($messagecontents) + length("\n"),
                                   $on{sharemode} || '0',
                                   '',
                                   $on{body},
                                   $on{protocolid},
                                   $on{originalid},
                                   $on{idsreferences},
                                   $on{threadid} ] );

    undef $pidLock; ## relase the lock over email protocols

    ## Delete any existing message tag and write new one(s) (if any)
    DbQuery( query=> "delete from email_msgtags ".
                     "where msgid='$db_message_id'" );
    $on{tagname} =~ s/^\s+|\s+$// if $on{tagname}; ## trim spaces
    if ( $on{tagname} ) 
     {
      foreach my $tag ( split(/\s+/, $on{tagname}) ) 
       {
        my $tagid = MkId(32);
        DbQuery( query=> "insert into email_msgtags values".
                         " ('$tagid', '$db_message_id', '".
                         DbQuote(uc($tag))."')" );
       }
     }

    my $folder_dir = "$IG::user_dir${S}MailBox${S}$dest_folder";

    IG::WebMail::MkSpoolDir( $folder_dir );

    open (SENT, '>', "$folder_dir${S}$db_message_id")
      or die("$lang{couldnt_open} '$folder_dir${S}$db_message_id!'.\n");
    binmode(SENT);
    print SENT "$messagecontents\n";
    close (SENT)
      or die("$lang{couldnt_close} '$folder_dir${S}$db_message_id!'\n");

    IG::WebMail::ApplyUserFilter('SENT') if !$on{savedraft};
   }

  if ($IG::request_method eq 'commandline' || $on{action} ne 'sendmessage' )
   {
    return;
   }
  elsif ( $on{onsend} )
   {
    IG::AutoCloseTask( title => 'IGWebMail',
                       msg   => $on{savedraft} 
                             ?  $lang{draft_saved_ok}
                             :  $lang{send_ok} );
   }
  else
   {
    checkfolders();
    displayheaders();
   }

  LogD( $on{subject},
	'send',
	'email_msgs',
	$on{protocolid} ) if $on{protocolid};
 }

###############################################################################
###############################################################################
sub _decode
 {
  my ($text, $encoding, $contenttype) = @_;

  if ( $encoding eq 'mimewords' )
   {
    my $decoded;
    foreach ( MIME::Words::decode_mimewords( $text ) )
     {
      my ( $data, $code ) = @$_;
      $decoded .= $code
                ? IG::TextConvert( fromcode     => $code,
                                   tocode       => $IG::lang_charset,
                                   text         => $data )
                : $data;
     }
    return $decoded;
   }
  else
   {
    $text = $encoding =~ /^quoted\-printable/i ? QuotedPrint::decode_qp($text)
          : $encoding =~ /^base64/i            ? Mime::Base64::decode_base64($text)
          : $text; ## Guessing it's 7/8-bit, at least sending SOMETHING back! :)

    return ## encode charset to IGSuite lang_charset value
           IG::TextConvert( fromcode     => 'auto',
                            tocode       => $IG::lang_charset,
                            text         => $text,
                            content_type => $contenttype );
   }
 }

###############################################################################
###############################################################################
sub docview
 {
  ## for compatibility to other protocols
  my $id = DbQuote($on{id});
  DbQuery("select id, owner from email_msgs where pid='$id'");
  ( $on{message_id}, $on{owner} ) = FetchRow();
  readmessage();  
 }

###############################################################################
###############################################################################
sub readmessage
 { 
  $on{owner}   ||= $auth_user;
  $on{headers} ||= 'simple';

   ## we don't have a message_id but a pid ( protocol id )
   ($on{message_id}, $on{owner}) = IG::WebMail::PidToId( pid => $on{pid} )
       if !$on{message_id} && $on{pid};
 
   ## we dont't know what to display so back to emails list  
   if ( !$on{message_id} )
    {
     IG::Redirect( "webmail?".
			"pos=1&amp;".
			"views=$on{views}&amp;".
			"tags=$on{tags}&amp;".
			"order=$on{order}&amp;".
			"sortdirection=$on{sortdirection}&amp;".
			"folder=$escapedfolder&amp;".
			"owner=$on{owner}&amp;".
			"action=displayheaders" );
     return;
    }

   my $not_limited_view =    ! $on{print} 
                          && $auth_user eq $on{owner}
                          && $on{action} ne 'viewattachment'
                        ? 1
                        : 0;

   my $escapedmessageid = MkUrl( $on{message_id} );

   my $messageLock = AutoReleasedLock->new( resource_id => 'email_'.
                                                           $on{owner}.'_'.
                                                           $on{message_id} );

   ## how we have to show the message (prefer html or text content)
   $on{html_ok} = IG::ConfigParam('webmail.html_ok')
                  if ! defined( $on{html_ok} );

   ## if user can't access to the message parse_message() will return undef
   my %msg = parse_message( owner   => $on{owner},
                            html_ok => $on{html_ok},
			    id      => $on{message_id} );

   ## Check document accessibility
   IG::CheckResourcePrivileges( id               => $on{message_id},
                                mode             => 'r',
                                resource_cgi     => 'webmail',
                                resource_dbtable => 'email_msgs'
                              ) || return;
 
   if ( %msg )
    {
     if ( $msg{status} !~ /r/i )
      {
       IG::Warn("This is an unread message! the owner must read the message ".
                "before each other users!") && return if $on{owner} ne $auth_user;
                
       ## perform the status update (only $auth_user can update the status)
       $msg{status} = IG::WebMail::UpdateEmailMsgStatus
                       ( original_status => $msg{status},
                         status          => 'r',
                         message_id      => $on{message_id} );

       checkfolders();
      }

     if (    $msg{status} !~ /o/i
          && $msg{notificationto} 
          && IG::WebMail::_emailInLists( IG::UsrInf('email'),
                                           $msg{to},
                                           $msg{cc}
                                       )
        )
      {
       ## send a receipt to the sender
       my $receiver = (IG::WebMail::ParseAddress($msg{notificationto}))[1];

       ## send the receipt by an email message
       my $receiptText = "$lang{receiver}: ".IG::UsrInf('email')."\n".
                         "$lang{date}: $msg{date} - $msg{time}\n".
                         "$lang{subject}: $msg{subject}\n".
                         "Received: $IG::tv{time} - $IG::tv{today}";

       my $boundary = "----=IGSUITE_NEXT_" . MkId();
       my $body = "This is a multi-part message in MIME format.\n\n".
                  "--$boundary\n".
                  "Content-Type: text/plain; charset=$IG::lang_charset\n".
                  "Content-Transfer-Encoding: quoted-printable\n".
                  "\n" . QuotedPrint::encode_qp( $receiptText );
          $body =~ s/^From/=46rom/gm;
          $body .= "\n--$boundary\n".
                   "Content-Type: message/disposition-notification\n".
                   "Content-Transfer-Encoding: 7bit\n".
                   "\n".
                   "Final-Recipient: RFC822; ".IG::UsrInf('email')."\n".
                   "Original-Message-ID: $msg{originalid}\n". 
                   "Disposition: automatic-action/MDN-sent-automatically; displayed\n".
                   "\n--$boundary--";

       IG::WebMail::SendMsg
        ( 'To'           => $receiver,
          'Subject'      => "$lang{message_read}: '$msg{subject}'",
          'In-Reply-To'  => $msg{originalid},
          'Content-Type' => "multipart/report;\r\n".
                            "\treport-type=disposition-notification;\r\n".
                            "\tboundary=\"$boundary\"",
          'Message'      => $body
        ) or push @IG::errmsg, "Can't send a disposition notification: ".
                               "$IG::WebMail::error";

       $msg{status} = IG::WebMail::UpdateEmailMsgStatus
                       ( original_status => $msg{status},
                         status          => 'o',
                         message_id      => $on{message_id} );
      }
    }

   HtmlHead( shortcuts => $auth_user eq $on{owner}
                       ?  _short_cuts()
                       :  _short_cuts_common(),
             title     => $lang{email},
	     ajax_req  => { setsharemode => "webmail?".
					    "action=setsharemode&amp;".
					    "message_id=$escapedmessageid",
                            addtag       => "webmail?".
					    "action=addtag&amp;".
					    "message_id=$escapedmessageid",
			    deltag       => "webmail?".
					    "action=deltag&amp;".
					    "message_id=$escapedmessageid" });

   TaskHead( padding     => 5,
             minwidth    => 680,
	     title       => $on{print} 
		          ? IG::UsrInf('name',$on{owner})." &lt;".
		            ( $msg{to} 
		              ? (IG::WebMail::ParseAddress($msg{to}))[1]
		              : IG::UsrInf('email',$on{owner})
		            ). "&gt;"
		          : 'IGWebMail' );

   if ( %msg )
    {
      ## XXX2DEVELOPE - check threadid value and looking for it if empty
                       
      my $base_url_noid = "webmail?".
			"pos=$on{pos}&amp;".
			"views=$on{views}&amp;".
			"tags=$on{tags}&amp;".
			"order=$on{order}&amp;".
			"sortdirection=$on{sortdirection}&amp;".
			"folder=$escapedfolder";

      my $base_url    = "$base_url_noid&amp;".
			"owner=$on{owner}&amp;".
			"message_id=$escapedmessageid";

      my ( $email,
           $host  ) = map( lc,
                           ( (IG::WebMail::ParseAddress($msg{from}))[1,2] ));

      $host    = "www.$host" if $host !~ /^www/;

      my $from    = IG::WebMail::MkLink($msg{from});

         $from   .= Img( href   => "http://$host",
			 target => "_blank",
			 style  => 'margin-left:2px;',
			 align  => 'absmiddle',
                         class  => 'noprint',
			 width  => 16,
			 src    => "$IG::img_url/email_link.png",
			 title  => $host ) if $host;

         $from   .= Img( href   => "$base_url&amp;".
                                   "contactid=$msg{contactid}&amp;".
                                   "backtoreferer=1&amp;".
                                   "action=addtocontact",
                         src    => "$IG::img_url/email_add.png",
                         width  => 16,
                         class  => 'noprint',
                         align  => 'absmiddle',
                         style  => 'margin-left:2px;',
                         title  => $lang{addressbook_add} );

         $from   .= Img( href   => "webmail?action=mkfilter&amp;".
                                   "f1=sender&amp;".
                                   "sender1=".MkUrl($email)."&amp;".
                                   "hm=2&amp;".
                                   "when_apply=1&amp;".
                                   "filter_action=1&amp;".
                                   "destination_folder=TRASH",
                         src    => "$IG::img_url/email_blist.png",
                         width  => 16,
                         class  => 'noprint',
                         align  => 'absmiddle',
                         style  => 'margin-left:2px;',
                         title  => 'Black List' );

      my $to      = $msg{to} || IG::UsrInf('email');
         $to      = IG::WebMail::MkLink( $to || $msg{replyto} );

      my $cc      = $msg{cc} &&= IG::WebMail::MkLink($msg{cc});


      ## Set up the message to go to after move.
      my $messageaftermove;
      if    (    ( $on{sortdirection} eq 'asc' || ! defined($msg{prev}) )
              && defined($msg{next}) )
       { $messageaftermove = $msg{next}; }
      elsif (    ( $on{sortdirection} eq 'desc' || ! defined($msg{next}) )
              && defined($msg{prev}) )
       { $messageaftermove = $msg{prev}; }

      ## Icons bar 
      PrOut "<table style=\"background-color:$IG::clr{bg_task}; width:100%\">\n";
      if ( $not_limited_view )
       {
        PrOut '<td>';
        HLayer( intra_space  => 3,
		bottom_space => 1,
		layers       => [(
 
		MkButton( icon_src   => "$IG::img_url/mail_folder.png",
                          icon_width => 26,
		          link       => "$base_url&amp;action=displayheaders",
                          quick_help =>	"$lang{backto} $folderinfo{$folder}{name}" ),

		MkButton( icon_src   => "$IG::img_url/mail_reply.png",
                          icon_width => 26,
                          link       =>	"$base_url&amp;".
                                        "action=composemessage&amp;".
                                        "composetype=reply",
                          quick_help =>	$lang{reply} ),

		MkButton( icon_src   => "$IG::img_url/mail_replyall.png",
                          icon_width => 26,
                          link       =>	"$base_url&amp;".
                                      	"action=composemessage&amp;".
                                      	"composetype=replyall",
                          quick_help =>	$lang{replyall} ),

		MkButton( icon_src   => "$IG::img_url/mail_forward.png",
                          icon_width => 26,
                          link       => "$base_url&amp;".
                   			"action=composemessage&amp;".
		             		"composetype=forward",
                          quick_help => $lang{forward} ),

		MkButton( icon_src   => "$IG::img_url/mail_forward_att.png",
                          icon_width => 26,
			  link       => "$base_url&amp;".
        				"action=composemessage&amp;".
	        			"composetype=forwardasattach",
		          quick_help =>	$lang{forward_as_attach} ),

		MkButton( icon_src   => "$IG::img_url/mail_reuse.png",
                          icon_width => 26,
                          link       => "$base_url&amp;".
                   			"action=composemessage&amp;".
		             		"composetype=reuse",
                          quick_help => $lang{reuse_message} ),

		MkButton( icon_src   => "$IG::img_url/prefs.png",
                          icon_width => 26,
                          link       => "javascript:winPopUp('".
                                        "$base_url&amp;action=setcontact".
                                        "',650,250,'SetContact');",
                          quick_help =>	$lang{message_settings} ),

		MkButton( icon_src   => "$IG::img_url/lockbig.png",
                          icon_width => 26,
                          link       => "javascript:winPopUp('".
                                        "igsuite?".
                                                "action=resourcemode&amp;".
                                                "resource_cgi=webmail&amp;".
                                                "resource_dbtable=email_msgs&amp;".
                                                "id=$escapedmessageid".
                                        "',620,550,'SetPrivileges');",
                          quick_help =>	$lang{privileges_mng} ),

                MkButton( icon_src   => "$IG::img_url/mail_export.png",
                          icon_width => 26,
                          link       => "webmail/$escapedmessageid.msg?".
                                       	"message_id=$escapedmessageid&amp;".
                                        "action=exportmessages",
                          quick_help =>	$lang{export_message} ),

		MkButton( icon_src   => "$IG::img_url/mail_trash.png",
                          icon_width => 26,
		          onclick    => IG::JsConfirm($lang{are_you_sure}),
                          privilege  => $folder ne 'TRASH',
                          link       => "webmail?".
				"messageaftermove=1&amp;".
				"message_id=". MkUrl($messageaftermove)."&amp;".
				"pos=$on{pos}&amp;".
				"order=$on{order}&amp;".
				"views=$on{views}&amp;".
				"tags=$on{tags}&amp;".
				"folder=$escapedfolder&amp;".
				"message_ids=$escapedmessageid&amp;".
				"action=messageaction&amp;".
				"actiontarget=folder:TRASH",
                          quick_help => $lang{delete_message} )
		)]
	      );
        PrOut "</td><td style=\"vertical-align:bottom;\">";


        ## Next and prev message
        HLayer (
		( $msg{prev}
		  ? Img( src   => "$IG::img_url/left.gif",
		         width => 16,
		         height=> 16,
			 align => "absmiddle",
                         href  => "$base_url_noid&amp;".
                                      "action=readmessage&amp;".
                                      "headers=$on{headers}&amp;".
                                      "message_id=". MkUrl($msg{prev}) )

		  : Img( src   => "$IG::img_url/left-grey.gif",
		         width => 16,
		         height=> 16,
                         align => "absmiddle" )
	        ),

		$msg{number},

		( $msg{next}
		  ? Img( src   => "$IG::img_url/right.gif",
		         align => "absmiddle",
		         width => 16,
		         height=> 16,
                         href  => "$base_url_noid&amp;".
                                      "action=readmessage&amp;".
                                      "headers=$on{headers}&amp;".
                                      "message_id=". MkUrl($msg{next}) )

		  : Img( src   => "$IG::img_url/right-grey.gif",
		         width => 16,
		         height=> 16,
                         align => "absmiddle" )
		)
	       );

        PrOut "</td><td align=\"right\">";

        FormHead(	name=>'moveform',
			float=>'right',
			enctype=>'application/x-www-form-urlencoded',
			cgiaction=>'messageaction');
        _set_hiddens();

        Input (		name=>'message_ids',
			value=>$on{message_id},
		  	override=>1,
			type=>'hidden');

        if ($messageaftermove)
         {
  	  Input ( name=>'messageaftermove',
		  value=>1,
		  type=>'hidden');

	  Input ( name=>'message_id',
		  value=>$messageaftermove,
		  override=>1,
		  type=>'hidden');
         }

        Input (	name=>'actiontarget',
		style=>'font-size:10px; width:200px;',
		data=>_get_action_items(),
		onchange=>'submit();',
		zerovalue=>'true',
		value=>'',
		override=>1,
		type=>'select');

        FormFoot();

        PrOut '</td></tr>';
       }
      else
       {
        ## In case of printable version
        $lang{simplehead} = $lang{allhead} = '';
       }
      PrOut "</table>\n";



      #######################################################
      ## Mk message header
      my $_body_part_description = $lang{ ( 'html_version',
                                            'text_version' )[$on{html_ok}] };
      my $_body_part_change_link = $on{print}
                                 ? ''
                                 : ( "<a href=\"$base_url&amp;".
                                             "action=readmessage&amp;".
                                             "html_ok=".($on{html_ok} ? 0 : 1).
                                             "\">".
                                     $_body_part_description.
                                     "</a>".
                                     ( $on{html_ok}
                                       ? "<span onclick=\"\$('html_body_msg').style.width='auto';".
                                                         "\$('email_message_container').style.width='auto';".
                                                         "\$('change_link').style.display='none';\"".
                                              " style=\"cursor:pointer\"".
                                              " title=\"All width\">".
                                         " | &gt;&gt;&gt;</span>"
                                       : '')
                                   );

      if ($on{headers} eq 'all')
       {
        ## Draw a complete message header
        $msg{header} = _decode($msg{header}, 'mimewords');
        $msg{header} = IG::WebMail::TextMsgBeautify($msg{header});
        $msg{header} =~ s/\n([-\w]+?:)(.+)/\n<strong>$1<\/strong>$2/g;
        $msg{header} =  "<div style=\"margin:2px 2px -10px 2px; float:right; font-size:10px; background-color:$IG::clr{bg_list}\">".
			"<a href=\"$base_url&amp;action=readmessage&amp;headers=simple\">".
			"$lang{simplehead}</a></div>".
			"<div style=\"padding:5px\">$msg{header}</div>\n";
       }
      else
       {
        ## Draw a simple message header
        $msg{header} =  "<div style=\"margin:2px 2px -10px 2px; float:right; font-size:10px; background-color:$IG::clr{bg_list}\">".
			"<a href=\"$base_url&amp;action=readmessage&amp;headers=all\">".
			"$lang{allhead}</a></div>".
			"<div style=\"margin: 5px -5px 5px 5px;\">".
			"<table width=\"640\">";
        if ($msg{contactname})
         {
          $msg{header} .= "<td class=\"list\" width=130>".
			  "<strong>$lang{protocol_number}:</strong>".
			  "</td><td>$msg{protocolid} ".
			  Img( title => $lang{mark_by_igmsg},
			       align => 'absmiddle',
			       width => 16,
			       class => 'noprint',
                               src   => "$IG::img_url/comment_edit.gif",
                               href  => "javascript:winPopUp(".
                                              "'isms?".
                                              "action=composemessage&amp;".
                                              "id=$msg{protocolid}&amp;".
                                              "onsend=close&amp;".
                                              "text_msg=$msg{protocolid}".
                                              "',500,220,'composemessage')" ).
		          ( CheckPrivilege('sys_log_view')
		            ? Img( title => $lang{system_log},
                                   align => 'absmiddle',
		                   width => 16,
		                   class => 'noprint',
		                   src   => "$IG::img_url/history.gif",
 		                   href  => "system_log?".
		                            "action=findexec&amp;".
		                            "fastfind=1&amp;".
		                            "keytofind=$msg{protocolid}" )
                            : '' ).
			  "</td></tr>".
			  "<td class=\"list\" width=130>".
			  "<strong>$lang{contact}:</strong>".
			  "</td><td><a href=\"contacts?action=showrecord&amp;contactid=$msg{contactid}\">$msg{contactid} $msg{contactname}</a></td></tr>";
         }

        if ($msg{organization} && !$msg{contactname} )
         {
          $msg{header} .= "<td class=\"list\" width=130>".
			  "<strong>$lang{company}:</strong>".
			  "</td><td>$msg{organization}</td></tr>\n";
         }

        $msg{header} .= " <td class=\"list\" width=130>
				<strong>$lang{from}:</strong>
				</td><td>$from</td></tr>
			  <td class=\"list\" width=130>
				<strong>$lang{to}:</strong>
				</td><td>$to</td></tr>
			  <td class=\"list\" width=130>
				<strong>$lang{date}:</strong>
				</td><td>$msg{date} $msg{time}</td></tr>\n";

        if ($cc)
         {
	  $msg{header} .= "<td class=\"list\" width=130>
				<strong>$lang{cc}:</strong>
				</td><td>$cc</td></tr>\n";
         }

        ## email tags
        $msg{header} .= "<td class=\"list\" width=130>
				<strong>Tags:</strong>
				</td><td><div id=\"tags_div\">".
			_tags_div().
			"</div></td></tr>\n"
                     if $on{print} || $not_limited_view;

        ## Message notification
        $msg{header} .= "<td class=\"list\" width=130>
				<strong>$lang{notify}:</strong>
			 </td><td><strong>$lang{message_notified}</strong> ".
			 Img(	src   => "$IG::img_url/email_receipt.png",
			        width => 16,
			        align => 'top',
			        title => $lang{message_notified} ).
			 "</td></tr>\n" if $msg{status} =~ /n/;

        ## share mode
        if ( $not_limited_view )
	 {
          $msg{header} .= "<tr><td class=\"list\" width=130>
                                  <strong><span style=\"font-size:10px\">
                                  $lang{share_mode}</span>:</strong>
                           </td><td><div id=\"sharemode_div\">".
                           _sharemode_div($msg{sharemode}).
                           "</div></td></tr>";
         }

        $msg{header} .= "</table></div>";
       }

      $msg{header} .= "<hr>" if $on{print};


      #######################################################
      ## SHOW MESSAGE
      my $subject = MkEntities( $msg{subject} );
      
      ## thread view
      my $threads_tree =    $IG::tema ne 'printable_'
                         && $on{owner} eq $auth_user
                         && IG::ConfigParam('webmail.thread')
                       ? _build_thread( $msg{threadid}, $msg{originalid} )
                       : '';

      my $msgBodyOverflowXStyle = $on{print}
                                  ? ''
                                  : 'overflow-x:auto; overflow-y:visible;';

      PrOut <<HTMLEND;
<div style="width:670px; background-color:$IG::clr{bg_link}; 
            border: 1px solid black" id="email_message_container">

 <div style="border-bottom:1px solid black; width:100%;
             background-color:$IG::clr{bg_menu_task}">
  <div style="padding:3px; color:$IG::clr{bg_task}; font-weight:bold;">
   $lang{subject}: $subject
  </div>
 </div>	

 <div style="width:100%; background-color:$IG::clr{bg_link}">
  $msg{header}
  $threads_tree
 </div>

 <div style="background-color:#FFFFFF; display:block;">

  <table border=0 cellspacing=0 cellpadding=0>
   <td>

    <div style="font-size:10px; background-color:$IG::clr{bg_list};
                margin:2px 2px -10px 0; padding:1px; width:auto;
                float:right; clear:both;" id="change_link">$_body_part_change_link</div>

    <div id="html_body_msg"
         style="padding:15px 10px; $msgBodyOverflowXStyle width:650px;">
     <!-- START MESSAGE BODY -->
      $msg{html}
     <!-- END MESSAGE BODY -->
    </div>
   </td>
  </table>

  <table width="100%" style="background-color:$IG::clr{bg_link};">
    <tr><td valign="top">$msg{atthtml}</td></tr>
  </table>

 </div>
</div>
HTMLEND
    } 
   else
    {
     ## Inaccessible message
     IG::Warn( $lang{Err_no_email_msg} );
     return;
    }

   TaskFoot(	comments       => 'yes',
		commentid      => "$on{owner}_$on{message_id}",
		commentowner   => $on{owner},
                commentwidth   => '695px',
		commentbackurl => "action=readmessage&amp;".
		                  "owner=$on{owner}&amp;".
				  "message_id=$on{message_id}");
   HtmlFoot();

   LogD( $msg{contactname},
	 'view',
	 'email_msgs',
	 $msg{protocolid} ) if $msg{protocolid};
 }

###############################################################################
###############################################################################
sub _sharemode_div
 {
  my $value = shift;
  return Input( type     => 'select',
                name     => 'sharemode',
                output   => 'onlyfield',
	        onchange => "this.style.background='#ff6600';".
	                    "setsharemode(".
	                             "['sharemode__' + getVal('sharemode')],".
	                             "['sharemode_div']); return true;",
                style    => 'font-size:10px',
                value    => $value,
                data     => [([ 0, $lang{share_mode0} ],
                              [ 1, $lang{share_mode1} ],
                              [ 2, $lang{share_mode2} ])] );
 }

###############################################################################
###############################################################################
sub _build_thread
 {
  my ($threadid, $originalid) = @_;
  return if !$threadid;
  require IG::EmailAbstract;
  my $abstract = new Email::Abstract ( root_id => $threadid );

  my @thread_msgs = $abstract->get_msgs();
  return if $#thread_msgs < 1;

  require IG::MailThread;
  my $threader = new Mail::Thread( @thread_msgs );
  $threader->thread;
  
  my $html = "<div id=\"threads_box\" style=\"border-top:1px solid #999999; background:$IG::clr{bg_list};".
             " font-size: 10px; border-bottom:1px solid #999999;width:100%; height:130px;".
             " overflow:auto;\">Thread:<div style=\"width:640px; padding:5px 0 0 5px;\">

              <script src=\"filemanager?action=getfuncmenu\"></script>
              <script>
              STARTALLOPEN = 1;
              USEFRAMES = 0;
              USEICONS = 0;\n";
                      
  $html .= dump_em($_, $abstract, 0, $originalid) for $threader->rootset;
 
  $html .= <<END;

function openThisDir(linkID)
 {
        var folderObj;
        docObj = findObjLink(linkID);
        if (typeof docObj=='undefined' || docObj==null) return;
        clickOnNodeObj(docObj);
        docObj.forceOpeningOfAncestorFolders();
        //parent.treeframe.clickOnLink(docObj.id,docObj.link,'basefrm');
        //if (typeof parent.treeframe.document.body != "undefined")
        //      parent.treeframe.document.body.scrollTop=docObj.navObj.offsetTop
}

initializeDocument();
openThisDir('link');
</script>
<noscript>
A tree for files navigation will open here if you enable JavaScript in your browser.
</noscript>
</div></div>
END

  return $html;
 }

sub dump_em
 {
  my ($self, $abstract, $level, $originalid) = @_;
  my $html;

  if ($self->message)
   {
    my $item   = MkEntities($abstract->get_branch($self->message));
    my $style;
       $style  = 'text-decoration:underline;'
                  if $self->message eq $originalid;
       $style .= 'font-weight:bold;'
                  if $abstract->get_header($self->message, 'status') !~ /r/i;
       $style  = " style=\\\"$style\\\"";

    my $lnk = "webmail?".
              "action=readmessage&amp;".
              "message_id=". MkUrl($abstract->get_header($self->message,'id')).
              "&amp;pos=$on{pos}&amp;".
              "owner=$on{owner}&amp;".
              "views=$on{views}&amp;".
              "tags=$on{tags}&amp;".
              "folder=$on{folder}&amp;".
              "order=$on{order}&amp;".
              "headers=$on{header}";

    if ($level==0)
     {
      $html .= "foldersTree = ".
               "gFld(\"<div$style>$item</div>\",\"$lnk\")\n";
     }
    elsif ($level==1)
     {
      $html .= "aux1 = insFld(foldersTree, ".
               "gFld(\"<div$style>$item</div>\", \"$lnk\"))\n";
     }
    else
     {
      $html .= "aux" .
               $level.
               " = insFld(aux".($level-1).", ".
               "gFld(\"<div$style>$item</div>\", \"$lnk\"))\n";
     }
   }
  else
   {
    ## Message $self not available
    my $item   = 'Missing message: id=' . MkEntities( $self->messageid );
    my $style  = ' style=\\"color:#999999;\\"';
    my $lnk    = '';
               
    if ($level==0)
     {
      $html .= "foldersTree = ".
               "gFld(\"<div$style>$item</div>\",\"$lnk\")\n";
     }
    elsif ($level==1)
     {
      $html .= "aux1 = insFld(foldersTree, ".
               "gFld(\"<div$style>$item</div>\", \"$lnk\"))\n";
     }
    else
     {
      $html .= "aux" .
               $level.
               " = insFld(aux".($level-1).", ".
               "gFld(\"<div$style>$item</div>\", \"$lnk\"))\n";
     }
   }

  $html .= dump_em( $self->child, $abstract, $level+1, $originalid )
             if $self->child;
  $html .= dump_em( $self->next, $abstract, $level, $originalid )
             if $self->next;
  
  return $html;
 }
 

###############################################################################
############################################################################### 
sub _tags_div
 {
  my $_tag_flag;
  my $html = "<div style=\"float:left; font-size:10px;\">";

  DbQuery("select email_msgtags.id, email_msgtags.name ".
          "from email_msgtags ".
	  "where email_msgtags.msgid='".DbQuote($on{message_id})."' ".
	  "order by email_msgtags.name");

  while (my ($tag_id, $tag_name) = FetchRow())
   {
    $_tag_flag++;
    $html .= "<a href=\"webmail?pos=$on{pos}&amp;".
			"views=$on{views}&amp;".
			"tags=$tag_name&amp;".
			"folder=$on{folder}&amp;".
			"action=displayheaders\">$tag_name</a>";
			
    $html .= $on{print}
           ? " - "
           : Img(	src   => "$IG::img_url/delete.gif",
                        width => 16,
			href  => "JavaScript:deltag(['tagid__$tag_id'],".
			                           "['tags_div']);",
			align => 'absmiddle'). " ";
   }

  $html .= "</div>".
           Input(       name     => 'tagname2',
			type     => 'select',
			zerovalue=> 'true',
			data     => IG::WebMail::GetTags(),
			float    => 'left',
			style    => ( $_tag_flag ? "margin-left:3px;" : '').
			            " border:0; font-size:10px; width:100px; height:15px; background-color:$IG::clr{bg_list}",
			onchange => "this.style.background='#ff6600';".
			            "addtag(['tagname__'+this.options[this.selectedIndex].value],".
				           "['tags_div']);".
				    "return true;"
		).
	   Input(	type=>'text',
			name=>'tagname',
			value=>'', 
			override=>1,
			float=>'left',
			style=>"margin-left:5px; border:0;font-size:10px;width:50px; height:15px; background-color:$IG::clr{bg_list}",
		).
	   Input(	type=>'button',
			value=>'+',
			float=>'left',
			onclick=>"addtag(['tagname__' + getVal('tagname')],['tags_div']); return true;",
			style=>'font-size:13px; width:10px; height:15px')
           if !$on{print};
  return $html;
 }

###############################################################################
###############################################################################
sub addtag
 {
  HttpHead( expires => 'now' );
  QuoteParams();
  for (split / /, $on{tagname})
   {
    s/[^\w\d\_\-\.]//g;
    next unless $_;
    my $tagid   = MkId(32);
    my $tagname = uc(DbQuote($_));
    DbQuery( query=> [( "delete from email_msgtags ".
	                "where msgid='$in{message_id}' and name='$tagname'",
	                
	                "insert into email_msgtags values".
	                " ('$tagid', '$in{message_id}', '$tagname')"
                      )] ); 
   }
  PrOut _tags_div();
 }

###############################################################################
###############################################################################
sub deltag
 {
  HttpHead( expires => 'now' );
  QuoteParams();
  DbQuery("delete from email_msgtags where id='$in{tagid}'");
  PrOut _tags_div();
 }

###############################################################################
###############################################################################
sub _get_threadid
 {
  my ($msg_subject, $msg_references) = @_;
  my $threadid;

  ## first find original threadid by References
  if ( $msg_references )
   {
    for my $id ( $msg_references =~ /(<[^\@<>]+\@[^\@<>]+>)/g )
     {
      next if !$id;
      $id = DbQuote($id);
      DbQuery("select threadid from email_msgs ".
              "where originalid='$id'");
      $threadid = FetchRow();
      last if $threadid;
     }
   }

  ## next try to use subject but only if it starts with Re:
  if ( !$threadid && $msg_subject =~ /^re(\[\d+\])*\:\s*.+/i )
   {
    1 while $msg_subject =~ s/^re(\[\d+\])*\:\s*//gi;
    $msg_subject = DbQuote($msg_subject);
    DbQuery("select threadid from email_msgs ".
            "where subject='$msg_subject' ".
            "order by issue desc limit 1");
    $threadid = FetchRow();
   }

  ## It's a new threadid or we can't find original threadid
  $threadid ||= IG::MkId(100);
  return $threadid;
 }

###############################################################################
###############################################################################
sub setsharemode
 {
  HttpHead( expires => 'now' );

  if ( $on{message_id} && $on{sharemode} =~ /^[012]$/ )
   {
    QuoteParams();
    DbQuery("update email_msgs ".
            "set sharemode=$in{sharemode} ".
            "where id='$in{message_id}' and owner='$auth_user'");
   }

  PrOut _sharemode_div($on{sharemode});
 }

###############################################################################
###############################################################################
sub parse_message
 {
  my %data = @_;
  my $username  = $data{owner};
  my $message   = $data{message};
  my $messageid = $data{id};
  my @attachment;
  my %msg;

  my ($header, $body) = split_message(  ($messageid || \$message),
					$username );
  return %msg if !$header;

  ## Parse message header
  %msg = _parse_headpart( $header );

  ## Store header and body parts
  $msg{header} = $header;
  $msg{body}   = $body;

  ## If message is stored inside database we want retrieve other values
  if ($messageid)
   {
    ## Retrieve some other needed values from database
    ## we want override *email_msgs.status* with database stored value
    DbQuery("select email_msgs.status, email_msgs.sharemode, email_msgs.contactid,".
	    " contacts.contactname, email_msgs.pid, email_msgs.folder,".
	    " email_msgs.threadid ".
	    "from email_msgs left join contacts ".
	    "on email_msgs.contactid = contacts.contactid ".
	    "where email_msgs.id='$messageid' and email_msgs.owner='$username'");
 
    (	$msg{status},
	$msg{sharemode},
	$msg{contactid},
	$msg{contactname},
	$msg{protocolid},
	$msg{folder},
	$msg{threadid} ) = FetchRow();

    ## User don't have privileges
    return if $username ne $auth_user && $msg{sharemode} != 1;

    ## Search sequential message's number and previous and next message IDs.
    my $query = "email_msgs.owner='$username'".
		( $folder ne 'all' ? " and email_msgs.folder='$folder'" : "").
		" and email_msgs.sender<>'' ".
		(   $on{views} eq 'read'      ? "and email_msgs.status~*'r' "
		  : $on{views} eq 'unread'    ? "and not (email_msgs.status~*'r') "
		  : $on{views} eq 'replied'   ? "and email_msgs.status~*'e' "
		  : $on{views} eq 'unreplied' ? "and not (email_msgs.status~*'e') "
		  : '' );

    QuoteParams();
    DbQuery("select email_msgs.id ".
            ( $on{tags} && $on{tags} ne 'all'
	      ? "from email_msgtags ".
	        "left join email_msgs on email_msgs.id = email_msgtags.msgid ".
	        "where email_msgtags.name = '$in{tags}'".
	        " and $query" 

	      : "from email_msgs where $query " ).

	    "order by email_msgs.$in{order} $in{sortdirection},".
	    " email_msgs.timeissue $in{sortdirection}");

    while (my @row = FetchRow())
     {
      $msg{number}++;
      if ($row[0] eq $messageid)
       {
        $msg{next} = FetchRow();
        last;
       }
      $msg{prev} = $row[0];
     }
   }


  ## Parse body part
  if ( $msg{contenttype} =~ /^multipart/i )
   { 
    ## it's a multipart message

    (	$msg{html},
	$msg{atthtml},
	$msg{rawtext},
	@attachment ) = _parse_multipart( $msg{body},
					  $msg{contenttype},
					  0,
					  $data{html_ok} );

    ## Try to link image to html content by CID or LOCATION system
    for my $attnumber ( 0 .. $#attachment )
     {
      next if $attachment[$attnumber]{contenttype} !~ /image/;
      my $tag;

      if ( $attachment[$attnumber]{cid} )
       {
        $attachment[$attnumber]{cid} =~ s/<([^>]+)>/$1/;
        $tag = "cid:$attachment[$attnumber]{cid}";
       }
      elsif ( $attachment[$attnumber]{location} )
       {
        $tag = "\"$attachment[$attnumber]{location}\"";      
       }

      $msg{html} =~ s/\Q$tag\E
		     /"webmail?".
			"action=viewattachment&amp;".
			"message_id=". MkUrl($messageid). "&amp;".
			"attnum=$attachment[$attnumber]{attnum}&amp;".
			"owner=$on{owner}"
		     /gxe if $tag;
     }
   } 
  elsif ( $msg{contenttype} &&
	  $msg{contenttype} ne 'N/A' &&
	  $msg{contenttype} !~ /^text/i )
   {
    ## It's a single attach without an html or text body

    my %temphash;
    $temphash{filename}		= $msg{filename};
    $temphash{contenttype}	= $msg{contenttype} || 'text/plain';
    $temphash{encoding}		= $msg{encoding};
    $temphash{contents}		= $msg{body};

    $msg{body}			= 'No body message';
    $msg{rawtext}		= '';
    $msg{html}                  = '';
    $attachment[0]		= \%temphash;

    ## convert body to an attachment
    $msg{atthtml}
      .= _mk_attach_icon
	   (    filename    => $temphash{filename},
		contenttype => $temphash{contenttype},
		encoding    => $temphash{encoding},
		size	    => IG::MkByte(length($temphash{contents})),
		attnum      => 0,
		messageid   => $messageid );
   }
  else
   {
    ## It's an html or plain text message without attachments
    ## or something similar
    require IG::Utils;

    if ( $msg{contenttype} =~ /^text\/html/i )
     {
      ## It's an HTML Message
      $msg{html}    = _decode( $msg{body}, $msg{encoding}, $msg{contenttype} );

      ## sanitize message
      $msg{html}    = IG::WebMail::SanitizeHtml( $msg{html} );

      ## Untag message for raw text part
      $msg{rawtext} = _text_msg_autoformat( IG::HtmlUntag( $msg{html} ) );

      ## convert html to text if user wants only text
      $msg{html}    = IG::WebMail::TextMsgBeautify( $msg{rawtext} )
                      if ! $data{html_ok};
     }
    else
     {
      ## It Should be just a Text Plain
      $msg{rawtext} = _decode( $msg{body}, $msg{encoding}, $msg{contenttype} );
      $msg{html}    = IG::WebMail::TextMsgBeautify( $msg{rawtext} );

      if ( IG::ConfigParam('webmail.fixed_font') )
       {
        ## Fixed font
        $msg{html} = "<pre>$msg{html}</pre>";
       }
     }
   }

  ## adjust some values
  $msg{messageid}	 = $messageid;
  $msg{attachment}	 = \@attachment;
     
  return %msg;
 }

######################################################################
######################################################################
sub _parse_multipart
 {
  my ( $msg_body, $msg_type, $msg_attnum, $html_ok ) = @_;
  my ( $msg_html, $msg_rawtext, $msg_atthtml, @msg_attachments );
  my $escapedmessageid = MkUrl( $on{message_id} );
 
  ## find message boundary string
  my $boundary = $msg_type;
     $boundary =~ s/.*boundary=\"?([^\"\;]+)\"?.*$/$1/si;
     $boundary =~ s/[\s|\r|\n]+$//;

  ## when we have a multipart content but not a valid boundary
  ## what happen? we treat body as unique attachment
  $boundary ||= 'unknow';

  ## split all attachments parts
  my @attachments;
  ($msg_body, @attachments) = split( /\-\-\Q$boundary\E\n*/, $msg_body );

  ## parse and store attachments header values
  foreach my $bound ( 0 .. $#attachments )
   {
    my %temphash;

    ## split attachment body from header
    my ($att_header, $att_body) = split(/\n\r*\n/, $attachments[$bound], 2);
       ($att_header, $att_body) = _split_bad_mime_header($attachments[$bound]) 
                                  if !$att_header || !$att_body;

    next if !$att_header; #XXX2TEST

    ## read values from header part
    my %att = _parse_headpart( $att_header );

    ## adjust some values
    $att{contenttype}	||= 'text/plain';
    $att{header}	  = _decode($att_header, 'mimewords');
    $att{contents}	  = $att_body;
    $att{attnum}	  = $msg_attnum++;

    push @msg_attachments, \%att;
   }

  ## create html to show and rawtext of body message
  if ( $msg_type =~ /^multipart\/alternative/i )
   {
    ## MULTIPART ALTERNATIVE
    require IG::Utils;
    my ($html_output, $text_output);

    ## find text and html part (normally in alternative multipart we
    ## should have 1 html part and 1 text part)
    for my $attnumber ( 0 .. $#msg_attachments )
     {
      ## this is a nested multipart
      if ( $msg_attachments[$attnumber]{contenttype} =~ /^multipart/i )
       { 
        my ( $in_html,
	     $in_atthtml,
	     $in_rawtext,
	     @in_attachments
           ) = _parse_multipart( $msg_attachments[$attnumber]{contents},
                                 $msg_attachments[$attnumber]{contenttype},
                                 $msg_attnum,
                                 $html_ok );
        $msg_html    .= $in_html;
	$msg_atthtml .= $in_atthtml;
	$msg_rawtext .= $in_rawtext;
        push @msg_attachments, @in_attachments;
	next;
       }
      
      if ( $msg_attachments[$attnumber]{disposition} =~ /attachment/i ) 
       {
        ## This is an attachment. Show an icon per attached file
	$msg_atthtml
	  .= _mk_attach_icon
	     (  filename    => $msg_attachments[$attnumber]{filename},
		contenttype => $msg_attachments[$attnumber]{contenttype},
		encoding    => $msg_attachments[$attnumber]{encoding},
		size	    => IG::MkByte(length($msg_attachments[$attnumber]{contents})),
		attnum      => $msg_attachments[$attnumber]{attnum},
		messageid   => $on{message_id} );
        next;
       }

      if    (    $msg_attachments[$attnumber]{contenttype} =~ /^text\/html/i
              && !$html_output )
       {
        $html_output = _decode( $msg_attachments[$attnumber]{contents},
                                $msg_attachments[$attnumber]{encoding},
                                $msg_attachments[$attnumber]{contenttype} );
       }
      elsif (    $msg_attachments[$attnumber]{contenttype} =~ /^text\/plain/i
              && !$text_output )
       {
        $text_output = _decode( $msg_attachments[$attnumber]{contents},
                                $msg_attachments[$attnumber]{encoding},
                                $msg_attachments[$attnumber]{contenttype} );
       }
     }

    ## choose html or text according to user preferences and parts content
    if ( $html_ok )
     {
      if ( $html_output )
       {
        ## User wants html and we have got it
        $msg_html    = IG::WebMail::SanitizeHtml( $html_output );
        $msg_rawtext =    !$text_output
                       || $text_output =~ /Your email client does not support HTML messages/i
                     ? _text_msg_autoformat( IG::HtmlUntag($msg_html) )
                     : IG::CkHtml( $text_output )
                       ? _text_msg_autoformat( IG::HtmlUntag( $text_output ) )
                       : _text_msg_autoformat( $text_output );
       }
      else
       {
        ## User wants html but we haven't got it so we will use text part
        $msg_rawtext = $text_output;
        $msg_html    = IG::WebMail::TextMsgBeautify
                        ( _text_msg_autoformat( $msg_rawtext ) );
       }
     }
    else
     {
      ## User doesn't want use html parts so we will use text part or
      ## convert an html one
      if (   !$text_output
           || $text_output =~ /Your email client does not support HTML messages/i
         )
       {
        ## It's a multipart/alternative but text part it's empty so we use html
        $text_output = _text_msg_autoformat( IG::HtmlUntag( $html_output ) );
       }
      else
       {
        ## generally text part in a multipart/alternative has a bud format 
        ## and some time it's an html content too so we will use
        ## HtmlUntag and  _text_msg_autoformat()
        $text_output = _text_msg_autoformat( IG::HtmlUntag( $text_output ) );
       }

      $msg_html    = IG::WebMail::TextMsgBeautify( $text_output );
      $msg_rawtext = $text_output;
     }
   }
  elsif ($msg_type =~ /multipart\/+
                       (appledouble
                       |mixed
                       |parallel
                       |digest
                       |related
                       |signed
                       |report
                       |relative
                       )/xi
        )
   {
    ## GENERIC MULTIPART
    for my $attnumber (0 .. $#msg_attachments)
     {
      ## this is a nested multipart
      if ( $msg_attachments[$attnumber]{contenttype} =~ /^multipart/i )
       { 
        my ( $in_html,
	     $in_atthtml,
	     $in_rawtext,
	     @in_attachments
           ) = _parse_multipart( $msg_attachments[$attnumber]{contents},
                                 $msg_attachments[$attnumber]{contenttype},
                                 $msg_attnum,
                                 $html_ok );
        $msg_html    .= $in_html;
	$msg_atthtml .= $in_atthtml;
	$msg_rawtext .= $in_rawtext;
        push @msg_attachments, @in_attachments;
       }
      elsif (    $msg_attachments[$attnumber]{contenttype} =~ /text\/html/i
              && $msg_attachments[$attnumber]{disposition} !~ /attachment/i
	    )
       {
        ## it's an html part and it should be viewed (it's not an attachment)
        require IG::Utils;

        my $html_temp = _decode($msg_attachments[$attnumber]{contents},
				$msg_attachments[$attnumber]{encoding},
				$msg_attachments[$attnumber]{contenttype} );

        $msg_html    .= $html_ok
                      ? IG::WebMail::SanitizeHtml( $html_temp )
                      : IG::WebMail::TextMsgBeautify
                         ( _text_msg_autoformat
                           ( IG::HtmlUntag( $html_temp ) ) );

        ## convert html to reformatted text plain
        $msg_rawtext .= _text_msg_autoformat( IG::HtmlUntag($html_temp) );
       }
      elsif (    $msg_attachments[$attnumber]{contenttype} =~ /text\/plain/i 
              && $msg_attachments[$attnumber]{disposition} !~ /attachment/i
            )
       {
        ## it's a text file and it's not an attachment
        my $text_temp = _decode($msg_attachments[$attnumber]{contents},
				$msg_attachments[$attnumber]{encoding},
				$msg_attachments[$attnumber]{contenttype} );

        $msg_html    .= IG::WebMail::TextMsgBeautify( $text_temp );
        $msg_rawtext .= $text_temp;
       }
      elsif (    $msg_attachments[$attnumber]{contenttype} =~ /image\/(png|gif|jpg|pjpeg)/
	      && $msg_attachments[$attnumber]{disposition} =~ /inline/
	      && !$msg_attachments[$attnumber]{cid}
	      && !$msg_attachments[$attnumber]{location}
	    )
       {
        ## it's an inline image
        $msg_html .= Img( src=> "webmail?".
				"action=viewattachment&amp;".
				"message_id=$escapedmessageid&amp;".
				"attnum=$msg_attachments[$attnumber]{attnum}&amp;".
				"owner=$on{owner}" );
       }
      else
       {
        ## This is an attachment. Show an icon per attached file
	$msg_atthtml
	  .= _mk_attach_icon
	     (  filename    => $msg_attachments[$attnumber]{filename},
		contenttype => $msg_attachments[$attnumber]{contenttype},
		encoding    => $msg_attachments[$attnumber]{encoding},
		size	    => IG::MkByte(length($msg_attachments[$attnumber]{contents})),
		attnum      => $msg_attachments[$attnumber]{attnum},
		messageid   => $on{message_id} );
       }
     }
   }
  else
   {
    ## UNKNOWN CONTENT TYPE
    die("What else content type? Please if you can forward this message to ".
	"IGSuite staff.\n[$msg_type]\n");
   }

  return ($msg_html, $msg_atthtml, $msg_rawtext, @msg_attachments);
 }

######################################################################
######################################################################
=head 3 _split_bad_mime_header()
 
 try to split a bad formatted MIME header/content 
 (when the empty line is missing).
 Inspired to mpack/umpack decode.c ParseHeaders()

=cut
sub _split_bad_mime_header
 {
  my $part = shift;
  
  my $p1 = 0;
  while( (my $p2 = index( $part, "\n", $p1 )) >= 0 ) 
   {
    my $firstChar = substr( $part, $p1, 1 );
    
    return (substr($part,0,$p1), substr($part,$p1))
         if $firstChar ne ' ' && 
            $firstChar ne "\t" && 
	    index( substr( $part, $p1, $p2-$p1 ), ':' ) < 0;
    $p1 = $p2+1;
   }
  return (undef,undef);
 }

###############################################################################
###############################################################################
sub _mk_attach_icon
 {
  require IG::Utils;
  
  ## Show an icon per attached file
  my %data = @_;

  my $escapedmessageid = MkUrl ( $data{messageid} );

  ## adjust filename value
  my $escapedfilename = $data{filename};
  $escapedfilename =~ s/[^\(\)\^\[\]\#\@\:\;\Â°\,\.\s\+\=\-\_\'a-zA-Z0-9]/\_/g;
  1 while $escapedfilename =~ s/\_{2,}/\_/g;
  $escapedfilename = MkUrl($escapedfilename);

  if ($data{filename} =~ /\.(zip|scr|exe|com|pif)$/i)
   {
    $data{filename} .= Blush(" (Probable Virus, check it before open!!!)");
   }
  $data{filename} = IG::WrapText( text=>$data{filename}, columns=>25 );

  $data{contenttype} =~ /^([^;]+)/g;
  $data{contenttype} = lc($1) || 'text/plain';

  my $alt = MkTable( style_c1_r  => 'vertical-align:top; font-weight:bolder; white-space:nowrap',
                     values      => [( ["$lang{filename} : ",
                                        $data{filename}],
                                       ["$lang{type} : ",
                                        $data{contenttype}],
                                       #["$lang{encoding} : ",
                                       # ( $data{encoding} || 'none' )],
                                       ["$lang{size} : ",
                                        $data{size}] )] );

  my $html .= "<div class=\"fileicon\">".

	      IG::QuickHelp
              ( alt    => $alt,
		id     => "att$data{attnum}",
		width  => '250px',
		anchor => Img( src   => "$IG::img_url/mime_attach.gif",
		               width => 32 ).
		          IG::TextElide( string => "<br>$data{filename}",
		                         length => 40 ), 
		href   => "webmail/$escapedfilename?".
		                "action=viewattachment&amp;".
				"message_id=$escapedmessageid&amp;".
				"attnum=$data{attnum}&amp;".
				"igsuiteid=$IG::cookie{igsuiteid}&amp;".
				"owner=$on{owner}").

              ( CheckPrivilege('archive_edit') && $data{filename} =~ /\.\w+$/
		? "<a href=\"webmail?".
				"action=archiveattach&amp;".
				"message_id=$escapedmessageid&amp;".
				"attnum=$data{attnum}&amp;".
				"owner=$on{owner}".
	          "\" style=\"display:block;margin-top:4px;color:gray;\">".
	          Img( src   => "$IG::img_url/plus.gif",
	               style => 'width:9px; margin-right:2px;' ).
	          "$lang{archive}</a>"
		: '' ).

	      '</div>';

  return $html;
 }

###############################################################################
###############################################################################
sub _parse_headpart
 {
  my $header = shift;
  my $lastline = 'NONE';
  my %hval;

  my %month = qw(Jan 1 Feb 2 Mar 3 Apr 4  May 5  Jun 6
		 Jul 7 Aug 8 Sep 9 Oct 10 Nov 11 Dec 12);

  foreach ( split(/\n/, $header) )
   {
    if ( /^(\s|\t)/ )
     {
      next if $lastline eq 'NONE';
      $hval{$lastline} .= $_;
     }
    elsif ( /^date:\s*(.+)$/ig )
     {
      $hval{date} = $1;
      $lastline = 'date';
     }
    elsif ( /^subject:\s*(.+)$/ig )
     {
      $hval{subject} = $1;
      $lastline = 'subject';
     }
    elsif ( /^status:\s*(.+)$/ig )
     {
      $hval{status} = lc($1);
      $hval{status} =~ s/\s//g;
      $lastline = 'NONE';
     }
    elsif ( /^X\-Spam\-(Status|Flag)\:\s*Yes/ig )
     {
      $hval{spamstatus} = 1;
      $lastline = 'NONE';
     }
    elsif ( /^to:\s*(.+)$/ig )
     {
      $hval{to} = $1;
      $lastline = 'to';
     }
    elsif ( /^X\-Original\-To:\s*(.+)$/ig )
     {
      $hval{originalto} = $1;
      $lastline = 'originalto';
     }
    elsif ( /^X\-Priority:\s*(.+)$/ig )
     {
      $hval{priority} = $1;
      $lastline = 'NONE';
     }
    elsif ( /^from:\s*(.+)$/ig )
     {
      $hval{from} = $1;
      $lastline = 'from';
     }
    elsif ( /^reply-to:\s*(.+)$/ig )
     {
      $hval{replyto} = $1;
      $lastline = 'replyto';
     }
    elsif ( /^cc:\s*(.+)$/ig )
     {
      $hval{cc} = $1;
      $lastline = 'cc';
     }
    elsif ( /^content-transfer-encoding:\s*(.+)$/ig )
     {
      $hval{encoding} = $1;
      $lastline = 'encoding';
     }
    elsif ( /^content-type:\s*(.+)$/ig )
     {
      $hval{contenttype} = $1;
      $lastline = 'contenttype';
     }
    elsif ( /^content-disposition:\s*(.+)$/ig )
     {
      $hval{disposition} = $1;
      $lastline = 'disposition';
     }
    elsif ( /^content-id:\s*(.+)$/ig )
     {
      $hval{cid} = $1;
      $lastline = 'NONE';
     }
    elsif ( /^content-location:\s*(.+)$/ig )
     {
      $hval{location} = $1;
      $lastline = 'NONE';
     }
    elsif ( /^Message-ID:\s*(.+)$/ig )
     {
      $hval{originalid} = $1;
      $lastline = 'NONE';
     }
    elsif ( /^In-Reply-To:\s*(.+)$/ig )
     {
      $hval{inreplyto} = $1;
      $lastline = 'NONE';
     }
    elsif ( /^References:\s*(.+)$/ig )
     {
      $hval{references} = $1;
      $lastline = 'references';
     }
    elsif ( /^organization:\s*(.+)$/ig )
     {
      $hval{organization} = uc($1);
      $lastline = 'organization';
     }
    elsif ( /^(disposition\-notification\-to|
               x\-confirm\-reading\-to|
               return\-receipt\-to)\:\s*(.+)$/xig )
     {
      $hval{notificationto} = $2;
      $lastline = 'NONE';
     }
    else
     {
      $lastline = 'NONE';
     }
   }

  ## Add In-Reply-To to References value
  $hval{references} .= " $hval{inreplyto}"
    if    $hval{inreplyto} =~ /^\S+\@\S+$/
       && (!$hval{references} || $hval{references} !~ /\Q$hval{inreplyto}\E$/);

  ## Use X-Original-To instead if To: if To doesn't exist
  $hval{to} = $hval{originalto} if !$hval{to};  

  ## decode values and suppress '\' & \0
  for my $key (qw( from replyto to cc subject ))
   {
    $hval{$key} = _decode($hval{$key}, 'mimewords');
    $hval{$key} =~ s/\\|\0//g;
    $hval{$key} =~ s/^\s+|\s+$//; ## trim spaces
   }

  ## Find an eventual attach file name
  $hval{filename} = $hval{contenttype};
  unless ($hval{filename} =~ s/^.+name=\"?([^\"\;]+)\"?.*$/$1/ig)
   {
    $hval{filename} = $hval{disposition} || '';
    unless ($hval{filename} =~ s/^.+filename=\"?([^\"\;]+)\"?.*$/$1/ig)
     { $hval{filename} = 'Unnamed'; }
   }
  $hval{filename} = _decode($hval{filename}, 'mimewords');

  ## Find a boundary
  $hval{boundary} = $hval{contenttype};
  $hval{boundary} =~ s/.*boundary=\"?([^\"\;]+)\"?.*$/$1/si;
  chomp( $hval{boundary} );

  ## Find date and time values
  my @datearray = split(/\s+/, $hval{date});
  if ($datearray[0] =~ /[A-Za-z,]/)
   {
    ## Get rid of the day of the week
    shift @datearray;
   }

  if ($datearray[0] =~ /[A-Za-z]/ )
   {
    ## looks like we have a nonstandard date
    @datearray = (    $datearray[1],
                      $datearray[0],
                      $datearray[3],
                      $datearray[2],
                      $tv{time_offset}
                 );
   }

  $hval{date} = IG::GetDateByFormat(	$datearray[0],
					$month{$datearray[1]},
					$datearray[2]);
  $hval{date} = $tv{today} if !CkDate($hval{date});

  $hval{time} = ($datearray[3] || $datearray[4])
                ? substr("$datearray[3] $datearray[4]",0,20)
                : "$tv{time} $tv{time_offset}";

  return %hval;
 }

###############################################################################
###############################################################################
sub split_message
 {
  my ($message_source, $username) = @_;
  my ($buff, $msg_path);

  if ( ref($message_source) )
   {
    ## $message_source is a message (the content)
    $buff = $$message_source;
   }
  else
   {
    ## $message_source is a message_id
    DbQuery("select folder from email_msgs ".
	    "where id='$message_source' and owner='$username'");
    my $message_folder = FetchRow();

    if ( $message_folder )
     {
      ## this is a message stored inside db
      $msg_path = IG::UserDir($username) . $S.
                  "MailBox${S}$message_folder" .  $S.
                  $message_source;
     }
    elsif ( -e "$IG::temp_dir${S}${message_source}.mbx" )
     {
      ## this is a temporary message
      $msg_path = "$IG::temp_dir${S}${message_source}.mbx";
     }
    else
     {
      ## this is an exception
      die("What kind of message_id is this '$message_source'?\n");
     }

    open (SPOOL, '<', $msg_path )
      or die("Can't find message in '$msg_path'.\n");
    $buff .= $_ while <SPOOL>;
    close (SPOOL);
   }

  my ($header, $body) = split(/\n\r*\n/, $buff, 2);
  $header ||= $buff; ## sometime in message without a body
  undef($buff);

  if ( $header =~ /^content-type:\s*message\/rfc822/mi )
   { return( split(/\n\r*\n/, $body, 2) ); }
  else
   { return( $header, $body ); }
 }

###############################################################################
###############################################################################
sub exportmessages
 {
  print STDOUT IG::DocHead( type       => 'message/rfc822',
                            expires    => 'now',
                            attachment => 'igsuite.mbx' );

  my $query;
  if ( $on{message_id} )
   { $query = "id='". DbQuote( $on{message_id} ) ."'"; }
  elsif ( $on{folder} ne 'all' )
   { $query = "folder='". DbQuote( $on{folder} ) ."'"; }
  else
   { $query = '1=1'; }

  DbQuery("select id, folder from email_msgs ".
	  "where owner='$auth_user' and $query ".
	  "order by issue, timeissue");

  while ( my ($message_id, $message_folder) = FetchRow() )
   {
    open( SPOOL, '<', "$IG::user_dir${S}".
                      "MailBox${S}".
                      "$message_folder${S}".
                      "$message_id"
        ) or next;
    binmode(SPOOL);
    binmode(STDOUT);
    print STDOUT $_ while <SPOOL>;
    close (SPOOL);
   }
 }

###############################################################################
###############################################################################
sub default_action { displayheaders() }

###############################################################################
###############################################################################
sub displayheaders
 {
  ## check and redirect some particular views
  displaythreads() && return if $on{views}  eq 'perthread';
  
  HtmlHead( shortcuts => _short_cuts(),
            title     => 'IGWebMail',
            onevent   => $on{recheck}
		      ?  'onload="if (parent.chkmsg && parent.chkmsg.ajaxUpdate) '.
		                   'parent.chkmsg.ajaxUpdate()"'
		      :  '' );

  TaskHead( width     => '100%',
            title     => 'IGWebMail');

  ## count email msgs
  my $query = $on{folder} eq 'PROTOCOLS'
            ? "email_msgs.issue >= '$tv{start_year}' and ".
              "email_msgs.issue <= '$tv{end_year}' and ".
              "email_msgs.pid <>'' and ".
              "email_msgs.folder <> 'TRASH'"
            : "email_msgs.owner='$auth_user'".
              ( $folder ne 'all'
                ? " and email_msgs.folder='$folder'"
                : '').
              " and email_msgs.sender<>''";

  $query .= $on{views} eq 'read'      ? " and email_msgs.status~*'r'"
	  : $on{views} eq 'unread'    ? " and not (email_msgs.status~*'r')"
	  : $on{views} eq 'replied'   ? " and email_msgs.status~*'e'"
	  : $on{views} eq 'unreplied' ? " and not (email_msgs.status~*'e')"
	  : '';

  ## filter tags
  my $query_cnt = $on{tags} && $on{tags} ne 'all'
	        ? "select count(*) from email_msgtags ".
	          "left join email_msgs ".
	          "on email_msgs.id = email_msgtags.msgid ".
	          "where email_msgtags.name = '".DbQuote($on{tags})."' and $query" 
                : "select count(*) from email_msgs where $query";

  DbQuery($query_cnt);
  my $email_cnt = FetchRow();

  ## define per page view
  my $base_url = "webmail?".
		 "order=$on{order}&amp;".
		 "sortdirection=$on{sortdirection}&amp;".		 
		 "views=$on{views}&amp;".
		 "tags=$on{tags}&amp;".
		 "folder=$escapedfolder";

  my ( $limit,
       $offset,
       $page_selector ) = IG::MkTaskPaging( $email_cnt, $base_url );

  ## Translate folders name
  my %validfolders;
  for (keys %folderinfo)
   {
    $folderinfo{$_}{unread} ||= '0';
    $folderinfo{$_}{msgs}   ||= '0';
    $validfolders{$_} = "$folderinfo{$_}{name}".
                        ($_ eq 'PROTOCOLS'
                         ? ''
                         : " ($folderinfo{$_}{unread}/$folderinfo{$_}{msgs})");
   }

  ## draw header
  PrOut "<table width=\"100%\" cellspacing=0 cellpadding=2>".
	"<td class=\"menu\" nowrap>";

  Input( name     => 'folder',
         style    => 'font-size:10px',
         type     => 'select',
         float    => 'left',
         allvalue => 'true',
         data     => \%validfolders,
         value    => $folder,
         onchange => "location.href = 'webmail?".
                                      "action=displayheaders&amp;".
                                      "tags=$on{tags}&amp;".
                                      "order=$on{order}&amp;".
                                      "folder=' + this.options[this.selectedIndex].value;");

  Input( name     => 'tags',
         style    => 'font-size:10px',
         type     => 'select',
         allvalue => 'true',
         data     => IG::WebMail::GetTags(),
         float    => 'left',
         onchange => "location.href = 'webmail?".
                                      "action=displayheaders&amp;".
                                      "order=$on{order}&amp;".
                                      "folder=$on{folder}&amp;".
                                      "views=$on{views}&amp;".
                                      "tags=' + this.options[this.selectedIndex].value;");

  Input( name     => 'views',
         style    => 'font-size:10px',
         type     => 'select',
         allvalue => 'true',
         data     => { unread    => $lang{unread_messages},
                       read      => $lang{read_messages},
                       replied   => $lang{replied_messages},
                       unreplied => $lang{unreplied_messages},
                       perthread => 'Per thread' },
         value    => $folder,
         float    => 'left',
         onchange => "location.href = 'webmail?".
                                      "action=displayheaders&amp;".
                                      "order=$on{order}&amp;".
                                      "folder=$on{folder}&amp;".
                                      "tags=$on{tags}&amp;views=' + this.options[this.selectedIndex].value;");


  ## Show number of messages
  PrOut "<div style=\"float:right\">\n";  
  if ( $folderinfo{$folder}{msgs} )
   {
    PrOut ( ($offset + 1) . ' - ' .
            ($offset + $limit > $email_cnt ? $email_cnt :  $offset+$limit).
            "  $lang{of} $email_cnt $lang{messages} ".
            ' - '. IG::MkByte( $folderinfo{$folder}{size} ) );
   }
  else
   {
    PrOut $folder eq 'all' ? '' : $lang{nomessages};
   }

  PrOut Blush(" [ $lang{quota_hit} ]") if $IG::WebMail::hitquota;
  PrOut "</div></td></tr></table>\n";

  if (!$on{print})
   {
    ## Mk a command bar
    my $_bar_buttons =
     HLayer
         ( intra_space  => 2,
	   bottom_space => 0,
	   left_layers  =>
	    [(
              MkButton( icon_src   => "$IG::img_url/mail_get.png",
                        icon_width => 26,
                        link       => "javascript:winPopUp('webmail?action=getnewmessages',350,170,'MsgAlert');",
                        quick_help => $lang{checkmsg} ),

              MkButton( icon_src   => "$IG::img_url/mail_new.png",
                        icon_width => 26,
                        link       => "$base_url&amp;".
                                      "action=composemessage&amp;".
                                      "pos=$on{pos}",
                        quick_help => $lang{composenew} ),

              MkButton( icon_src   => "$IG::img_url/mail_circular.png",
                        icon_width => 26,
                        link       => "circular",
                        quick_help => $lang{circulars},
                        privilege  => CheckPrivilege("webmail_circulars") ),

              MkButton( icon_src   => "$IG::img_url/mail_folder.png",
                        icon_width => 26,
                        link       => "webmail?action=editfolders&amp;".
                                            "order=$on{order}&amp;".
                                            "folder=$escapedfolder&amp;".
                                            "pos=$on{pos}",
                        quick_help => $lang{folders} ),

              MkButton( icon_src   => "$IG::img_url/mail_filter.png",
                        icon_width => 26,
                        link       => "webmail?action=editfilter&amp;".
                                            "order=$on{order}&amp;".
                                            "folder=$escapedfolder&amp;".
                                            "pos=$on{pos}",
                        quick_help => $lang{filter}),

              MkButton( icon_src   => "$IG::img_url/mail_import.png",
                        icon_width => 26,
                        link       => "webmail?action=importmessages&amp;".
                                            "order=$on{order}&amp;".
                                            "folder=$escapedfolder&amp;".
                                            "pos=$on{pos}",
                        privilege  => $on{folder} ne 'PROTOCOLS',
                        quick_help => $lang{import_messages} ),

              MkButton( icon_src   => "$IG::img_url/mail_export.png",
                        icon_width => 26,
                        link       => "webmail?action=exportmessages&amp;".
                                      "folder=$escapedfolder",
                        privilege  => $on{folder} ne 'PROTOCOLS',
                        quick_help => $lang{export_messages} ),

              MkButton( icon_src   => "$IG::img_url/mail_find.png",
                        icon_width => 26,
                        link       => "webmail?action=findexec&amp;".
                                      "extendedsearch=2&amp;".
                                      "folder=$escapedfolder",
                        quick_help => $lang{extended_mail_search} ),

              MkButton( icon_src   => "$IG::img_url/mail_trash.png",
                        icon_width => 26,
                        onclick    => IG::JsConfirm($lang{are_you_sure}),
                        privilege  => $folder eq 'TRASH',
                        link       => "$base_url&amp;".
                                      "action=emptytrash&amp;".
                                      "pos=$on{pos}",
                        quick_help  => $lang{emptytrash} )
		   )]
	 );

    my $_bar_action = [( FormHead( name      => 'moveform',
                                   enctype   => 'multipart/form-data',
                                   cgiaction =>'messageaction' ).
                                
                         _set_hiddens().
                                          
                         Input( name     => 'actiontarget',
                                data     => _get_action_items(),
                                onchange => 'submit();',
                                style    => 'width:200px; font-size:10px;',
                                zerovalue=> 'true',
                                value    => '',
                                override => 1,
                                readonly => $on{folder} eq 'PROTOCOLS'
                                         ? 'true'
                                         : '',
                                type     => 'select'),

                         Img( src   => "$IG::img_url/arrow_link.gif",
                              width => 13,
                              style => "position:relative; top:10px; margin:0px 3px -1px 0px;",
                              height=> 18 )
                       )];


    HLayer( bottom_space => 2,
            left_layers  => [( $_bar_buttons )],
            layers       => [( $page_selector )],
            right_layers => $_bar_action );
   }
  else
   {
    Br();
   }

  if ($folder eq 'SENT' || $folder eq 'DRAFTS')
   { $lang{sender} = $lang{receiver} }

  if ( $on{folder} eq 'PROTOCOLS' )
   {
    ## protocols list view
    TaskListMenu
     (
      [],
      [$lang{number},
       "action=displayheaders&amp;".
  	"pos=$on{pos}&amp;".  
	"folder=$escapedfolder&amp;".
	"order=pid" ],
      [$lang{contact_name}],
      [$lang{date},
       "action=displayheaders&amp;".
  	"pos=$on{pos}&amp;".  
	"folder=$escapedfolder&amp;".
	"order=issue" ],
      ["$lang{sender} - $lang{receiver}"],
      [$lang{subject},
       "action=displayheaders&amp;".
	"pos=$on{pos}&amp;".
	"folder=$escapedfolder&amp;".
	"order=subject" ],
      ['Tags'],
     );
   }
  elsif ( IG::ConfigParam('webmail.compact_list') )
   {
    ## compact list view
    TaskListMenu
     (
      [],
      [$lang{date},
       "action=displayheaders&amp;".
  	"pos=$on{pos}&amp;".  
	"folder=$escapedfolder&amp;".
	"order=issue" ],
      [$lang{sender},
       "action=displayheaders&amp;".
 	"pos=$on{pos}&amp;".
	"folder=$escapedfolder&amp;".
	"order=sender" ],
      [$lang{subject},
       "action=displayheaders&amp;".
	"pos=$on{pos}&amp;".
	"folder=$escapedfolder&amp;".
	"order=subject" ],
      ['Tags'],
      [Input( name       => 'allbox',
              type       => 'checkbox',
              value      => '',
              fieldstyle => 'margin:0;padding:0;',
              override   => 1,
              onclick    => 'CheckAll();'),
       '',
       'width=15'] #IE_HACK
     );
   }
  else
   {
    ## extended list view
    TaskListMenu
     (
      [],
      [$lang{date},
       "action=displayheaders&amp;".
  	"pos=$on{pos}&amp;".  
	"folder=$escapedfolder&amp;".
	"order=issue" ],
      [$lang{sender},
       "action=displayheaders&amp;".
 	"pos=$on{pos}&amp;".
	"folder=$escapedfolder&amp;".
	"order=sender" ],
      [$lang{subject},
       "action=displayheaders&amp;".
	"pos=$on{pos}&amp;".
	"folder=$escapedfolder&amp;".
	"order=subject" ],
      [$lang{size},
       "action=displayheaders&amp;".
	"pos=$on{pos}&amp;".
	"folder=$escapedfolder&amp;".
	"order=size" ],
      ['Tags'],
      [],
      [Input( name       => 'allbox',
              type       => 'checkbox',
              value      => '',
              fieldstyle => 'margin:0;padding:0;',
              override   => 1,
              onclick    => 'CheckAll();'),
       '',
       'width=15'] #IE_HACK
     );
   }

  QuoteParams();

  my $fieldlist = 
          " email_msgs.id, email_msgs.issue, email_msgs.timeissue,".
	  " email_msgs.sender, email_msgs.contactid, email_msgs.receiver,".
	  " email_msgs.owner, email_msgs.subject, email_msgs.folder,".
	  " email_msgs.content, email_msgs.status, email_msgs.size, ".
	  " email_msgs.sharemode, email_msgtags.name, email_msgs.pid, ".
	  " contacts.contactname,".
	  " (select count(*) from comments".
	  "  where referenceproc='webmail' and ".
	  ($IG::db_driver eq 'mysql'
	   ? "referenceid=concat(email_msgs.owner,'_',email_msgs.id)"
	   : "referenceid=(email_msgs.owner || '_' || email_msgs.id)").
	  " )";

  my $commonjoins =
          "left join email_msgtags on email_msgs.id=email_msgtags.msgid ".
	  "left join contacts on email_msgs.contactid=contacts.contactid ";

  my $commonorder =
             "email_msgs.$in{order} $in{sortdirection}, ".
	     "email_msgs.timeissue $in{sortdirection}, ".
	     "email_msgs.id";

  if ( $offset == 0 && $limit == $email_cnt )
   {
    ## no pagination: a normal query+join to be used with FetchGroupedRows
    DbQuery("select $fieldlist ".

          ## filter by selected tag (email_msgtags2) 
          ## but get all matching message tags (email_msgtags)
          ( $on{tags} && $on{tags} ne 'all'
	    ? "from email_msgtags email_msgtags2 ".
              "left join email_msgs on email_msgs.id = email_msgtags2.msgid ".
		"$commonjoins ".
              "where email_msgtags2.name = '$in{tags}' and ($query)"

	    : "from email_msgs ".
		"$commonjoins ".
	      "where $query " ).

	    "order by $commonorder, email_msgtags.name");
   }
  else 
   {
    ## use limit/offset without FetchGroupedRows to store only email ids.
    DbQuery("select email_msgs.id ".

            ## filter by selected tag (email_msgtags2) 
            ## but get all matching message tags (email_msgtags)
            ( $on{tags} && $on{tags} ne 'all'
  	      ? "from email_msgtags email_msgtags2 ".
                "left join email_msgs on email_msgs.id=email_msgtags2.msgid ".
                "where email_msgtags2.name = '$in{tags}' and ($query)"

	      : "from email_msgs ".
	        "where $query " ).

	    "order by $commonorder ".
	    "limit $limit offset $offset");

    my @msgids;
    while( my $id = FetchRow() )
     { push @msgids, "'".DbQuote($id)."'"; }
    my $idlist = join ',', @msgids;
    $idlist ||= "'ELY'"; ## to avoid sql error if no id matches
    
    ## now use $idlist to fetch all email and tag information
    ## with FetchGroupedRows.
    DbQuery( "select $fieldlist ".
             "from email_msgs ".
	     "$commonjoins ".
	     "where ".
             "email_msgs.id in ($idlist) ".
	     ( $on{folder} eq 'PROTOCOLS'
	       ? ''
	       : "and email_msgs.owner = '$auth_user' " ).
	     "order by $commonorder, email_msgtags.name");
   }

  my $messnum;
  while (my @row = IG::FetchGroupedRows
                    ( group_by_indexes  => 0,  ## group by id
                      to_concat_indexes => 13  ## concat tags
		    )
        )
   {
    $messnum++;

    my %header;
    my $status;
    $header{message_id}	 = $row[0];
    $header{date}	 = IG::GetNiceDate(IG::GetValuesByDate($row[1]));
    $header{from}	 = $folder eq 'SENT' || $folder eq 'DRAFTS'
			 ? MkEntities((IG::WebMail::ParseAddress($row[5]))[0])
			 : MkEntities((IG::WebMail::ParseAddress($row[3]))[0]);
    $header{contactid}	 = $row[4];
    $header{to}		 = $row[5];
    $header{owner}	 = $row[6];
    $header{subject}	 = MkEntities($row[7]) || 'N/A';
    $header{folder}	 = $row[8];
    $header{contenttype} = $row[9];
    $header{status}	 = $row[10];
    $header{messagesize} = IG::MkByte($row[11]);
    $header{time}	 = IG::ConfigParam('webmail.short_date')
		  	 ? sprintf("%02d:%02d", ($row[2]=~/^(\d+)\:(\d+)/) )
			 : $row[2];
    $header{sharemode}   = $row[12];
    $header{tags}        = $row[13];

    my $boldon;		# Used to control whether text is bold for new mails
    my $escapedmessageid = MkUrl($header{message_id});

    my $bgcolor = $messnum % 2 ? $IG::clr{bg_link} : $IG::clr{bg_list};

    ## Choose status icons based on Status: line and type of encoding
    if ( $header{status} =~ /e/i && $header{status} !~ /r/i )    
     {
      ## It's an automatic reply
      $status .= Img( src   => "$IG::img_url/unreadmsg.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{unread_messages} ) .

                 Img( src   => "$IG::img_url/replied.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => 'Autoreply' );
      $boldon = "font-weight:bolder;";
     }
    elsif ( $header{status} =~ /e/i )
     {
      ## It's a read and replied message
      $boldon = '';
      $status .= Img( src   => "$IG::img_url/replied.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{replied} );
     }
    elsif ( $header{status} =~ /r/i )
     {
      ## It's a simple read message
      $boldon = '';
     }
    else
     {
      ## It's a new message
      $status .= Img( src   => "$IG::img_url/unreadmsg.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{unread_messages} );
      $boldon = "font-weight:bolder;";
     }

    if ( $header{status} =~ /n/i )
     {
      ## It's a received message
      $status .= Img( src   => "$IG::img_url/email_receipt.png",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{message_notified} );
      $boldon = '';
     }

    if (    $header{contenttype} =~ /^multipart/i 
	 && $header{contenttype} !~ /^multipart\/alternative/i )
     {
      $status .= Img( src   => "$IG::img_url/attach.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{attachment} );
     }

    if ( $row[16] > 0 ) 
     {
      $status .= Img( src   => "$IG::img_url/comment_edit.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{comments} );
     }

    my $messagelink = "webmail?".
		      ( $folder eq 'DRAFTS'
		        ? "action=composemessage&amp;".
		          "composetype=draftresume&amp;"
		        : "action=readmessage&amp;" ).
		      "message_id=$escapedmessageid&amp;".
		      "pos=$on{pos}&amp;".
		      "status=$header{status}&amp;".
		      "owner=$header{owner}&amp;".
		      "views=$on{views}&amp;".
		      "tags=$on{tags}&amp;".
		      "folder=$escapedfolder&amp;".
		      "order=$on{order}&amp;".
		      "headers=simple";


    if ( $on{folder} eq 'PROTOCOLS' )
     {
      ## protocols view
      TaskListItem (
	[( $header{sharemode} == 1 
	   ? Img( src   => "$IG::img_url/group_green.gif", 
	          width => 16,
                  align => 'absmiddle',
	          title => $lang{share_mode1} ) 
	   : $header{sharemode} == 2 
	     ? Img( src   => "$IG::img_url/group_red.gif", 
	            width => 16,
                    align => 'absmiddle',
	            title => $lang{share_mode2} ) 
	     : Img( src   => "$IG::img_url/group_orange.gif", 
	            width => 16,
                    align => 'absmiddle',
	            title => $lang{share_mode0} )
	 ).$status,
	 '',
	 "nowrap style=\"background-color: $bgcolor\""],
	["<strong>$row[14]</strong>",
	 $messagelink,
	 "nowrap style=\"background-color: $bgcolor\""],
	[$row[15],
	 '',
	 "style=\"background-color: $bgcolor;$boldon\""],
	["$header{date} $header{time}",
	 '',
	 "style=\"background-color: $bgcolor;$boldon\""],
	[IG::WrapText(  text      => "$lang{from}: ".MkEntities($row[3]).
                                     "<hr style=\"border:1px dotted $IG::clr{bg_task}\">".
                                     "$lang{to}: ".MkEntities($row[5]),
			separator => ' ',
			columns   => 50 ),
	 '',
	 "style=\"font-size:10px; background-color:$bgcolor;$boldon\""],
	[IG::WrapText(	text	  => $header{sharemode} == 2 
	                             && $row[6] ne $auth_user
                                  ?  $lang{reserved}
                                  :  $header{subject},
			separator => ' ',
			columns   => 50 ),
	 '',
	 "style=\"background-color: $bgcolor;$boldon\""],
        [$header{tags},
         "",
         "style=\"white-space:nowrap; font-size:10px; background-color: $bgcolor; $boldon\""],

		 );
     }
    elsif ( IG::ConfigParam('webmail.compact_list') )
     {
      ## compact view
      TaskListItem (
	[( $header{sharemode} == 1 
	   ? Img( src   => "$IG::img_url/group_green.gif", 
                  align => 'absmiddle',
                  width => 16,
	          title => $lang{share_mode1} ) 
	   : $header{sharemode} == 2 
	     ? Img( src   => "$IG::img_url/group_red.gif", 
                    align => 'absmiddle',
                    width => 16,
	            title => $lang{share_mode2} ) 
	     : ''
	 ) . $status,
	 '',"nowrap style=\"background-color: $bgcolor\""],
	["$header{date}&nbsp;$header{time}",
	 $messagelink,
	 "style=\"background-color: $bgcolor;$boldon\""],
	[IG::WrapText(  text      => $header{from},
			separator => ' ',
			columns   => 50 ) || $lang{none},
	 $messagelink,
	 "style=\"background-color: $bgcolor;$boldon\""],
	[IG::WrapText(	text	  => $header{subject},
			separator => ' ',
			columns   => 50 ),
	 $messagelink,
	 "style=\"background-color: $bgcolor;$boldon\""],
        [$header{tags},
	 $messagelink,
         "style=\"font-size:10px; background-color: $bgcolor; $boldon\""],
	[Input( type       => 'checkbox',
		fieldstyle => 'margin:0;padding:0;',
		name       => 'message_ids',
		value      => $header{message_id}),
	 '',"style=\"background-color: $bgcolor\""]
		 );
     }
    else
     {
      ## extended view
      TaskListItem (
	["<strong>".($messnum+$offset)."</strong>".
	 ( $header{sharemode} == 1 
	   ? Img( src   => "$IG::img_url/group_green.gif", 
	          width => 16,
                  align => 'absmiddle',
	          title => $lang{share_mode1} ) 
	   : $header{sharemode} == 2 
	     ? Img( src   => "$IG::img_url/group_red.gif", 
	            width => 16,
                    align => 'absmiddle',
	            title => $lang{share_mode2} ) 
	     : ''
	 ).$status,
	 $messagelink,
	 "nowrap style=\"background-color: $bgcolor\""],
	["$header{date} $header{time}",
	 $messagelink,
	 "style=\"background-color: $bgcolor;$boldon\""],
	[IG::WrapText(  text      => $header{from},
			separator => ' ',
			columns   => 50 ) || $lang{none},
	 $messagelink,
	 "style=\"background-color: $bgcolor;$boldon\""],
	[IG::WrapText(	text	  => $header{subject},
			separator => ' ',
			columns   => 50 ),
	 $messagelink,
	 "style=\"background-color: $bgcolor;$boldon\""],
	[$header{messagesize},
	 "",
	 "style=\"white-space:nowrap; background-color: $bgcolor; $boldon\""],
        [$header{tags},
         "",
         "style=\"white-space:nowrap; font-size:10px; background-color: $bgcolor; $boldon\""],
	[Img( href  => "webmail?".
	                  "action=composemessage&amp;".
	                  "composetype=reply&amp;".
	                  "pos=$on{pos}&amp;".
	                  "views=$on{views}&amp;".
	                  "tags=$on{tags}&amp;".
	                  "folder=$escapedfolder&amp;".
	                  "order=$on{order}&amp;".
	                  "headers=simple&amp;".
	                  "message_id=$escapedmessageid",
	      src   => "$IG::img_url/replymsg.png",
	      width => 16,
	      title => $lang{reply} ),
	 '',"style=\"background-color: $bgcolor\""],
	[Input( type       => 'checkbox',
		fieldstyle => 'margin:0;padding:0;',
		name       => 'message_ids',
		value      => $header{message_id}),
	 '',"style=\"background-color: $bgcolor\""]
		 );
     }
   }

  ## a strange TaskListFoot
  for ( $IG::task_list_rows .. $IG::page_results-1 )
   {
    my $bgcolor = $_ % 2 ? $IG::clr{bg_list} : $IG::clr{bg_link}; 
    TaskListItem( ( ['&nbsp;',
                     '',
                     "style=\"background-color:$bgcolor\""]
                  ) x
                  ( $on{folder} eq 'PROTOCOLS'
                    ? 7
                    : IG::ConfigParam('webmail.compact_list')
                      ? 6
                      : 8 ) );
   }
  TaskListFoot();

  FormFoot();

  ## A Java script to check all checkbox in a click
  PrOut <<END;
  <script language="JavaScript">
   <!--
   function CheckAll()
   {
      for (var i=0;i<document.moveform.elements.length;i++)
      {
         var e = document.moveform.elements[i];
         if (e.name != "allbox")
            e.checked = document.moveform.allbox.checked;
      }
   }
   //-->
  </script>
END
  Footer();
 }

###############################################################################
###############################################################################
sub displaythreads
 {
  HtmlHead( shortcuts => _short_cuts(),
            title     => 'IGWebMail',
            onevent   => $on{recheck}
                      ?  'onload="if (parent.chkmsg && parent.chkmsg.ajaxUpdate) '.
                                   'parent.chkmsg.ajaxUpdate()"'
                      :  '' );

  TaskHead( width     => "100%",
            title     => "IGWebMail");

  my ($status );

  ## count email msgs
  my $query =   "email_msgs.owner='$auth_user'".
		($folder ne 'all' ? " and email_msgs.folder='$folder'" : "").
		" and email_msgs.sender<>'' ";

  my $query_cnt = "select count(*) from email_msgs where $query".
                  "group by email_msgs.threadid";
     $query_cnt = "select count(*) from ($query_cnt) as threads";

  DbQuery($query_cnt);
  my $email_cnt = FetchRow();

  ## define per page view
  my $base_url = "webmail?".
		 "order=$on{order}&amp;".
		 "sortdirection=$on{sortdirection}&amp;".		 
		 "views=$on{views}&amp;".
		 "tags=$on{tags}&amp;".
		 "folder=$escapedfolder";

  my ( $limit,
       $offset,
       $page_selector ) = IG::MkTaskPaging($email_cnt, $base_url);

  ## Translate folders name
  my %validfolders;
  for (keys %folderinfo)
   {
    $folderinfo{$_}{unread} ||= '0';
    $folderinfo{$_}{msgs}   ||= '0';
    $validfolders{$_} = "$folderinfo{$_}{name}".
			" ($folderinfo{$_}{unread}/$folderinfo{$_}{msgs})";
   }

  ## draw header
  PrOut "<table width=\"100%\" cellspacing=0 cellpadding=2>".
	"<td class=\"menu\" nowrap>";

  Input (	name=>'folder',
		style=>'font-size:10px',
		type=>'select',
		float=>'left',
		allvalue=>'true',
		data=>\%validfolders,
		value=>$folder,
		onchange=>"location.href = 'webmail?".
		                           "action=displayheaders&amp;".
		                           "tags=$on{tags}&amp;".
		                           "order=$on{order}&amp;".
		                           "folder=' + this.options[this.selectedIndex].value;");

  Input (	name=>'views',
		style=>'font-size:10px',
		type=>'select',
		allvalue=>'true',
		data=> { unread=>$lang{unread_messages},
			 read=>$lang{read_messages},
			 replied=>$lang{replied_messages},
			 unreplied=>$lang{unreplied_messages},
			 perthread=>'Per thread' },
		value=>$folder,
		float=>'left',
		onchange=>"location.href = 'webmail?action=displayheaders&amp;order=$on{order}&amp;folder=$on{folder}&amp;tags=$on{tags}&amp;views=' + this.options[this.selectedIndex].value;");


  ## Show number of messages
  PrOut "<div style=\"float:right\">\n";  
  if ($folderinfo{$folder}{msgs})
   {
    PrOut ( ($offset + 1) . ' - '.
            ($offset + $limit) . " $lang{of} $email_cnt Threads"
          );
   }
  else
   {
    PrOut $lang{nomessages};
   }

  PrOut Blush(" [ $lang{quota_hit} ]") if $IG::WebMail::hitquota;
  PrOut "</div></td></tr></table><table width=\"100%\">\n";

  if (!$on{print})
   {
    PrOut "<td bgcolor=$IG::clr{bg_task} nowrap>";

    ## Mk a command bar
    HLayer(intra_space  => 2,
	   bottom_space => 2,
	   left_layers  =>
	    [(
	      MkButton( icon_src   => "$IG::img_url/mail_get.png",
                        icon_width => 26,
	                link       => "javascript:winPopUp('webmail?action=getnewmessages',350,170,'MsgAlert');",
                        quick_help => $lang{checkmsg} ),

              MkButton( icon_src   => "$IG::img_url/mail_new.png",
                        icon_width => 26,
                        link       => "$base_url&amp;".
                                      "action=composemessage&amp;".
                                      "pos=$on{pos}",
                        quick_help => $lang{composenew} ),

              MkButton( icon_src   => "$IG::img_url/mail_circular.png",
                        icon_width => 26,
                        link       => 'circular',
                        quick_help => $lang{circulars},
                        privilege  => CheckPrivilege("webmail_circulars") ),

              MkButton( icon_src   => "$IG::img_url/mail_folder.png",
                        icon_width => 26,
                        link       => "webmail?action=editfolders&amp;".
                                              "order=$on{order}&amp;".
                                              "folder=$escapedfolder&amp;".
                                              "pos=$on{pos}",
                        quick_help => $lang{folders} ),

              MkButton( icon_src   => "$IG::img_url/mail_filter.png",
                        icon_width => 26,
                        link       => "webmail?action=editfilter&amp;".
                                              "order=$on{order}&amp;".
                                              "folder=$escapedfolder&amp;".
                                              "pos=$on{pos}",
                        quick_help => $lang{filter} ),

              MkButton( icon_src   => "$IG::img_url/mail_trash.png",
                        icon_width => 26,
                        onclick    => IG::JsConfirm($lang{are_you_sure}),
                        link       => $base_url.
                                      "&amp;action=emptytrash".
                                      "&amp;pos=$on{pos}",
                        quick_help => $lang{emptytrash} ),
		   )]
	 );

    PrOut "</td><td align=\"center\" bgcolor=$IG::clr{bg_task} nowrap>";

    ## TaskPage Widget
    PrOut $page_selector;

    PrOut "</td><td align=\"right\" bgcolor=$IG::clr{bg_task} nowrap>";



    FormHead(	name=>'moveform',
		float=>'right',
		enctype=>'application/x-www-form-urlencoded',
		cgiaction=>'messageaction');
    _set_hiddens();

    Input (	name=>'actiontarget',
		data=>_get_action_items(),
		onchange=>'submit();',
		style=>'width:200px; font-size:10px;',
		zerovalue=>'true',
		value=>'',
		override=>1,
		type=>'select');

    PrOut "</td></tr></table>";
   }
  else
   {
    PrOut "</table><br>\n";
   }

  if ($folder eq 'SENT' || $folder eq 'DRAFTS')
   { $lang{sender} = $lang{receiver} }

  TaskListMenu
   (
    [$lang{date},
     "action=displayheaders&amp;".
	"pos=$on{pos}&amp;".
	"folder=$escapedfolder&amp;".
	"order=issue" ],
    [$lang{sender},
     "action=displayheaders&amp;".
	"pos=$on{pos}&amp;".
	"folder=$escapedfolder&amp;".
	"order=sender" ],
    [$lang{subject},
     "action=displayheaders&amp;".
	"pos=$on{pos}&amp;".
	"folder=$escapedfolder&amp;".
	"order=subject" ],
    [$lang{messages},
     "action=displayheaders&amp;".
	"pos=$on{pos}&amp;".
	"folder=$escapedfolder&amp;".
	"order=size" ],
    [Input(		name	=>'allbox',
			type	=>'checkbox',
			value	=>'',
			fieldstyle=>'margin:0;padding:0;',
			override=>1,
			onclick	=>'CheckAll();'),'','width=15'] #IE_HACK
   );

  if ( $IG::db_driver eq 'mysql' )
   {
    DbQuery("select *, count(*) ".
            "from".
            " (select email_msgs.id, email_msgs.issue, email_msgs.timeissue,".
            " email_msgs.sender, email_msgs.receiver, email_msgs.subject,".
	    " email_msgs.status, email_msgs.threadid".
	    " from email_msgs where $query".
	    " order by email_msgs.issue, email_msgs.timeissue) ".
	    "as threads ".
	    "group by threads.threadid ".
	    "order by threads.issue desc, threads.timeissue desc");
   }
  else
   {
    IG::Warn("Feature to develope on postgres database!") && return;
#    DbQuery("select msgs.id, msgs.issue, msgs.timeissue,".
#            " msgs.sender, msgs.receiver, msgs.subject,".
#	    " msgs.status, msgs.threadid, threads.cnt ".
#            "from (select threadid, count(*) as cnt from email_msgs group by threadid) as threads ".
#            "left join".
#            " (select * from email_msgs order by issue, timeissue) ".
#            "as msgs on msgs.threadid = threads.threadid ".
#	    "where".
#            " msgs.owner='$auth_user'".
#            ($folder ne 'all' ? " and msgs.folder='$folder'" : "").
#            " and msgs.sender<>'' ".
#	    "order by msgs.issue desc, msgs.timeissue desc");
   }
    

  my $messnum;
  while (my @row = FetchRow())
   {
    next if ++$messnum < ( $offset + 1);
    last if $messnum   > ( $offset + $limit);

    my %header;
    $header{message_id}	 = $row[0];
    $header{date}	 = IG::GetNiceDate(IG::GetValuesByDate($row[1]));
    $header{from}	 = $folder eq 'SENT' || $folder eq 'DRAFTS'
			 ? MkEntities((IG::WebMail::ParseAddress($row[4]))[0])
			 : MkEntities((IG::WebMail::ParseAddress($row[3]))[0]);
    $header{to}		 = $row[4];

    1 while $row[5] =~ s/^re(\[\d+\])*\:\s*//gi;
    $header{subject}	 = MkEntities($row[5]) || 'N/A';

    $header{messagesize} = $row[8];
    $header{time}	 = IG::ConfigParam('webmail.short_date')
		  	 ? substr($row[2],0,5)
			 : $row[2];

    my $escapedmessageid = MkUrl($header{message_id});

    my $bgcolor = $messnum % 2 ? $IG::clr{bg_list} : $IG::clr{bg_link};

    $status = "<strong>$messnum</strong> ";
    my $boldon = "font-weight:bolder;";

    if (    $header{contenttype} =~ /multipart/i 
	 && $header{contenttype} !~ /multipart\/alternative/i )
     {
      $status .= Img( src   => "$IG::img_url/attach.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{attachment} );
     }

    my $messagelink = "webmail?".
		      ( $folder eq 'DRAFTS'
		        ? "action=composemessage&amp;".
		          "composetype=draftresume&amp;"
		        : "action=readmessage&amp;" ).
		      "message_id=$escapedmessageid&amp;".
		      "pos=$on{pos}&amp;".
		      "status=$header{status}&amp;".
		      "owner=$header{owner}&amp;".
		      "views=$on{views}&amp;".
		      "tags=$on{tags}&amp;".
		      "folder=$escapedfolder&amp;".
		      "order=$on{order}&amp;".
		      "headers=simple";

    TaskListItem (
	["$header{date} $header{time}",
	 $messagelink,
	 "style=\"background-color: $bgcolor;$boldon\""],
	[IG::WrapText(  text      => $header{from},
			separator => ' ',
			columns   => 50 ) || $lang{none},
	 $messagelink,
	 "style=\"background-color: $bgcolor;$boldon\""],
	[IG::WrapText(	text	  => $header{subject},
			separator => ' ',
			columns   => 50 ),
	 $messagelink,
	 "style=\"background-color: $bgcolor;$boldon\""],
	[$header{messagesize},
	 "",
	 "style=\"white-space:nowrap; background-color: $bgcolor; $boldon\""],
	[Input( type=>'checkbox',
		fieldstyle=>'margin:0;padding:0;',
		name=>'message_ids',
		value=>$row[7] ),
	 '',"style=\"background-color: $bgcolor\""]
		 );
   }

  ## a strange TaskListFoot
  for ($IG::task_list_rows..$IG::page_results-1)
   {
    my $bgcolor = $_ % 2 ? $IG::clr{bg_link} : $IG::clr{bg_list}; 
    TaskListItem((["&nbsp;","","style=\"background-color:$bgcolor\""]) x 5 );
   }
  TaskListFoot();

  FormFoot();

  ## A Java script to check all checkbox in a click
  PrOut <<END;
  <script language="JavaScript">
   <!--
   function CheckAll()
   {
      for (var i=0;i<document.moveform.elements.length;i++)
      {
         var e = document.moveform.elements[i];
         if (e.name != "allbox")
            e.checked = document.moveform.allbox.checked;
      }
   }
   //-->
  </script>
END
  Footer();
  1;
 }

###############################################################################
###############################################################################
sub ajax_headers
 {
  HttpHead( expires => '+30s' );
  TaskMsg( Input( type      => 'button',
                  float     => 'right',
                  onclick   => "document.location = '".
                               "webmail?".
                               "action=composemessage&amp;".
                               "to=".MkUrl($on{to})."&amp;".
                               "contactid=$on{contactid}&amp;".
                              "backtoreferer=1';",
                  show      => $lang{composenew},
                  fieldstyle=> 'margin:0px',
                  style     => 'margin:0px;font-size:10px; height:15px' ).
       
           Img(   src       => "$IG::img_url/email.png",
                  style     => 'margin-right:3px;',
                  align     => 'absmiddle').

           "<a href=\"letters\">$lang{emails}</a>"
           ,7);

  ## protocols list view
  TaskListMenu
     (
      [],
      [$lang{number}],
      [$lang{date}],
      ["$lang{sender} - $lang{receiver}"],
      [$lang{subject}],
      ['Tags'],
     );

  QuoteParams();
  DbQuery("select email_msgs.id, email_msgs.issue, email_msgs.timeissue,".
	  " email_msgs.sender, email_msgs.contactid, email_msgs.receiver,".
	  " email_msgs.owner, email_msgs.subject, email_msgs.folder,".
	  " email_msgs.content, email_msgs.status, email_msgs.size, ".
	  " email_msgs.sharemode, email_msgtags.name, email_msgs.pid, ".
	  " contacts.contactname ".

	  "from email_msgs ".
	  "left join email_msgtags on email_msgs.id = email_msgtags.msgid ".
          "left join contacts on email_msgs.contactid = contacts.contactid ".
	  "where email_msgs.contactid='$on{contactid}'".
	  " and email_msgs.pid<>'' ".

	  "order by email_msgs.$in{order} $in{sortdirection},".
	  " email_msgs.timeissue $in{sortdirection},".
	  " email_msgs.id,".
	  " email_msgtags.name");

  my $messnum;
  while (my @row = IG::FetchGroupedRows
                    ( group_by_indexes  => 0,  ## group by id
                      to_concat_indexes => 13  ## concat tags
		    )
        )
   {
    my %header;
    my $status;
    $header{message_id}	 = $row[0];
    $header{date}	 = IG::GetNiceDate(IG::GetValuesByDate($row[1]));
    $header{from}	 = $folder eq 'SENT' || $folder eq 'DRAFTS'
			 ? MkEntities((IG::WebMail::ParseAddress($row[5]))[0])
			 : MkEntities((IG::WebMail::ParseAddress($row[3]))[0]);
    $header{contactid}	 = $row[4];
    $header{to}		 = $row[5];
    $header{owner}	 = $row[6];
    $header{subject}	 = MkEntities($row[7]) || 'N/A';
    $header{folder}	 = $row[8];
    $header{contenttype} = $row[9];
    $header{status}	 = $row[10];
    $header{messagesize} = IG::MkByte($row[11]);
    $header{time}	 = IG::ConfigParam('webmail.short_date')
		  	 ? substr($row[2],0,5)
			 : $row[2];
    $header{sharemode}   = $row[12];
    $header{tags}        = $row[13];

    my $boldon;		# Used to control whether text is bold for new mails
    my $escapedmessageid = MkUrl($header{message_id});

    my $bgcolor = $messnum % 2 ? $IG::clr{bg_link} : $IG::clr{bg_list};

    ## Choose status icons based on Status: line and type of encoding
    if ( $header{status} =~ /e/i && $header{status} !~ /r/i )    
     {
      ## It's an automatic reply
      $status .= Img( src   => "$IG::img_url/unreadmsg.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{unread_messages} ) .

                 Img( src   => "$IG::img_url/replied.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => 'Autoreply' );
      $boldon = "font-weight:bolder;";
     }
    elsif ( $header{status} =~ /e/i )
     {
      ## It's a read and replied message
      $boldon = '';
      $status .= Img( src   => "$IG::img_url/replied.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{replied} );
     }
    elsif ( $header{status} =~ /r/i )
     {
      ## It's a simple read message
      $boldon = '';
     }
    else
     {
      ## It's a new message
      $status .= Img( src   => "$IG::img_url/unreadmsg.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{unread_messages} );
      $boldon = "font-weight:bolder;";
     }

    if ( $header{status} =~ /n/i )
     {
      ## It's a received message
      $status .= Img( src   => "$IG::img_url/email_receipt.png",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{message_notified} );
      $boldon = '';
     }

    if (    $header{contenttype} =~ /multipart/i 
	 && $header{contenttype} !~ /multipart\/alternative/i )
     {
      $status .= Img( src   => "$IG::img_url/attach.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{attachment} );
     }

    my $messagelink = "webmail?".
		      ( $folder eq 'DRAFTS'
		        ? "action=composemessage&amp;".
		          "composetype=draftresume&amp;"
		        : "action=readmessage&amp;" ).
		      "message_id=$escapedmessageid&amp;".
		      "pos=$on{pos}&amp;".
		      "status=$header{status}&amp;".
		      "owner=$header{owner}&amp;".
		      "views=$on{views}&amp;".
		      "tags=$on{tags}&amp;".
		      "folder=$escapedfolder&amp;".
		      "order=$on{order}&amp;".
		      "headers=simple";


      ## protocols view
      TaskListItem (
	[( $header{sharemode} == 1 
	   ? Img( src   => "$IG::img_url/group_green.gif", 
	          width => 16,
                  align => 'absmiddle',
	          title => $lang{share_mode1} ) 
	   : $header{sharemode} == 2 
	     ? Img( src   => "$IG::img_url/group_red.gif", 
	            width => 16,
                    align => 'absmiddle',
	            title => $lang{share_mode2} ) 
	     : Img( src   => "$IG::img_url/group_orange.gif", 
	            width => 16,
                    align => 'absmiddle',
	            title => $lang{share_mode0} )
	 ).$status,
	 '',
	 "nowrap style=\"background-color: $bgcolor\""],
	["<strong>$row[14]</strong>",
	 $messagelink,
	 "nowrap style=\"background-color: $bgcolor\""],
	["$header{date} $header{time}",
	 '',
	 "style=\"background-color: $bgcolor;$boldon\""],
	[IG::WrapText(  text      => "$lang{from}: ".MkEntities($row[3]).
                                     "<hr style=\"border:1px dotted $IG::clr{bg_task}\">".
                                     "$lang{to}: ".MkEntities($row[5]),
			separator => ' ',
			columns   => 50 ),
	 '',
	 "style=\"font-size:10px; background-color:$bgcolor;$boldon\""],
	[IG::WrapText(	text	  => $header{sharemode} == 2 
	                             && $row[6] ne $auth_user
                                  ?  $lang{reserved}
                                  :  $header{subject},
			separator => ' ',
			columns   => 50 ),
	 '',
	 "style=\"background-color: $bgcolor;$boldon\""],
        [$header{tags},
         "",
         "style=\"white-space:nowrap; font-size:10px; background-color: $bgcolor; $boldon\""],

		 );
   }

  ## a strange TaskListFoot
  for ($IG::task_list_rows..$IG::page_results-1)
   {
    my $bgcolor = $_ % 2 ? $IG::clr{bg_list} : $IG::clr{bg_link}; 
    TaskListItem( ( ['&nbsp;',
                     '',
                     "style=\"background-color:$bgcolor\""]
                  ) x 6);
   }
  TaskListFoot();
 }

###############################################################################
###############################################################################
sub _get_action_items
 {
  my @actionitems;

  ## Add mark items
  push @actionitems, ['---', '-'x20];  
  for (qw (read unread replied unreplied))
   {
    push @actionitems, ["mark_as:$_", $lang{"mark_as_$_"}];
   }

  ## Add separator
  push @actionitems, ['---','-'x20];
   
  ## Add folders
  push @actionitems, ['---', "$lang{move_to}..."];
  foreach (sort { $folderinfo{$a}{name} cmp $folderinfo{$b}{name} }
           grep !/^($folder|PROTOCOLS)$/, keys %folderinfo ) 

   {
    push @actionitems, ["folder:$_", "     $folderinfo{$_}{name}"];
   }

  ## Add share modes
  push @actionitems, ['---','-'x20];
  push @actionitems, ['sharemode:0', $lang{share_mode0}];
  push @actionitems, ['sharemode:1', $lang{share_mode1}];
  push @actionitems, ['sharemode:2', $lang{share_mode2}];

  ## Add separator
  push @actionitems, ['---','-'x20];

  ## Add or remove email tags
  push @actionitems, ['untag', $lang{remove_selected_tags}];
  push @actionitems, ['---',   "$lang{assign_tag}..."];
  for ( @{IG::WebMail::GetTags()} )
   {
    push @actionitems, ["tag_as:$_", "     $_"];
   }    

  ## Add separator
  push @actionitems, ['---','-'x20];

  ## Add users
  push @actionitems, ['---', "$lang{deliver_to_user}..."];
  foreach ( sort { IG::UsrInf('name',$a) cmp IG::UsrInf('name',$b) }
            keys %{IG::UsrInf()}
          )  
   {
    unless ( $_ eq $auth_user || $_ eq 'guest' || IG::UsrInf('status',$_)==2 )
     {
      push @actionitems, ["user:$_", '     ' . substr(IG::UsrInf('name',$_),0,30)];
     }
   }

  ## Add thread action
  push @actionitems, ['---','-'x20];
  push @actionitems, ['set_threadid:none',  $lang{set_unique_thread}];
  push @actionitems, ['set_threadid:split', $lang{split_from_thread}];

  ## Add delete action
  push @actionitems, ['---','-'x20];
  push @actionitems, ['delete',  $lang{delete_message}];

  return \@actionitems; 
 }

###############################################################################
###############################################################################
sub importmessages
 {
  require IG::Utils;

  HtmlHead();
  TaskHead( title    => 'IGWebMail - '. $lang{import_messages},
            icon     => 1,
            minwidth => '530px' );
                
  FormHead( enctype    => 'multipart/form-data',
            labelstyle => 'width: 200px',
            autofocus  => 'false',
            name       => 'importmsg',
            cgiaction  => 'importmessagesagg');

  Input (	type=>'hidden',
		value=>'INBOX',
		name=>'folder');

  my $pan1 = Input( type =>'label',
		    labelstyle=>	'font-weight: bold;'.
			        	'width: auto;'.
                                        'border:0px;'.
			        	'background-color: transparent',
		    show =>'By Internet').

             Input( type=>'text',
		    show=>'Pop3 Server Host',
		    name=>'pop3host',
		    size=>20 ).

             Input( type => 'text',
		    show => 'Pop3 Server Port',
		    value=> 110,
		    name => 'pop3port',
		    size => 5).

             Input( type => 'text',
		    show => 'Pop3 access login',
		    name => 'pop3login',
		    size => 20).

             Input( type => 'password',
		    show => 'Pop3 access Password',
		    name => 'pop3pwd',
		    size => 20).

             Input( type => 'select',
		    show => 'Pop3 auth mode',
		    name => 'pop3auth',
		    data => [qw( BEST APOP CRAM-MD5 PASS )] ).

             Input( type => 'select',
                    show => 'Pop3 use SSL (port 995)',
                    name => 'pop3usessl',
                    data => [([0,$lang{no}],[1,$lang{yes}])] ).

             Input( type => 'select',
                    show => 'Pop3 keep messages on server',
                    name => 'keep_messages',
                    value=> 'y',
                    data => [(['n',$lang{no}],['y',$lang{yes}])] ).
                    
             Input( type => 'select',
                    show => 'IGSuite have to automatically check and download from this account',
                    name => 'autodownload',
                    value=> 'n',
                    data => [(['n',$lang{no}],['y',$lang{yes}])] ).
                    
             Input( type => 'text',
                    show => $lang{save_with_name},
                    labelstyle=> 'margin-top:20px; width:200px;',
                    fieldstyle=> 'margin-top:20px;',
                    name => 'importname',
                    maxval=> 30,
                    size => 30 ).

             Input( type => 'checkbox',
                    show => 'Debug mode (look at apache logs)',
                    name => 'pop3debug' );

  my $pan2 = Input( type => 'label',
		    labelstyle => 'font-weight: bold;'.
				  'width: auto;'.
                                  'border:0px;'.
				  'background-color: transparent',
		    show => 'By File').

             Input( show => $lang{import_filename},
		    name => 'upfile',
		    size => 10,
		    type => 'file');

  DbQuery("select * from email_imports where owner='$auth_user' ".
          "order by id");
  my $html;
  while (my @row = FetchRow())
   {
    $html ||= TaskListMenu([$lang{name}],
                           ['Host'],
                           ['Login'],
			   ['Auto'],
                           [] );
                           
    $html .= TaskListItem( [$row[0],
                            "webmail?action=importaction&amp;".
                            "subact=import&amp;id=$row[0]"],
                           ["$row[2]:$row[3]"],
                           [$row[4]],
			   [$row[9] eq 'y' ? $lang{yes} : $lang{no} ],
                           [ Img( src   => "$IG::img_url/edit.gif",
                                  width => 16,
                                  href  => "webmail?action=importaction&amp;".
                                           "default_pane=1&amp;".
                                           "subact=edit&amp;".
                                           "id=$row[0]").
                             Img( src   => "$IG::img_url/delete.gif",
                                  width => 16,
                                  href  => "webmail?action=importaction&amp;".
                                           "subact=delete&amp;".
                                           "id=$row[0]") ] );
   }
   
  my $pan3 = $html ? $html . TaskListFoot(14) : '';

  IG::TabPane( data   =>[([$lang{import_from_previous},    $pan3],
                          [$lang{import_from_pop3_server}, $pan1],
                          [$lang{import_from_mbox_file},   $pan2],
                         )],
               default=>$on{default_pane},
               width  => 500,
               height => 340 );
 
  Input (	show=>$lang{import_messages},
		type=>'submit',
		style=>'margin-top:15px' );
		
  FormFoot();
  Footer();
  1;
 }

###############################################################################
###############################################################################
sub importmessagesagg
 {
  push @IG::errmsg,'Any valid parameters to import email messages'
    if !$on{upfile} && !$on{pop3host};

  if ( $on{pop3usessl} )
   {
    eval("require IO::Socket::SSL");
    push @IG::errmsg,
         "You have to install 'IO::Socket::SSL' perl module if you want to ".
         "select 'Pop3 use SSL (port 995)' option. Refer to www.cpan.org."
      if $@;
   }

  importmessages() && return if @IG::errmsg;

  my $import_status;

  if ( $on{upfile} )
   {
    my $target_spool_file = $IG::user_dir . $IG::S . 'box_to_import';

    push @IG::errmsg, IG::FileUpload(	param_name    => 'upfile',
		                	target_dir    => $IG::user_dir,
		                	target_file   => 'box_to_import',
		                	can_overwrite => 1); 

    importmessages() && return if ! -e $target_spool_file;

    ## update messages from a spool file
    ($import_status, undef) = updateheaderdb( 
                                spool_file    => $target_spool_file,
				target_folder => $on{folder} );

    IG::FileUnlink( $target_spool_file )
      or die("Can't delete '$target_spool_file' temp file.\n");
   }
  else
   {
    push @IG::errmsg, 'POP3 Host name missing' if !$on{pop3host};
    push @IG::errmsg, 'POP3 Login missing'     if !$on{pop3login};
    push @IG::errmsg, 'POP3 Password missing'  if !$on{pop3pwd};    
    importmessages() && return if @IG::errmsg;

    ## save import parameters to future reuse
    DbWrite( table             => 'email_imports',
             action            => 'insert',
             overwrite_clause  => "owner='$auth_user' and ".
                                  "id='".DbQuote($on{importname})."'",
             values            => [ $on{importname},
                                    $auth_user,
                                    $on{pop3host},
                                    $on{pop3port},
                                    $on{pop3login},
                                    $on{pop3pwd},
                                    $on{pop3auth},
                                    $on{pop3usessl},
                                    $on{keep_messages},
				    $on{autodownload} ]
           ) if $on{importname};

    ## Import messages
    ($import_status, undef) = 
                     updateheaderdb( host          => $on{pop3host},
                                     port          => $on{pop3port},
                                     login         => $on{pop3login},
                                     pwd           => $on{pop3pwd},
                                     auth          => $on{pop3auth},
                                     debug         => $on{pop3debug},
                                     usessl        => $on{pop3usessl},
                                     keep_messages => $on{keep_messages} );
   }

  if ( $import_status == -1 )
   {
    ## We have an error. Capture log messages from updateheaderdb
    open( MSG, '<', "$IG::user_dir${IG::S}mail_progress")
      or die("Can't read from '$IG::user_dir${IG::S}mail_progress'.\n");
    push @IG::errmsg, scalar <MSG>;
    close(MSG);
    importmessages();
   }
  elsif ( $import_status == 0 )
   {
    ## Any message to import
    @IG::errmsg = ( $lang{any_message_to_import} );
    importmessages();
   }
  else
   {
    @IG::errmsg = ( "$lang{imported_messages}: $import_status" );
    checkfolders();
    displayheaders();
   }

  IG::FileUnlink("$IG::user_dir${IG::S}mail_progress")
    or die("Can't delete file '$IG::user_dir${S}mail_progress'.\n");
 }

###############################################################################
###############################################################################
sub importaction
 {
  if ( $on{subact} eq 'delete' )
   {
    DbQuery("delete from email_imports ".
            "where owner='$auth_user' and id='".DbQuote($on{id})."'");
    $on{default_pane} = 2;
    importmessages();
   }
  else
   {
    DbQuery("select * from email_imports ".
            "where owner='$auth_user' and id='".DbQuote($on{id})."' limit 1");
            
    ( $on{importname},
      $on{pop3owner},
      $on{pop3host},
      $on{pop3port},
      $on{pop3login},
      $on{pop3pwd},
      $on{pop3auth},
      $on{pop3usessl},
      $on{keep_messages},
      $on{autodownload} ) = FetchRow();

    if ($on{subact} eq 'edit')
     {
      importmessages();
     }
    else
     {
      importmessagesagg();
     }
   }
 }
 
###############################################################################
###############################################################################
sub setcontact
 {
  ## load know info
  DbQuery("select email_msgs.sharemode, email_msgs.category,".
          " email_msgs.contactid, email_msgs.pid, email_msgs.sender,".
	  " email_msgs.originalid ".
	  "from email_msgs ".
	  "where email_msgs.id='".DbQuote($on{message_id})."'".
	  " and email_msgs.owner='$auth_user'");
	  
  my (	$_sharemode,
	$_category,
	$_contactid,
	$_protocolid,
	$_sender,
	$_originalid ) = FetchRow();

  ## try to discover the contactid if any
  if ( ! $_contactid )
   {
    my $private;
    ( $_contactid, $private ) = _contactFromEmail( $_sender );
    $_sharemode  = 2 if $private;
   }

  HtmlHead();

  TaskHead( title     => 'IGWebMail',
            icon      => 1 );

  FormHead( cgiaction => 'setcontactagg');

  _set_hiddens();

  Input(    show      => $lang{contact_msg},
            value     => $_contactid,
            type      => 'contactfinder');

  Input(    type      => 'hidden',
            name      => 'message_id');

  Input(    type      => 'hidden',
            value     => $_protocolid,
            name      => 'protocolid');

  Input(    type      => 'hidden',
            value     => $_originalid,
            name      => 'originalid');

  Input(    show      => $lang{document_type},
            type      => 'select',
            zerovalue => 'true',
            name      => 'category',
            value     => $_category,
            data      => \%IG::docs_type );

  Input(    show      => $lang{share_mode},
            type      => 'select',
            name      => 'sharemode',
            value     =>    $_sharemode 
                         || IG::ConfigParam('webmail.share_mode')
                         || '0',
            data      => [([0, $lang{share_mode0}],
                           [1, $lang{share_mode1}],
                           [2, $lang{share_mode2}])]);

  Input(    show      => $lang{update},
            type      => 'submit',
            style     => 'margin-top:15px',
            value     => $lang{update} );

  FormFoot();
  Footer();
  1;
 }

###############################################################################
###############################################################################
sub setcontactagg
 {
  push @IG::errmsg, IG::ContactFinder('contact_msg');
  setcontact() && return if @IG::errmsg;
  
  my $pidLock;
  ($on{protocolid}, $pidLock) = _emailProtocolId( originalid => $on{originalid} )
      unless $on{protocolid};

  QuoteParams();
  DbQuery("update email_msgs set contactid='$in{contactid}',".
	  " sharemode=$in{sharemode}, category='$in{category}',".
	  " pid='$in{protocolid}' ".
	  "where id='$in{message_id}' and owner='$auth_user'");

  HtmlHead();
  TaskHead( title => 'IGWebMail',
            icon  => 1);

  TaskMsg(" $lang{contact_msg_ok} $on{contact}");

  FormHead( target    => 'mainf',
            cgiaction => 'readmessage');

  _set_hiddens();

  Input(    type      => 'hidden',
            name      => 'message_id');

  Input(    show      => $lang{continue},
            type      => 'submit',
            onclick   => "setTimeout('self.close()',500);",
            value     => 'Ok');

  FormFoot();
  Footer();
 }

###############################################################################
###############################################################################
sub viewattachment
 {
  $on{owner} ||= $auth_user;
  my %msg = parse_message( owner   => $on{owner},
                           html_ok => 1,
			   id      => $on{message_id} );

  if (!%msg)
   {
    IG::Warn( "$lang{Err_no_email_msg}. Message-Id: ".
              ( $on{message_id} || 'none' ) );
    return;
   }

  my $attachment = _decode( ${$msg{attachment}[$on{attnum}]}{contents},
                            ${$msg{attachment}[$on{attnum}]}{encoding},
                            ${$msg{attachment}[$on{attnum}]}{contenttype} );

  ## If we have octet-stream contenttype in message attachment
  ## we try to find it again
  if (${$msg{attachment}[$on{attnum}]}{contenttype} =~ /octet\-stream|application\/binary/ )
   {
    ${$msg{attachment}[$on{attnum}]}{contenttype}
       = (IG::FileStat($attachment, 'content'))[0];
    ${$msg{attachment}[$on{attnum}]}{contenttype}
     ||= 'application/octet-stream';
   }

  if ( ${$msg{attachment}[$on{attnum}]}{contenttype} =~ /message\/rfc822/i )
   {
    $on{message_id} = $on{message_id} . '-' . $on{attnum};
    my $filename    = $IG::temp_dir . $S . $on{message_id} . '.mbx';

    open( FH, '>', $filename ) or die("Can't write on '$filename'.\n");
    print FH $attachment;
    close(FH);    
    readmessage();
   }
  else
   {
    IG::DocHead( type           => ${$msg{attachment}[$on{attnum}]}{contenttype},
                 attachment     => ${$msg{attachment}[$on{attnum}]}{filename},
                 expires        => 'now',
                 content_length => length( $attachment )
               );

    PrOut $attachment;
   }
 }

###############################################################################
###############################################################################
sub archiveattach
 {
  $on{owner} ||= $auth_user;
  my %msg = parse_message( owner   => $on{owner},
                           html_ok => 1,
			   id      => $on{message_id} );

  if (!%msg)
   {
    IG::Warn( "$lang{Err_no_email_msg}. Message-Id: ".
              ( $on{message_id} || 'none' ) );
    return;
   }

  my $attachment = _decode( ${$msg{attachment}[$on{attnum}]}{contents},
                            ${$msg{attachment}[$on{attnum}]}{encoding},
                            ${$msg{attachment}[$on{attnum}]}{contenttype} );

  ## Insert into DB
  my $ext = ${$msg{attachment}[$on{attnum}]}{filename};
     $ext =~ s/^.+(\.[^\.]+)$/$1/;
  my $archive_id = IG::MkLastNum('archive');
  my $file_name = $archive_id;
     $file_name =~ s/\.(\d\d)/\_$1/;
  my $docyear = $1;
  my $file_path = $IG::htdocs_dir            . ${S}.
                  $IG::default_lang{archive} . ${S}.
                  $docyear                   . ${S}.
                  $file_name . $ext;

  DbQuery("INSERT INTO archive VALUES ('$archive_id', '', '$tv{today}',".
          " '".DbQuote($msg{contactname})."', '$tv{today}',".
	  " 'Attachment from e-mail $msg{protocolid}', '$on{owner}',".
	  " '', 0, '$msg{contactid}','$msg{date}','')");

  open (DAT, '>', $file_path ) or die("Can't write to '$file_path'.\n");
  print DAT $attachment;
  close (DAT);
  chmod 0664, $file_path;

  IG::Redirect("archive?action=protomodi&amp;id=$archive_id");
 }

###############################################################################
###############################################################################

=head3 _contactFromEmail()

  take the email address to search in contacts
  return ($mastercontactid,$private)

=cut

sub _contactFromEmail
 {
  my $address     = shift;

  ## we want only email address part
  my $addr2search = lc( (IG::WebMail::ParseAddress( $address ))[1] );

  ## clean invalid characters and quote it
  $addr2search =~ s/[^\@\.\!\#\$\%\*\/\?\|\^\{\}\`\'\~\&\+\-\=\_a-z0-9]//gi;
  $addr2search = DbQuote( $addr2search );
  return undef if ! $addr2search;

  DbQuery( <<ENDQUERY );
SELECT c.contactid, c.master, c.email
FROM contacts AS c 
LEFT JOIN contacts AS m ON m.contactid=c.master
WHERE lower(c.email) = '$addr2search'
 and (m.contacttype is null or m.contacttype<>8)
 and (c.contacttype is null or c.contacttype<>8)
ORDER BY c.contactid asc
LIMIT 1
ENDQUERY

  while ( my ( $contactid,
               $contactmaster,
               $contactemail  ) = FetchRow()
        )
   {
    next if $contactemail eq IG::UsrInf('email');
    return ( $contactmaster ? $contactmaster : $contactid );
   }

  return;
 }

###############################################################################
###############################################################################
sub _emailProtocolId
 {
  my %data = @_;
  my $originalid = $data{originalid};
  
  my $lock = AutoReleasedLock->new( resource_id => 'email_protocol' );
  my $pid;
  if( $originalid ) ## find existing messages with the same original and a PID
   {
    DbQuery( "select pid from email_msgs ".
             "where originalid='".DbQuote($originalid)."' and pid<>'' ".
	     "limit 1");
    $pid = FetchRow();
   }
  $pid ||= IG::MkLastNum('email_msgs');
  return ($pid, $lock);
 }

###############################################################################
###############################################################################
sub ckmessages
 {
  my $autodownload_import_count = 0;
  my $downloaded_count          = 0;
  my $tot_downloaded_count      = 0;
  my $tot_spam_msgs_cnt         = 0;
  my $spam_msgs_cnt             = 0;

  my @configs;
  
  ## store email import configurations to autodownload
  DbQuery( "select id, host, port, login, password,".
           "       authmode, usessl, keepmsgs ".
           "from email_imports ".
           "where owner='$auth_user' and autodownload='y' ".
           "order by id" );

  while( my ($id, $host, $port, $login, $password, 
             $authmode, $usessl, $keepmsgs) = FetchRow() )
   {
    push @configs,
         {     account_id             => $id,
	       account_link           => "webmail?".
	                                 "action=importaction&amp;".
	                                 "default_pane=1&amp;".
					 "subact=edit&amp;".
					 "id=".MkUrl($id),
               host                   => $host,
	       port                   => $port,
	       login                  => $login,
	       pwd                    => $password,
	       auth                   => $authmode,
	       usessl                 => $usessl,
	       keep_messages          => $keepmsgs,
	       forced_progress_status => -1 };

    $autodownload_import_count++;
   }

  ## add main user pop3/spool account
  unshift @configs,
          { account_id             => 'Main account',
	    account_link           => "preferences?action=prefs_profile_modi",
	    forced_progress_status => $autodownload_import_count > 0 
	                           ? -1
                                   : 0
          };

  my @account_with_errors;
  my $download_count;
  for ( @configs ) 
   {
    my $_mail_progress_log_msg;
    my $id           = $$_{account_id};
    my $account_link = $$_{account_link};

    _mail_progress_log( (++$download_count).'/'.
                        ($autodownload_import_count+1).
                        ": $id",
                        2 
                      ) if $autodownload_import_count > 0;

    ## get messages
    ( $downloaded_count,
      $spam_msgs_cnt,
      $_mail_progress_log_msg ) = updateheaderdb( %{$_} );

    $downloaded_count ||= 0;
    $spam_msgs_cnt    ||= 0;

    if ( $downloaded_count < 0 )
     {
      push @account_with_errors,
           ( $id 
             ? "<a href=\"$account_link\" target=\"mainf\">".
               MkEntities($id).
               '</a>: '
             : '').
           $_mail_progress_log_msg;
     }
    else
     {
      $tot_downloaded_count += $downloaded_count;
      $tot_spam_msgs_cnt    += $spam_msgs_cnt;
     }
   }

  ## log user filter
  _mail_progress_log( $lang{apply_email_filters}, 2 );
   
  my $filtered_count = IG::WebMail::ApplyUserFilter('INBOX');
  my $filtered_msg   = ($filtered_count + $tot_spam_msgs_cnt)
                     ? " $lang{filtered_messages}: ".
		       ($filtered_count + $tot_spam_msgs_cnt)
		     : '';
  
  my $error_msg = '';
     $error_msg .= ($error_msg eq '' ? '<br>Errors: ' : ',<br>').
                   $_
                   for @account_with_errors;

  _mail_progress_log( $tot_downloaded_count || $error_msg
                      ? "$lang{uploaded_messages}: $tot_downloaded_count $filtered_msg $error_msg"
                      : $lang{any_new_messages},
                      $error_msg ? 3 : 0);
 }

###############################################################################
###############################################################################
sub updateheaderdb
 {
  ## this sub returns ($downloaded_msg_count, $spam_msgs_cnt)
  ## $downloaded_msg_count has these values:
  ##   0  no new messages
  ##   -1 an error occurred
  ##   n+ number of messages downloaded

  my %data = @_;

  $data{target_folder} ||= 'INBOX';
  $data{spool_file}    ||= '';

  $data{keep_messages}   = $data{keep_messages} eq 'y' ? 1
                         : $data{keep_messages} eq 'n' ? 0
                         : IG::ConfigParam('webmail.keep_messages');

  my $forced_progress_status = $data{forced_progress_status};

  ## Delete flag of new emails alert
  unlink $IG::user_dir . $IG::S . 'email_alert';

  ## %month hash is used to convert localtime() dates
  my %month = qw(Jan 1 Feb 2 Mar 3 Apr 4  May 5  Jun 6
		 Jul 7 Aug 8 Sep 9 Oct 10 Nov 11 Dec 12);

  my @datearray;
  my @attachments;
  my $messagenumber = -1;
  my $spam_msgs_cnt;
  my $num_of_msgs;
  my $lastline;
  my $line;
  my $inheader = 1;

  my %db; ## used to store all message values

  local *_catch_message = sub 
   {
    ## Needed to increment progressbar
    $messagenumber++;
    _mail_progress_log( "$lang{uploading_message_num} $messagenumber/$num_of_msgs", 
                        $forced_progress_status || 2 );

    unless ( !$db{message} && $db{subject} =~ /DON'T DELETE THIS MESSAGE/ )
     {
      ## we don't have a message uidl when we use a spool file instead of
      ## a pop3 server, or when we are importing an external message.
      ## In these cases we have to check if message already exists
      if ( !$db{message_id} )
       {
        $db{message_id} = $db{message};
        $db{message_id} =~ s/\nstatus: [^\n]*//i;
        $db{message_id} = IG::Md5Digest( $db{message_id} );

        DbQuery("select sender from email_msgs ".
		"where id='$db{message_id}'".
		" and owner='$auth_user' limit 1");
        $db{message_id} = '' if FetchRow();
       }


      ## Check if we have only an header part
      if ( $inheader )
       {
        ## Ops! any body part?
        my %val = _parse_headpart( $db{message} );
        $db{$_} = $val{$_} foreach keys %val;
        $db{message} .= "\nAny Body Part!";
       }

      ## Check message values and insert it inside database
      if ($db{message_id} && $db{from} && $db{date})
       {
        ## Try to find a plain text content to store inside database
        $db{body} = (split_message(\$db{message}))[1];

        if ( $db{contenttype} =~ /^multipart/i )
         {
          ## it's a multipart message. Thank's to _parse_multipart()
          ## and html_ok (4Â° params) value we will use only rawtext
          $db{body} = ( _parse_multipart( $db{body},
                                          $db{contenttype},
                                          0,
                                          0 ) )[2];
         }
        elsif ( $db{contenttype} !~ /^text/i )
         {
          ## here ther's not text
          $db{body} = '';
         }
        elsif ( $db{contenttype} =~ /^text/i )
         {
          ## it should be text plain or html
          $db{body} = _decode( $db{body}, $db{encoding}, $db{contenttype} );
         }

        ## we need to know if this is a private message
        my $private;
 
        ## First try to link email msg to a contact (by from: address)
	( $db{contactid}, $private ) = _contactFromEmail( $db{from} );

        ## Next try to link email msg to a contact (by to: address)
        if (!$db{contactid})
         { ( $db{contactid}, $private ) = _contactFromEmail( $db{to} ); }

        $db{sharemode} = $private
	                 ? 2
		       	 : IG::ConfigParam('webmail.share_mode') || '0';

	## If the email is connected to a contact we want protocol it
	my $pidLock;
	if ( $db{contactid} && !IG::ConfigParam('webmail.automatic_protocol') )
	 {
          ($db{protocolid}, $pidLock) = 
	            _emailProtocolId( originalid => $db{originalid} )
	      unless $db{protocolid}; ##XXX2TEST can $db{protocolid} <> ''?
         }
        else
         {
          $db{protocolid} = '';
         }

        ## This a message Notification so update original message status
        if ( $db{contenttype} =~ /multipart\/report
                                 .+?
                                 report\-type\=
                                 \"*disposition\-notification\"*/xi
           )
         {
          my $original_id = $db{inreplyto};
          if ( !$original_id )
           {
            ## try to catch last email message id from references
            ($original_id) = $db{references} =~ /(<[^\@<>]+\@[^\@<>]+>)\s*$/;
           }

          IG::WebMail::UpdateEmailMsgStatus( original_id => $original_id,
                                             status      => 'n',
                                             action      => 'add'
                                           ) if $original_id;
         }

	## Is a Spam message?
        if (    $db{spamstatus}                        ## ck spamassassins flag
             && IG::ConfigParam('webmail.trash_spam') )## ck user preference
         {
          $db{folder} = 'TRASH';
          $spam_msgs_cnt++;
         }
        else
         {
          $db{folder} = $data{target_folder};
         }

        ## We need this body value only to use in search engine and
        ## search messages by contents
        $db{body}		= _clean_body( $db{body} );
        $db{threadid}           = _get_threadid($db{subject},$db{references});
        $db{from}		= substr($db{from}, 0, 250);

        DbWrite( action => 'insert',
                 table  => 'email_msgs',
                 values => [ $db{message_id},
                             $db{date},
                             $db{time},
                             $db{from},
                             $db{contactid},
                             $db{to},
                             $auth_user,
                             $db{subject},
                             $db{folder},
                             $db{contenttype},
                             $db{status},
                             $db{messagesize},
                             $db{sharemode},
                             '',
                             $db{body},
                             $db{protocolid},
                             $db{originalid},
                             $db{references},
                             $db{threadid}
                           ]);

        undef $pidLock; ## release email protocol lock
        
	## Check folder 
	my $folder_path = "$IG::user_dir${S}MailBox${S}$db{folder}";
        IG::WebMail::MkSpoolDir( $folder_path );

        ## Save message on filesystem
        open (BOX, '>', "$folder_path${S}$db{message_id}" )
          or die("Can't write new message to ".
                 "'$folder_path${S}$db{message_id}'.\n");
        print BOX $db{message};
        close (BOX);

        ##XXX2IMPROVE
        if ( IG::ConfigParam('webmail.auto_tag') &&
	     $db{contenttype} !~ /multipart\/report
                                 .+?
                                 report\-type\=disposition\-notification/xi )
         {
          my $original_id = $db{inreplyto};
          if ( !$original_id )
           {
            ## try to catch last email message id from references
            ($original_id) = $db{references} =~ /(<[^\@<>]+\@[^\@<>]+>)\s*$/;
           }

          if ( $original_id )
           {
	    my %tagnames;
	    $original_id = DbQuote($original_id);
	    DbQuery("select email_msgtags.name ".
                    "from email_msgs ".
		    "left join email_msgtags ".
		    "on email_msgs.id=email_msgtags.msgid ".
                    "where email_msgs.originalid='$original_id' ".
		    "and email_msgtags.name<>'' ".
                    "and owner='$auth_user' ".
                    "order by email_msgtags.name");
	    while( my $tag_name = FetchRow() ) 
	     {
              $tagnames{$tag_name} = 1 if $tag_name;
	     }
            for my $tag_name (keys %tagnames)
	     {
	      my $tagid   = MkId(32);
	      DbQuery("insert into email_msgtags values".
		      " ('$tagid', '$db{message_id}', '".DbQuote($tag_name)."')");
	     } 
           }
         }
       }
     }

    ## reset %db values to parse a new message
    %db = ( from        => 'N/A',
            to          => 'N/A',
            date        => 'N/A',
            time        => 'N/A',
            subject     => 'N/A',
            contenttype => 'N/A',
            message     => $line,
            messagesize => length($line) );
   };

  local *_read_spool = sub 
   {  
    if ( $line =~ /^From / && $db{contenttype} !~ /message\/rfc822/i )
     {
      $messagenumber == -1
      ? $messagenumber++
      : _catch_message();

      $db{message} = $line;
      $inheader    = 1;
      $lastline    = 'NONE';
     }
    else
     {
      $db{message}     .= $line;
      $db{messagesize} += length($line);

      if (    $inheader 
           && $line =~ /^\r*$/
           && $db{contenttype} !~ /message\/rfc822/i
         )
       {
        my %val = _parse_headpart( $db{message} );
        $db{$_} = $val{$_} foreach keys %val;
        $inheader = 0; ## from now we will read body part
       }
     }
   };

  _mail_progress_log( $lang{connecting_to_server}, $forced_progress_status || 1);

  ## Use a Pop3 server or a Spoolfile according to user preferences
  if ( !$data{spool_file} && ($IG::pop3_conf{host} || $data{host}) )
   {
    ## let's read email from pop3 server   
    my $pop3_login   = '';
    my $pop3_pwd     = '';
    my $pop3_host    = $data{host}    || $IG::pop3_conf{host};
    my $pop3_port    = $data{port}    || $IG::pop3_conf{port}    || 110;
    my $pop3_auth    = $data{auth}    || $IG::pop3_conf{auth}    || 'BEST';
    my $pop3_timeout = $data{timeout} || $IG::pop3_conf{timeout} || 60;
    my $pop3_usessl  = $data{usessl}  || $IG::pop3_conf{usessl}  || '0';
    my $pop3_debug   = $data{debug}   || $IG::pop3_conf{debug}   || '0';

    ## Set a login ad a password
    if ( !$data{login} )
     {
      if ( IG::UsrInf('pop3login') && IG::UsrInf('pop3pwd') )
       {
        $pop3_login = IG::UsrInf('pop3login');
        $pop3_pwd   = IG::UsrInf('pop3pwd');
       }
      else
       {
        $pop3_login = $IG::pop3_conf{login} || $auth_user;
        $pop3_pwd   = $IG::pop3_conf{pwd}   || IG::UsrInf('passwd');
       }
     }
    else
     {
      $pop3_login = $data{login};
      $pop3_pwd   = $data{pwd};
     }

    ## try to connect to POP3 server
    my $pop = new Mail::POP3Client( USER      => $pop3_login,
				    PASSWORD  => $pop3_pwd,
				    HOST      => $pop3_host,
				    PORT      => $pop3_port,
				    AUTH_MODE => $pop3_auth,
				    TIMEOUT   => $pop3_timeout,
				    USESSL    => $pop3_usessl,
				    DEBUG     => $pop3_debug );

    ## Retrieve the number of messages
    $num_of_msgs = $pop->Count();

    if ( $num_of_msgs == -1 )
     {
      ## connection error
      my $_err = sprintf( $lang{Err_no_connection},
                          $pop3_host,
                          $pop3_login,
                          $pop->Message() );

      _mail_progress_log( $_err, $forced_progress_status || 3 );

      eval { $pop->Close(); }; ## it will fails if the connection was not made
      return ( -1, 0, $_err );
     }
    elsif ( !$num_of_msgs )
     {
      ## any new message
      _mail_progress_log( $lang{any_new_messages}, 
                          $forced_progress_status || 0);
      $pop->Close();
      return ( 0, 0, $lang{any_new_messages} );
     }
    else
     {
      ## start to download messages
      _mail_progress_log( "$lang{uploading_message_num} 0/$num_of_msgs", 
                          $forced_progress_status || 2 );
     }

    for my $i (reverse 1 .. $num_of_msgs)
     {
      ## Get Uidl from server
      my $uidl = $pop->Uidl($i);
      
      ## exception
      if ( !$uidl )
       {
        my $_err = "The POP3 Server on host '$pop3_host' ".
                   "doesn't support 'UIDL' feature!";

        _mail_progress_log( $_err, $forced_progress_status || 3 );
        $pop->Close();
        return( -1, 0, $_err );
       }

      ## Check and adjust Uidl
      (undef, $uidl) = split /\s/, $uidl, 2;
      chomp( $uidl = Mime::Base64::encode_base64($uidl) );
      $uidl =~ tr/\/\+/\_\-/; ## we want to use uidl as a valid filename

      ## exception
      if ( length($uidl) > 300 )
       {
        my $_err = "The POP3 Server has returned ".
                   "a strange Uidl larger than 300 chars!";

        _mail_progress_log( $_err, $forced_progress_status || 3 );
        $pop->Close();
        return( -1, 0, $_err );
       }

      ## Check if we already have this message
      DbQuery( "select sender from email_msgs ".
	       "where id='$uidl' and owner='$auth_user' limit 1");
      if ( FetchRow() )
       {
        $data{keep_messages}
        ? last  ## we don't want to parse all spool
        : next; ## we want to be sure to have parsed all messages! 
       }

      ## Retrieve message from pop3 server
      my @msg  = $pop->Retrieve($i);

      ## exception
      if ( !@msg )
       {
        my $_err = "There are new messages in POP3 server ".
                   "but we can't retrieve them.";
        _mail_progress_log( $_err, $forced_progress_status || 3 );
        $pop->Close();
        return( -1, 0, $_err );
       }

      unshift @msg, ("From $IG::smtp_conf{host} ".
		     scalar(localtime) ) if $msg[0] !~ /^From /;

      ## Parse and save message
      for (@msg,' ')
       {
        $line = "$_\n";
        _read_spool();
       }
      $db{message_id} = $uidl;
     }

    ## Remove messages from server
    if ( ! $data{keep_messages} &&
	 ($on{action} eq 'getnewmessages' || 
	  $on{action} eq 'ckmessages' || 
	  $on{action} eq 'importaction')
       )
     { $pop->Delete($_) for 1 .. $num_of_msgs; } 

    ## Cacth last message
    _catch_message() if $db{messagesize};
    $pop->Close();
   }
  else 
   {
    ## let's read email from a spoolfile (or an imported file)

    if ( !$data{spool_file} )
     {
      if ($IG::homedirspools eq 'yes')
       {
        die("Set a value to '\$homedirspoolname' in IGSuite config file.\n")
          if !$IG::homedirspoolname;
        my ($homedir) = (getpwnam($auth_user))[7]
			  or die("System User '$auth_user' doesn't exist!\n");

        $data{spool_file} = $homedir . $IG::S . $IG::homedirspoolname;
       }
      elsif ($IG::hashedmailspools eq 'yes')
       {
        $auth_user =~ /^(.)(.)/;
        my $firstchar  = $1;
        my $secondchar = $2;
        $data{spool_file} = $IG::mailspooldir . $IG::S .
                 $firstchar        . $IG::S .
                 $secondchar       . $IG::S .
                 $auth_user;
       }
      else
       {
        $data{spool_file} = $IG::mailspooldir . $IG::S . $auth_user;
       }
     }

    ## Open Spoolfile to read messages
    open ( SPOOL, '<', $data{spool_file} )
      or die("Can't read mail spool file '$data{spool_file}'.\n");

    ## Check how many message we have to read (it's not the best way!)
    while (<SPOOL>) { $num_of_msgs++ if /^From /; }

    if ( !$num_of_msgs )
     {
      ## any new message
      _mail_progress_log( $lang{any_new_messages}, 
                          $forced_progress_status || 0);
      close(SPOOL) or die("Error can't close '$data{spool_file}' file.\n");
      return( 0, 0, $lang{any_new_messages} );
     }
    
    ## reload the file
    sysseek( SPOOL, 0, 0 ) or die("Can't seek init of '$data{spool_file}'.\n");

    ## Update progressbar
    _mail_progress_log( "$lang{uploading_message_num} 0/$num_of_msgs", 
                        $forced_progress_status || 2 );

    ## Read mail box one row at time
    _read_spool() while (defined($line = <SPOOL>));

    ## Catch last message
    _catch_message();

    close(SPOOL);

    ## Check "keep_messages" preference 
    if ( ! $data{keep_messages} &&
	 ($on{action} eq 'getnewmessages' || $on{action} eq 'ckmessages')
       )
     {
      ## Delete mailbox
      open (SPOOL, '>', $data{spool_file})
        or die("$lang{couldnt_write} $data{spool_file}!\n");
      close (SPOOL)
        or die("$lang{couldnt_close} $data{spool_file}!\n");
     }

    ## Touch IGSuite MailBox directory
    utime time(), time(), "$IG::user_dir${S}MailBox${S}";
   }

  ## Needed to end progressbar
  $messagenumber = 0 if $messagenumber < 1;
  return ($messagenumber, $spam_msgs_cnt);
 }

###############################################################################
###############################################################################
sub _mail_progress_log
 {
  ## Status values
  ##  -1  Used when updateheaderdb() is called for multi accounts
  ##   0  Download end (no error)
  ##   1  connecting
  ##   2  downloading
  ##   3  Download end (there are exceptions)
  
  my ($message, $status) = @_;
  $status ||= '0';
  
  return if $status == -1;

  ## print also in stdout in commandline mode
  PrOut "$message\n" if !$status && $IG::request_method eq 'commandline';

  open (MP, '>', "$IG::user_dir${S}mail_progress")
    or die("Can't write on '$IG::user_dir${S}mail_progress'.\n");

  print MP "$message\n$status";
  close(MP);
 }

###############################################################################
###############################################################################
sub _clean_body
 {
  ## we use this function to clean the body message and insert it inside the
  ## database only to perform some search on email message body
  require IG::Utils;
  my $body = shift;
  $body = IG::HtmlUntag($body);
  $body = IG::MkEntities($body);
  $body	=~ s/[^\\\!\?\%\&\(\)\^\[\]\#\@\$\:\;\Â°\,\<\>\.\s\*\+\=\/\-\_\'\"a-zA-Z0-9]/ /g;
  1 while $body =~ s/\s{2,}/ /g;
  return $body;
 }

###############################################################################
###############################################################################
sub messageaction
 {
  my @messageids = ref($on{message_ids}) eq 'ARRAY'
		 ? @{$on{message_ids}}
		 : ($on{message_ids});

  if ( $on{views} eq 'perthread' )
   {
    ## expand thread ids
    my @temp_ids;
    for ( @messageids )
     {
      DbQuery("select id from email_msgs where threadid='$_'");
      while (my $temp_id = FetchRow()) { push @temp_ids, $temp_id; } 
     }
    @messageids = @temp_ids;
   }
 
  if ($on{actiontarget} && $on{actiontarget} ne '---')
   {
    if ($on{actiontarget} =~ /^user\:([\w]+)/)
     {
      ## delivery/move message to another user
      my $owner     = $1;
      my $owner_box = IG::UserDir($owner) . "${S}MailBox${S}INBOX";

      for my $id ( @messageids )
       {
	next if !$id;
        DbQuery("select folder from email_msgs ".
		"where id='".DbQuote($id)."' and owner='$auth_user'");
        my $folder = FetchRow();

	die "file $IG::user_dir${S}MailBox${S}$folder${S}$id does not exist.\n"
	     if ! -e "$IG::user_dir${S}MailBox${S}$folder${S}$id";
        die "directory '$owner_box does not exist.\n"
	     if ! -d $owner_box;
	
        DbQuery( query => [("update email_msgs ".
                            "set folder='INBOX', owner='$owner',".
			    "    status='', threadid='' ".
		            "where id='$id' and owner='$auth_user'",

			    "update comments ".
			    "set referenceid='".DbQuote($owner."_".$id)."' ".
			    "where referenceproc='webmail'".
			    " and referenceid='".DbQuote($auth_user."_".$id)."'"
		           )] );

        IG::FileCopy( "$IG::user_dir${S}MailBox${S}$folder${S}$id",
		      $owner_box . ${S} . $id,
		      1 );
       }

      ## touch email flag
      IG::FileTouch("$IG::cgi_dir${S}data${S}users${S}$owner${S}email");
     }
    elsif ($on{actiontarget} =~ /^folder\:([\w\s\d]+)/)
     {
      ## move message in another folder      
      my $target_folder = $1;
      die("$lang{folder_hitquota}.\n") if $IG::WebMail::hitquota
                                          && $target_folder ne 'TRASH';

      IG::WebMail::MkSpoolDir("$IG::user_dir${S}MailBox${S}$target_folder");

      for my $id (@messageids)
       {
	next if !$id;
        DbQuery("select folder from email_msgs ".
		"where id='$id' and owner='$auth_user'");
        my $folder = FetchRow();
	next if $folder eq $target_folder;

	die "file $IG::user_dir${S}MailBox${S}$folder${S}$id does not exist.\n"
	     if ! -e "$IG::user_dir${S}MailBox${S}$folder${S}$id";
        die "directory $IG::user_dir${S}MailBox${S}$target_folder does not exist.\n"
	     if ! -d "$IG::user_dir${S}MailBox${S}$target_folder";

        DbQuery("update email_msgs set folder='$target_folder' ".
		"where id='$id' and owner='$auth_user'");

        IG::FileCopy("$IG::user_dir${S}MailBox${S}$folder${S}$id",
		     "$IG::user_dir${S}MailBox${S}$target_folder${S}$id",
		     1);
       }
     }
    elsif ( $on{actiontarget} eq 'delete' )
     {
      ## delete message(s)
      for my $id ( @messageids )
       {
	next if !$id;
        DbQuery("select folder from email_msgs ".
		"where id='$id' and owner='$auth_user'");
        my $folder = FetchRow();

        ## delete from db
        DbQuery("delete from email_msgs ".
		"where id='$id' and owner='$auth_user'");

        ## delete from fs
        IG::FileUnlink( "$IG::user_dir${S}MailBox${S}$folder${S}$id" );
       }
     }
    elsif ($on{actiontarget} =~ /^mark\_as\:(\w+)/)
     {
      ## change messages status
      my $rule = $1;
      my %actions = ( read      => 'r',
                      unread    => 'r',
                      replied   => 'e',
                      unreplied => 'e' );

      for my $id ( @messageids )
       {
        next if !$id;

        IG::WebMail::UpdateEmailMsgStatus
         ( message_id => $id,
           status     => $actions{$rule},
           action     => $rule =~ /^un/ ? 'delete' : 'add' );
       }
       
      $on{message_id} = $messageids[0] if $on{messageaftermove};
     }
    elsif ($on{actiontarget} =~ /^tag\_as\:([\w\d\_\-\.]+)/)
     {
      my $tagname = DbQuote($1);
      
      for my $id (@messageids)
       {
        next if !$id;       
        my $tagid   = MkId(32);
        DbQuery( query=> [( "delete from email_msgtags ".
	                    "where msgid='$id' and name='$tagname'",
	                
	                    "insert into email_msgtags values".
	                    " ('$tagid', '$id', '$tagname')"
                          )] );
       }
      $on{message_id} = $messageids[0] if $on{messageaftermove};       
     }
    elsif ($on{actiontarget} eq 'untag' )
     {
      for my $id ( @messageids )
       {
        DbQuery( "delete from email_msgtags where msgid='".DbQuote($id)."'" );
       }
     }
    elsif ($on{actiontarget} =~ /^sharemode\:([012])/ )
     {
      my $sharemode = $1;

      for my $id (@messageids)
       {
        next if !$id;
        DbQuery("update email_msgs set sharemode=$sharemode ".
                "where id='$id' and owner='$auth_user'");
       }
      $on{message_id} = $messageids[0] if $on{messageaftermove};
     }
    elsif ($on{actiontarget} =~ /^set\_threadid\:(\w+)/ )
     {
      my $thread_action = $1;
      my $new_thread_id = MkId(100);

      for my $id (@messageids)
       {
        next if !$id;
        $new_thread_id = MkId(100) if $thread_action eq 'split';
        DbQuery("update email_msgs set threadid='$new_thread_id' ".
                "where id='$id' and owner='$auth_user'");
       }
      $on{message_id} = $messageids[0] if $on{messageaftermove};
     }
   }

  if ($on{backto})
   {
    my $ids; ## try to restore previous selected message ids
    $ids .= "&amp;message_ids=" . MkUrl($_) for @messageids;
    IG::Redirect("webmail?q=1&amp;$on{backto}$ids");
   }
  elsif ($on{messageaftermove} && $on{actiontarget} ne 'mark_as:unread')
   {
    checkfolders();
    readmessage();
   }
  else
   {
    checkfolders();	
    displayheaders();
   }
 }

###############################################################################
###############################################################################
sub moveinfolder
 {
  my ($msg_id, $msg_folder, $counter);

  DbQuery("select id, folder from email_msgs ".
	  "where owner='$auth_user' and sender<>''");
  while ( ($msg_id, $msg_folder) = FetchRow() )
   {
    if (-e "$IG::user_dir/MailBox/$msg_id")
     {
      $msg_folder ||= 'INBOX';
      $counter++;
      IG::WebMail::MkSpoolDir("$IG::user_dir${S}MailBox${S}$msg_folder");

      IG::FileCopy("$IG::user_dir${S}MailBox${S}$msg_id",
		   "$IG::user_dir${S}MailBox${S}$msg_folder${S}$msg_id",
		   1);
     }
   }
  PrOut "Done! moved $counter messages in their folders\n";
 }

###############################################################################
###############################################################################
sub emptytrash
 {
  IG::WebMail::EmptyTrash();

  checkfolders();
  displayheaders();
 }

###############################################################################
###############################################################################
sub editfolders
 {
  my $total_folder_size;
  my $total_messages;
  
  HtmlHead( shortcuts => _short_cuts(),
            title     => $lang{folders} );
            
  TaskHead( title     => $lang{folders},
            width     => '100%');

  FormHead( name      => 'composeform',
            float     => 'left',
            labelstyle=> 'width: 200px',	
            cgiaction => 'addfolder');

  _set_hiddens();

  TaskMsg (
		  Input (	name=>'foldername',
				show=>$lang{add_folder},
				type=>'text',
				size=>16,
				maxlen=>16 ).

		  Input (	name=>'addfolder',
				type=>'submit',
				value=>$lang{add}), 7);

  FormFoot();
  TaskListMenu (	[$lang{folders}],
			[$lang{messages}],
			[$lang{size}],
			[""]
	       );

  foreach ( sort keys %folderinfo )
   {
    next if $_ eq 'PROTOCOLS';
    my $escaped_folder = MkUrl( $_ );
    $total_folder_size += $folderinfo{$_}{size};
    $total_messages    += $folderinfo{$_}{msgs};

    TaskListItem
     (
	[$_],
	[$folderinfo{$_}{msgs},
	 '',
	 'align=right'],
	[IG::MkByte($folderinfo{$_}{size}),
	 '',
	 'align=right'],
	[ Img( src    => "$IG::img_url/email_import.gif",
	       width  => 16,
	       style  => 'margin:0 2px 0 10px',
	       title  => $lang{import_messages},
	       href   => "webmail?action=importmessages&amp;".
	                         "folder=$escaped_folder" ).

	  Img( src    => "$IG::img_url/email_export.gif",
	       width  => 16,
	       title  => $lang{export_messages},
	       href   => "webmail?action=exportmessages&amp;".
	                         "folder=$escaped_folder" ).

	  ( $_ !~ /^(INBOX|SENT|TRASH|DRAFTS)$/
	    ? Img( src     => "$IG::img_url/delete.gif",
                   width   => 16,
		   title   => $lang{delete_folder},
		   href    => "webmail?".
		              "action=deletefolder&amp;".
		              "foldername=$escaped_folder&amp;".
		              "order=$on{order}&amp;".
		              "folder=$folder&amp;".
		              "views=$on{views}&amp;".
		              "tags=$on{tags}&amp;".
		              "sortdirection=$on{sortdirection}&amp;".
		              "pos=$on{pos}",
                   onclick => IG::JsConfirm( $lang{are_you_sure} ) ) 
	    : '')
        ]
     );
   }
   
  TaskListItem
   ( [ $lang{utilized_space},
       '',
       "style=\"background:$IG::clr{bg_low_evidence};font-weight:bold\""],
     [ $total_messages || '0',
       '',
       "style=\"background:$IG::clr{bg_low_evidence}; text-align:right;\""],
     [ IG::MkByte($total_folder_size),
       '',
       "style=\"background:$IG::clr{bg_low_evidence}; text-align:right;\""],
     [ Img( src    => "$IG::img_url/email_export.gif",
            width  => 16,
            style  => 'margin-left:10px',
            title  => $lang{export_messages},
            href   => "webmail?action=exportmessages&amp;".
	                      "folder=all" ),
       '',
       "style=\"background:$IG::clr{bg_low_evidence}\""]
   );

  TaskListFoot();

  Footer();
  1;
 }

###############################################################################
###############################################################################
sub addfolder
 {
  $on{foldername} =~ s/[^\w\s\d]//g;
  $on{foldername} =~ s/^\s+//; ## trim leading spaces
  $on{foldername} =~ s/\s+$//; ## trim trailing spaces
  $on{foldername} = uc($on{foldername});

  if (!$on{foldername} || $on{foldername} =~ /^(INBOX|SENT|TRASH|ALL|DRAFT)$/ )
   { push @IG::errmsg, $lang{Err_invalid_folder_name}; }
  elsif (length($on{foldername}) > 16)
   { push @IG::errmsg, $lang{foldername_long}; }

  editfolders() && return if @IG::errmsg;

  ## folders have empty msg id and status equal to 'f'
  QuoteParams();
  DbQuery("insert into email_msgs".
	  " values ('', '$tv{today}', '', '', '', '', '$auth_user',".
	  " '', '$in{foldername}', '', 'f', 0, 1, '', '', '', '', '', '')");

  ## Make mail spool dir
  IG::WebMail::MkSpoolDir("$IG::user_dir${S}MailBox${S}$on{foldername}");

  IG::Redirect( "webmail?".
		"action=editfolders&amp;".
		"order=$on{order}&amp;".
		"views=$on{views}&amp;".
	        "tags=$on{tags}&amp;".
		"folder=$escapedfolder&amp;".
		"pos=$on{pos}" );
 }

###############################################################################
###############################################################################
sub deletefolder
 {
  my $msg_id;
  $on{foldername} =~ s/[^\w\s\d]//g;
  $on{foldername} = uc($on{foldername});

  die("You can't delete this folder!\n")
    if $on{foldername} =~ /^(INBOX|SENT|TRASH|DRAFTS)$/i;

  ## move files in TRASH directory
  QuoteParams();
  DbQuery("select id from email_msgs ".
	  "where owner='$auth_user' and folder='$in{foldername}'");
  while ( ($msg_id) = FetchRow() )
   {
    if (-e "$IG::user_dir/MailBox/$on{foldername}/$msg_id" && $msg_id)
     {
      IG::FileCopy("$IG::user_dir/MailBox/$on{foldername}/$msg_id",
		   "$IG::user_dir/MailBox/TRASH/$msg_id",
		   1);
     }
   }

  ## update folder field in database
  QuoteParams();
  DbQuery(query=>[( "delete from email_msgs ".
		    "where owner='$auth_user'".
		    " and folder='$in{foldername}' and sender=''",

		    "update email_msgs set folder='TRASH' ".
		    "where owner='$auth_user' and folder='$in{foldername}'"
		 )] );

  IG::Redirect( "webmail?".
		"action=editfolders&amp;".
		"order=$on{order}&amp;".
		"views=$on{views}&amp;".
	        "tags=$on{tags}&amp;".
		"folder=$escapedfolder&amp;".
		"pos=$on{pos}" );

  ## Delete folder directory
  rmdir("$IG::user_dir/MailBox/$on{foldername}")
    or die("Can't delete mail folder dir ".
           "'$IG::user_dir/MailBox/$on{foldername}'.\n");
 }

###############################################################################
###############################################################################
## Show address book
sub addressbook
 {
   HtmlHead();
   TaskHead(	title => $lang{contacts},
		icon  => 1,
		width => '100%' );

   my %addresses;
   my ($name, $email, $address, $id, $master);

   $on{preexisting} =~ s/(\s+)?,(\s+)?/,/g;
   my $preexisting = MkUrl($on{preexisting});

   ## Draw alphabet
   IG::AlphabetSelector( param   => 'alphabet',
			 link    => "webmail?".
				    "action=addressbook&amp;".
		      		    "field=$on{field}&amp;".
		    		    "preexisting=$preexisting" );

   FormHead (	formaction=>"javascript:Update('" . $on{field} . "', 1)",
		name=>'addressbook'
            );
   PrOut '<div style="margin-bottom:5px; border:1px solid #CCCCCC;'.
         ' width:100%; height:300px; overflow-y:auto; clear:both;">';

   if ($on{master})
    {
     QuoteParams();
     DbQuery( "select contactname from contacts ".
              "where contactid='$in{master}'" );
     my $mastername = (FetchRow())[0];
     TaskMsg( "$on{master} - $mastername", 4 );
	
     DbQuery("select contactid, contactname, email, master from contacts ".
	     "where (master='$in{master}' or contactid='$in{master}')".
	     " and email<>'' order by contactname");
    }
    else
    {
     QuoteParams();
     DbQuery("select contacts.contactid, contacts.contactname,".
             " contacts.email, contacts.master ".
	     "from contacts ".
             "left join contacts as staff ".
             "on staff.master = contacts.contactid and staff.email<>'' ".
	     "left join contacts as masterCnt ".
	     "on masterCnt.contactid = contacts.master ".
             "where ".
               ($on{alphabet} ne 'all' 
		? "substr(contacts.contactname,1,1)='$in{alphabet}' and " 
	    	: '').
               "(contacts.email<>'' or (contacts.master='0' and staff.email<>'')) ".
               "and contacts.contacttype<>1 and ".
	       
	       ## skip private and not owned contacts
	       "(contacts.contacttype<>8 or contacts.owner='$auth_user') and ".
	       "(masterCnt.contactid is null or masterCnt.contacttype<>8 or ".
	        "masterCnt.owner='$auth_user')".
		
             "order by contacts.contactname");
    }

   TaskListMenu([ Input(name    => 'allbox',
                        value   => 0,
                        override=> 1,
                        onclick => 'CheckAll()',
                        type    => 'checkbox')],
                ['']);

   my %_dejavue;
   while ( ($id, $name, $email, $master ) = FetchRow() )
    {
     next if $_dejavue{$id}++;
     $address = "\"$name\" <$email>";

     TaskListItem([ $email eq '' 
                    ? '' 
		    : Input( type    => 'checkbox',
			     name    => 'to',
			     value   => $address ),
		   '','style="width:20px"'],
		  [ $name,
		    $on{master} || $master
		    ? ''
		    : "webmail?".
			"action=addressbook&amp;".
			"field=$on{field}&amp;".
			"master=$id&amp;".
			"preexisting=$preexisting&amp;".
			"alphabet=$on{alphabet}"
		  ]);
    }
   
   PrOut TaskListFoot(12).
	 '<input type="hidden" name="remainingstr" value="'.
	 MkEntities( $on{preexisting} ). '">';
	 
   PrOut '</div>';

   Input (	type=>'submit',
		name=>'mailto.x',
		value=>'OK');

   Input (	type=>'button',
		name=>'apply',
		float=>'left',
		value=>$lang{apply},
		onclick=>"Update('$on{field}',0);");

   Input (	type=>'button',
		value=>$lang{cancel},
		float=>'left',
		onclick=>'window.close();');

   FormFoot();

   PrOut '<script language="JavaScript">
      <!--
      PreCheck("'.$on{field}.'");

      function Update(whichfield,closeWindow)
      {
         var e2; 
	 if (whichfield == "to0")
	    e2 = window.opener.document.composeform.to0.value;
	 else if (whichfield == "cc0")
	    e2 = window.opener.document.composeform.cc0.value;
	 else
	    e2 = window.opener.document.composeform.bcc0.value;
         for (var i = 0; i < document.addressbook.elements.length; i++)
         {
            var e = document.addressbook.elements[i];
	    if (e.name == "to" ) {
	       var idx = e2.indexOf( e.value );
	       if( idx >= 0 ) 
		  e2 = e2.substring( 0, idx )+e2.substring( idx+e.value.length );
	       if( e.checked ) {
                 if (e2)
                    e2 += ",";
                 e2 += e.value;
	       }
	    }
         }
	 e2 = e2.replace(/,,+/g, ",");
	 e2 = e2.replace(/(^,|,$)/g, "");
         if (whichfield == "to0")
	   {
            window.opener.document.composeform.to0.value = e2;
            window.opener.document.composeform.to.value = e2;
	   }
         else if (whichfield == "cc0")
	   {
            window.opener.document.composeform.cc0.value = e2;
            window.opener.document.composeform.cc.value = e2;
	   }
         else
	   {
            window.opener.document.composeform.bcc0.value = e2;
	   }
	 if( closeWindow )
           window.close();
      }

      function PreCheck(whichfield) 
      {
         var e2;
	 if (whichfield == "to0")
	    e2 = window.opener.document.composeform.to0.value;
	 else if (whichfield == "cc0")
	    e2 = window.opener.document.composeform.cc0.value;
	 else
	    e2 = window.opener.document.composeform.bcc0.value;
         for (var i = 0; i < document.addressbook.elements.length; i++)
         {
            var e = document.addressbook.elements[i];
            if (e.name == "to" && e2.indexOf(e.value) >= 0)
            {
	       e.checked = true;
            }
         }
      }

      function CheckAll()
      {
         for (var i=0;i<document.addressbook.elements.length;i++)
         {
            var e = document.addressbook.elements[i];
            if (e.name != "allbox")
               e.checked = document.addressbook.allbox.checked;
         }
      }

      //-->
      </script>';
   Footer();
 }

###########################################################################
###########################################################################
sub extendedsearch
 {
  my %search_folder;
  $on{search_owner} ||= $auth_user;
  DbQuery("select folder from email_msgs ".
          ( $on{search_owner} ne 'all'
            ? "where owner ='".DbQuote($on{search_owner})."' "
            : '' ).
          "group by folder order by folder");
  while ( my $folder = FetchRow() )
   {
    $search_folder{$folder} = $lang{$folder} || $folder;
   }

  my $html = FormHead( cgiaction   => 'findexec',
                       name        => 'extsearch',
                       enctype     => 'multipart/form-data',
                       labelstyle  => 'width: 150px',
                       method      => 'get', ## so we can add searchs to favorites
                       autofocus   => $on{extendedsearch} ? 'false' : 'true'
	             );
  
  $html .= "<table style=\"width:100%;\">".
           "<tr><td valign=\"top\">" if $IG::screen_size eq 'large';

  $html .= Input( type     => 'hidden',
                  name     => 'extendedsearch',
                  method   => 'html',
                  override => 1,
                  value    => 1 ).
     
           Input( type     => 'logins',
                  label    => $lang{owner},
                  style    => 'width:220px;',
                  value    => $auth_user,
                  onchange => 'extsearch.extendedsearch.value = 2; document.extsearch.submit();',
                  allvalue => 1,
                  zerovalue=> 1,
                  name     => 'search_owner' ).

           Input( type     => 'text',
                  label    => $lang{with_sender},
                  style    => 'width:220px;',
                  name     => 'search_sender' ).
      
           Input( type     => 'text',
                  label    => $lang{with_receiver},
                  style    => 'width:220px;',
                  name     => 'search_receiver' ).
  
           Input( type     => 'date',
                  label    => $lang{from_date},
                  style    => 'width:70px;',
                  name     => 'search_datefrom' ).

           Input( type     => 'date',
                  label    => '&nbsp;-',
                  labelstyle => 'width: 10px',
                  float    => 'left',
                  style    => 'width:70px;',
                  name     => 'search_dateto' ).
 
           Input( type     => 'text',
                  label    => $lang{with_subject},
                  style    => 'width:220px;',
                  name     => 'search_subject' ).
 
           Input( type     => 'text',
                  label    => $lang{with_body},
                  style    => 'width:220px;',
                  name     => 'search_body' ).
 
           Input( type     => 'contactfinder',
                  label    => $lang{contact},
                  style    => 'width:190px;',
                  name     => 'contactid' );
     
  $html .= "</td><td valign=\"top\">" if $IG::screen_size eq 'large';
     
  $html .= Input( type     => 'select',
                  label    => $lang{status},
                  zerovalue=> 'true',
                  style    => 'width:125px;',
                  data     => { unread => $lang{unread_messages},
                                read   => $lang{read_messages} },
                  name     => 'search_readstate' ).

           Input( type     => 'select',
                  zerovalue=> 'true',
                  style    => 'width:125px;',
                  data     => { unreplied => $lang{unreplied_messages},
                                replied   => $lang{replied_messages} },
                  float    => 'left',
                  name     => 'search_repliedstate' );

  ## Translate folders name
  my %validfolders;
  $validfolders{$_} = $folderinfo{$_}{name} for (keys %folderinfo);
  $on{search_folder} = '' if $on{search_folder} eq 'all';

  $html .= Input( show     => $lang{folder},
                  name     => 'search_folder',
                  data     => \%search_folder,
                  zerovalue=> 'true',
                  value    => $on{search_folder},
                  override => 1,
                  style    => 'width:250px;',
                  type     => 'select');
  
  $html .= Input( show     => 'Tag',
                  name     => 'search_tag',
                  data     => IG::WebMail::GetTags(),
                  zerovalue=> 'true',
                  value    => $on{search_tag},
                  override => 1, 
                  style    => 'width:230px;',
                  type     => 'combo').

           Input( show     => $lang{document_type},
                  type     => 'select',
                  zerovalue=> 'true',
                  data     => \%IG::docs_type,
                  style    => 'width:250px;',
	          name     => 'search_category').
     
           Input( type     => 'select',
                  label    => $lang{share_mode},
                  labelstyle=> 'font-size:10px; width:150px',
                  style    => 'width:250px;',
                  value    => $on{search_sharemode},
                  zerovalue=> 'true',
                  data     => [([ 1, $lang{share_mode0} ],
	                        [ 2, $lang{share_mode1} ],
                                [ 3, $lang{share_mode2} ])],
                  name     => 'search_sharemode' ).
     
           Input( type     => 'text',
                  label    => "$lang{size} ($lang{from}-$lang{to}):",
                  style    => 'width:90px;',
                  name     => 'search_sizefrom' ).

           Input( type     => 'text',
                  label    => '&nbsp;&nbsp;-',
                  style    => 'width:90px;',
                  labelstyle => 'width: 20px',
                  float    => 'left',
                  name     => 'search_sizeto' ).

           Input( type     => 'submit',
                  style    => 'margin-top:15px;',
                  label    => $lang{start_search} );

  $html .= "</td></tr></table>" if $IG::screen_size eq 'large'; 
  $html .= FormFoot();
  return $html;
 }

############################################################################
############################################################################
sub findshow
 {
  my %validfolders;
  HtmlHead();
  if ($auth_user ne 'guest')
   {
    ## Translate folders name
    $validfolders{$_} = $folderinfo{$_}{name} for keys %folderinfo;
    $validfolders{everybody} = $lang{all_users};

    HLayer( bottom_space => 0,
            right_layers=>[(
		    FormHead (	name=>'findnavi',
				method=>'get',
				labelstyle=>"border:0px; width:auto; color:$IG::clr{font_menu_title}; background-color:$IG::clr{bg_menu_title}",
				autofocus=>'false',
				target=>'mainf',
				cgiaction=>'findexec',
				float=>'left' ),

		    Input (	type=>'findable' ),

		    Input (	name=>'folder',
				show=>$lang{folders},
				data=>\%validfolders,
				value=>'all',
				style=>'font-size:10px',
				allvalue=>'yes',
				type=>'select'),
		
		    Input (	type=>'select',
				name=>'fieldtofind',
                                style=>'font-size:10px',
				data=>[(['sender',	$lang{with_sender}],
				     	['receiver',	$lang{with_receiver}],
				     	['protocol',	$lang{with_protocol}],
					['date',	$lang{with_date}],
					['subject',	$lang{with_subject}],
					['body',	$lang{with_body}])]),
	
		    Input (	type=>'text',
				name=>'keytofind',
                                focus => 'true',
      				value=>$IG::cookie{lastsearch},
                                style=>'width:100px; margin-right:-5px;',
				onblur=>"document.cookie='lastsearch=' + escape(this.value)"),
	
		    Input (	type=>'image',
				name=>$lang{find},
				src=>"$IG::img_url/${IG::tema}search.gif",
				alt=>$lang{find}),
				
		    FormFoot())]
	 );
   }
  HtmlFoot();
 }

############################################################################
############################################################################
sub findexec
 {
  my $query;
  my $join = '';
  my $empty_query = 1;
  my $owner = $auth_user;
  my $window_title = 'IGWebMail'.
                     ( $on{extendedsearch}
                       ? " - $lang{extended_mail_search}"
                       : '');

  QuoteParams();

  if ( $on{ajax_request} ) 
   {
    HttpHead( expires => '+30s' );
   }
  else
   {
    HtmlHead( title => $window_title );

    TaskHead( width => '100%',
              title => $window_title );
   }

  if ( !$on{extendedsearch} )
   {
    $IG::set_cookie{lastsearch} = $on{keytofind};
    if ( length($on{keytofind}) < 2 )
     {
      TaskMsg($lang{Err_find});
      Footer();
      return;
     }
   }

  if ($on{extendedsearch} == 2)
   {
    ## we want only show extended search gui
    TaskMsg(extendedsearch(),2);
    Footer();
    return;
   }
  elsif ($on{extendedsearch})
   {
    ## this is an extended search. Shows the gui and builds the query... 
    TaskMsg(extendedsearch(),2) if    $IG::tema ne 'printable_'
                                   && !$on{ajax_request};

    ## adjusts and checks search key values
    for my $param ( qw( 
	search_sender
	search_receiver
	search_datefrom
	search_dateto
	search_subject
	search_body ) )
     {
      $on{$param} =~ s/^\s+|\s+$// if $on{$param}; ## trim spaces
      if ( $on{$param} )
       {
        if ( length($on{$param}) < 2 ) 
         {
          TaskMsg($lang{Err_find});
          Footer();
          return;
         }
        undef $empty_query;
       }
     }

    $owner = $in{search_owner} || $auth_user;
    $query .= "email_msgs.id <> ''";
    $query .= " and sender ~* '$in{search_sender}'"     if $in{search_sender};
    $query .= " and receiver ~* '$in{search_receiver}'" if $in{search_receiver};
    $query .= " and issue >= '$in{search_datefrom}'"    if $in{search_datefrom};
    $query .= " and issue <= '$in{search_dateto}'"      if $in{search_dateto};
    $query .= " and subject ~* '$in{search_subject}'"   if $in{search_subject};

    if ( $in{search_body} ) 
     {
      undef $empty_query;
      my $bodyquery = "body ~* '$in{search_body}'";
      if ( $owner ne $auth_user )
       {
	$bodyquery = 
	  $owner eq 'all'
	  ? "(email_msgs.owner='$auth_user' or email_msgs.sharemode=1)".
	    "and ($bodyquery)"
	  : "email_msgs.sharemode=1 and ($bodyquery)";
       }
      $query .= " and ($bodyquery)";
     }

    if ( $in{search_tag} ) 
     {
      $query .= " and email_tag.name = '$in{search_tag}'";
      $join   = "left join email_msgtags email_tag ".
                "on email_msgs.id=email_tag.msgid ";
     }

    if ( $in{contactid} ) 
     {
      undef $empty_query;
      $join = "left join contacts ". ## to match subcontact also
              "ON email_msgs.contactid = contacts.contactid ";
      $query .= " and (contacts.contactid = '$in{contactid}' ".
	              "or contacts.master = '$in{contactid}')";
     }

    if ( $in{search_sizefrom} )
     {
      undef $empty_query;
      $in{search_sizefrom} = IG::ParseByte( $in{search_sizefrom} );
      $query .= " and size >= $in{search_sizefrom}";
     }

    if ( $in{search_sizeto} )
     {
      undef $empty_query;
      $in{search_sizeto} = IG::ParseByte( $in{search_sizeto} );
      $query .= " and size <= $in{search_sizeto}";
     }

    $in{folder} = $in{search_folder} || 'all';

    $query .= " and status~*'r'"
              if $on{search_readstate} eq 'read';
    $query .= " and not (status~*'r')"
              if $on{search_readstate} eq 'unread';
    $query .= " and status~*'e'"
              if $on{search_repliedstate} eq 'replied';
    $query .= " and not (status~*'e')"
              if $on{search_repliedstate} eq 'unreplied';
    $query .= ' and email_msgs.sharemode = \''.($in{search_sharemode}-1).'\'' 
              if $in{search_sharemode};
    $query .= " and email_msgs.category = '$in{search_category}'" 
              if $in{search_category};

    if ( $empty_query ) 
     {
      push @IG::errmsg, $lang{Err_empty_query};
      Footer();
      return;
     }
   }
  elsif( $on{fieldtofind} eq 'tag' )
   { 
    $join = "left join email_msgtags on email_msgs.id = email_msgtags.msgid ";
    $query = "email_msgtags.name='$in{keytofind}'";
    $in{folder} = $on{onwer} eq 'all' ? 'everybody' : 'all';
   }
  elsif ($on{fieldtofind} eq 'sender')
   { $query = "sender~*'$in{keytofind}'"; }
  elsif ($on{fieldtofind} eq 'receiver')
   { $query = "receiver~*'$in{keytofind}'"; }
  elsif ($on{fieldtofind} eq 'date')
   { $query = "issue='". CkDate($in{keytofind}) ."'"; }
  elsif ($on{fieldtofind} eq 'body')
   { 
    my $keytofind = DbQuote( MkEntities( $on{keytofind} ) );
    $query = "body~*'$keytofind'";
    $query = "(email_msgs.owner='$auth_user' or email_msgs.sharemode=1) ".
             "and ($query)" if $in{folder} eq 'everybody';
   }
  elsif ($on{fieldtofind} eq 'subject')
   { $query = "subject~*'$in{keytofind}'";}
  elsif ($on{fieldtofind} eq 'protocol')
   { 
    $query = "pid~*'$in{keytofind}'"; 
    $in{folder} = 'everybody'; ## for PID search always in everybody folders
   }

  $query = "folder='$in{folder}' and ($query)" 
           if !($in{folder} =~ /^(all|everybody)$/);

  $query = "select email_msgs.id, issue, timeissue, sender,".
           " email_msgs.contactid, receiver,".
	   " email_msgs.owner, subject, folder, content, email_msgs.status, size,".
	   " pid, email_msgs.sharemode, email_msgtags.name, users.initial,".
	   " (select count(*) from comments".
	   "  where referenceproc='webmail' and ".
	   ($IG::db_driver eq 'mysql'
	    ? "referenceid=concat(email_msgs.owner,'_',email_msgs.id)"
	    : "referenceid=(email_msgs.owner || '_' || email_msgs.id)").
	   " ) ".
	   "from email_msgs ".
           "$join ".
           "left join email_msgtags on email_msgs.id = email_msgtags.msgid ".
           "left join users on email_msgs.owner = users.login ".
           "where ".
           ($owner eq $auth_user 
	    ? "(email_msgs.owner='$owner'".($in{folder} eq 'everybody' 
	                                    ? " or email_msgs.sharemode<>2)" 
	                                    : ")")
            : $owner eq 'all'
	      ? "(email_msgs.owner='$auth_user' or email_msgs.sharemode<>2)"
	      : "(email_msgs.owner='$owner' and email_msgs.sharemode<>2)"
           ).
           " and ($query) ".
	   "order by issue desc, timeissue desc"; #XXX2DEVELOPE user should choose a view order

  my $base_url = "webmail?order=$on{order}&amp;folder=$escapedfolder";

  if ($owner eq $auth_user || $owner eq 'all')
   {
    ## we can allow messageaction() only when we are messages's owner
    FormHead( name      => 'moveform',
              enctype   => 'multipart/form-data',
              cgiaction => 'messageaction' );

    _set_hiddens();

    Input( type      => 'hidden',
           name      => 'backto',
           value     => $IG::query_string,
           override  => 1 );

    $folder = '//nofolder//'; ##XXX2TEST
    HLayer( left_layers  => $on{extendedsearch}
                         ?  ''
                         :  [( Input( label     => $lang{find},
                                      type      => 'label',
                                      data      => $on{keytofind} ) )],
            right_layers => [( Input( name      => 'actiontarget',
                                      data      => _get_action_items(),
                                      float     => 'right',
                                      onchange  => 'submit();',
                                      style     => 'width:200px; font-size:10px;',
                                      zerovalue => 'true',
                                      value     => '',
                                      override  => 1,
                                      type      => 'select'),

                               Img( src   => "$IG::img_url/arrow_link.gif",
                                    width => 13,
                                    height=> 18,
                                    style => "float:right; ".
                                             "position:relative; ".
                                             "top:8px; ".
                                             "margin:0px 3px -1px 0;")
                             )] ) unless $on{ajax_request};
   }

  TaskListMenu
       (
	[],
	[$lang{date}],
	[$lang{sender}],
	[$lang{receiver}],
	[$lang{subject}],
	[$lang{size}],
	['Tag'],
        [$lang{folder}],
        [Img( src   => "$IG::img_url/user.gif",
              width => 16 )],
 	[ ($owner eq $auth_user || $owner eq 'all') && !$on{ajax_request}
	  ? Input( name      => 'allbox',
	           type      => 'checkbox',
	           fieldstyle=> 'margin:0;padding:0;',
	           override  => 1,
	           onclick   => 'CheckAll();')
          : '',
          '','width=15'] #IE_HACK
       );

  my $messnum = 0;
  DbQuery($query);
  while (my @row = IG::FetchGroupedRows
                      ( group_by_indexes  => 0,  ## group by id
			to_concat_indexes => 14  ## concat tags
		      )
        )
   {
    next if !$row[0];
    my %header;
    $header{message_id}		 = $row[0];
    $header{date}		 = $row[1];
    $header{time}		 = substr($row[2],0,5);
    $header{from}		 = $row[3];
    $header{contactid}		 = $row[4];
    $header{to}			 = $row[5];
    $header{owner}		 = $row[6];
    $header{subject}		 = $row[7];
    $header{folder}	       	 = $row[8];
    $header{contenttype}	 = $row[9];
    $header{status}		 = $row[10];
    $header{messagesize}	 = $row[11];
    $header{sharemode}           = $row[13];
    $header{tag}                 = $row[14];
    $header{initial}             = $row[15];

    my $boldon;	 	# Used to control whether text is bold for new mails
    my $messagelink;  	# will hold the href to each message

    my $bgcolor = $messnum++ % 2 ? $IG::clr{bg_link} : $IG::clr{bg_list}; 
    $header{subject} = MkEntities($header{subject});

    ## Looking for an e-mail address
    my $from = MkEntities( (IG::WebMail::ParseAddress($header{from}))[0] );
    my $to   = MkEntities( (IG::WebMail::ParseAddress($header{to}))[0] );

    $header{subject} ||= "N/A";
    my $escapedmessageid = MkUrl($header{message_id});

    my $message_size = IG::MkByte($header{messagesize});

    my $status = "<strong>$messnum</strong> ".
         ( $header{sharemode} == 1 
	   ? Img( src   => "$IG::img_url/group_green.gif", 
                  align => 'absmiddle',
                  width => 16,
	          title => $lang{share_mode1} ) 
	   : $header{sharemode} == 2 
	     ? Img( src   => "$IG::img_url/group_red.gif", 
                    align => 'absmiddle',
                    width => 16,
	            title => $lang{share_mode2} ) 
	     : ''
	 );

    ## Choose status icons based on Status: line and type of encoding
    if ( $header{status} =~ /e/i )
     {
      $boldon = '';
      $status .= Img( src   => "$IG::img_url/replied.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{replied} );
     }
    elsif ( $header{status} =~ /r/i )
     {
      $boldon = '';
     }
    else
     {
      $status .= Img( src   => "$IG::img_url/unreadmsg.gif",
                      width => 16,
                      title => $lang{unread_messages} );
      $boldon = "font-weight: bold;";
     }

    if ( $header{status} =~ /n/i )
     {
      ## It's a received message
      $status .= Img( src   => "$IG::img_url/email_receipt.png",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{message_notified} );
      $boldon = '';
     }

    if ( $header{contenttype} ne 'N/A' &&
	 $header{contenttype} !~ /^text/i
       )
     {
      $status .= Img( src   => "$IG::img_url/attach.gif",
                      width => 16,
                      title => $lang{attachment} );
     }
       
    if ( $header{sharemode} == 1 || $header{owner} eq $auth_user )
     {
      $status .= Img( src   => "$IG::img_url/comment_edit.gif",
                      width => 16,
                      align => 'absmiddle',
                      title => $lang{comments} )
		 if $row[16] > 0;

      $messagelink = "webmail?".
			"action=readmessage&amp;".
			"pos=$on{pos}&amp;".
			"status=$header{status}&amp;".
			"folder=$escapedfolder&amp;".
			"order=$on{order}&amp;".
			"headers=simple&amp;".
			"views=$on{views}&amp;".
                        "owner=$header{owner}&amp;".
		        "tags=$on{tags}&amp;".
			"message_id=$escapedmessageid";
     }

    TaskListItem (
	[$status,
	 "",
	 "nowrap style=\"background-color: $bgcolor\""],
	["$header{date} $header{time}",
	 "",
	 "nowrap style=\"background-color: $bgcolor;$boldon\""],
	[$from,
	 $messagelink,
	 "style=\"background-color: $bgcolor;$boldon\""],
	[$to,
	 $messagelink,
	 "style=\"background-color: $bgcolor;$boldon\""],
	[$header{subject},
	 $messagelink,
	 "style=\"background-color: $bgcolor;$boldon\""],
	[$message_size,
	 "",
	 "style=\"background-color: $bgcolor;$boldon\""],
        [$header{tag},
	    "",
	    "style=\"background-color: $bgcolor;$boldon\""],
        [$lang{$header{folder}} || $header{folder},
	    "",
	    "style=\"background-color: $bgcolor;$boldon\""],
	[$header{initial}, 
	    "",
	    "style=\"background-color: $bgcolor;$boldon\""],
	[$header{owner} eq $IG::auth_user && !$on{ajax_request}
	 ? Input( type=>'checkbox',
	          fieldstyle=>'margin:0;padding:0;',
	          name=>'message_ids',
	          value=>$header{message_id} )
	 : '&nbsp;',
	 '',"style=\"background-color: $bgcolor\""]
    );
   }

  push @IG::errmsg, $lang{no_items} if !$messnum;

  ## a strange TaskListFoot
  for ($IG::task_list_rows .. ($on{extendedsearch} ? 3 : $IG::page_results))
   {
    my $bgcolor = $_ % 2 ? $IG::clr{bg_link} : $IG::clr{bg_list}; 
    TaskListItem((["&nbsp;","","style=\"background-color:$bgcolor\""]) x 10);
   }
  TaskListFoot($on{extendedsearch} ? 3 : 0);
  FormFoot();

  PrOut <<END;
  <script language="JavaScript">
   <!--
   function CheckAll()
   {
      for (var i=0;i<document.moveform.elements.length;i++)
      {
         var e = document.moveform.elements[i];
         if (e.name == "message_ids")
            e.checked = document.moveform.allbox.checked;
      }
   }
   //-->
  </script>
END

  if($on{ajax_request})
   {
    HtmlFoot();
   }
  else
   {
    Footer();
   }
 }


################################################################################
################################################################################
sub checkfolders
 {
  IG::WebMail::CheckFolders();
  %folderinfo    = %IG::WebMail::folderinfo;
  $folder 	 = $IG::WebMail::folder;
  $escapedfolder = $IG::WebMail::escapedfolder;
 }

############################################################################
############################################################################
sub _short_cuts_common
 {
  return IG::QuickCreator().
         TaskHead( title=>$lang{last_documents},
                   icon=>2,
                   width=>180 ).
         IG::LastDocuments().
         TaskFoot();
 }

############################################################################
############################################################################
sub _short_cuts
 {
  my %dejavu;
  my $html = IG::QuickCreator().
             TaskHead( title=>$lang{folders},
                       icon=>2,
                       width=>180 );

  $html .= "<div style=\"line-height:2em; white-space:nowrap;".
           " margin:10px 0px 10px 3px; font-size:10px;\">\n";

  ## Translate folders name
  for ( qw( INBOX SENT DRAFTS PROTOCOLS TRASH),
	sort { $folderinfo{$a}{name} cmp $folderinfo{$b}{name} }
	keys %folderinfo )
   {
    next if $dejavu{$_}++;
    $folderinfo{$_}{unread} ||= '0';
    $folderinfo{$_}{msgs}   ||= '0';
    $html .= Img(src   => "$IG::img_url/".
		 	  (  $_ eq 'INBOX'  ? 'inbox.gif'
			   : $_ eq 'SENT'   ? 'outbox.gif'
			   : $_ eq 'DRAFTS' ? 'edit.gif'
			   : $_ eq 'TRASH'  ? 'minitrash.gif'
			   : $_ eq 'PROTOCOLS'  ? 'mini_folder_green.gif'
			   : $_ eq $folder  ? 'mime_mini_folderopen.png'
			   : 'mime_mini_folder.png'),
                 width => 16,
                 height => 16,
		 align => 'absmidlle');

    $html .=" <a href=\"webmail?".
			"action=displayheaders&amp;".
			"order=$on{order}&amp;".
			"folder=".
	    MkUrl($_) . '" style="' .

	    ( $_ ne 'TRASH' && $folderinfo{$_}{unread}
	      ? "font-weight:bolder;"
	      : '' ).

	    ( $_ eq 'TRASH' && $folderinfo{$_}{msgs} > 5000
	      ? "color:#ff3300;"
	      : '').

            '">'.

	    $folderinfo{$_}{name}.
	    ( $_ eq 'PROTOCOLS'
	      ? '</a><br>'
	      : " ($folderinfo{$_}{unread}/$folderinfo{$_}{msgs})</a><br>" );
   }

  $html .= "</div>". TaskFoot();
  return $html;
 }

##############################################################################
##############################################################################
sub Footer
 {
  TaskFoot();
  HtmlFoot();
 }

##############################################################################
##############################################################################
sub help
 {
  PrOut <<END;

IGWebMail - An IGSuite application

Usage: webmail [options]
 -to <address>
 -action <ig action>
 -auth_user <user>
 -subject <email subject>
 -body <email body>
 -pop3login <login>
 -pop3pwd <pwd>
 -pop3host <hostname>
 -pop3port <port>
 -pop3auth <authentication mode>
 -pop3debug <debug mode>
 -smtphost <host name>
 -smtpport <port>
 -smtpdebug <debug mode>

END
 }

##############################################################################
##############################################################################
## Don't delete row above, it's needed by langtool
## $lang{INBOX} $lang{TRASH} $lang{SENT}
## $lang{SAVED} $lang{DRAFTS} $lang{PROTOCOLS}
## $lang{copy} $lang{all_messages} $lang{download}
## $lang{mark_as_read} $lang{mark_as_replied}
## $lang{mark_as_unread} $lang{mark_as_unreplied}
## $lang{moveconfirm} $lang{shouldnt_move_here}
## $lang{html_version} $lang{text_version}
## $lang{att_overlimit} $lang{any_message_to_import}
##
## TODO
##
## Cliccando su vista per thread fare in modo che apre il primo messaggio non
## letto
##
## PossibilitÃ  con JS di chiudere il div del thread
##
